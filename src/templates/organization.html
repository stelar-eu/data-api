<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>STELAR | {{ organization.title }}</title>
    <!-- CSS files -->
    {% include 'tabler.html' %}
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="{{ url_for('static', filename='images.js') }}"></script>
    <script src="{{ url_for('static', filename='utils.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='stelar.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png">
</head>

<body>
    <div class="page">
        <!-- Navbar -->
        {% include 'header.html' %}
        <div class="page-wrapper">
            <!-- Page header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <!-- Page pre-title -->
                            <div class="page-pretitle">
                                Organization Overview
                            </div>
                            <h3 class="page-title">
                                <ol class="breadcrumb breadcrumb-arrows">
                                    <li class="breadcrumb-item"><a class="text-secondary"
                                            href="{{ url_for('dashboard_blueprint.organizations') }}">Organizations
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item active"><a href="#"><span class="text-strong">{{
                                                organization.title }}</span></a></li>
                                </ol>
                            </h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page-body">
                <div class="container-xl">
                    <div class="row row-cards">
                        <div class="col-lg-7">
                            <div class="card mb-2">
                                <div class="row g-0">
                                    <div class="col-auto">
                                        <div class="card-body">
                                            <div class="avatar avatar-xl bg-white">
                                                {% if organization.image_url and organization.image_url != '' %}
                                                <img src="{{organization.image_url}}" />
                                                {% else %}
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                    class="text-secondary icon icon-tabler icons-tabler-outline icon-tabler-building-bank">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                    <path d="M3 21l18 0" />
                                                    <path d="M3 10l18 0" />
                                                    <path d="M5 6l7 -3l7 3" />
                                                    <path d="M4 10l0 11" />
                                                    <path d="M20 10l0 11" />
                                                    <path d="M8 14l0 3" />
                                                    <path d="M12 14l0 3" />
                                                    <path d="M16 14l0 3" />
                                                </svg>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="card-body ps-0">
                                            <div class="row">
                                                <div class="col">
                                                    <p class="text-secondary mt-1">{{ organization.get('description',
                                                        'No
                                                        description specified') }}
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md">
                                                    <div
                                                        class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                                                        <div class="list-inline-item">
                                                            <!-- Download SVG icon from http://tabler.io/icons/icon/building-community -->
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                                height="24" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2"
                                                                stroke-linecap="round" stroke-linejoin="round"
                                                                class="icon icon-tabler icons-tabler-outline icon-tabler-file-database">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                                <path
                                                                    d="M12 12.75m-4 0a4 1.75 0 1 0 8 0a4 1.75 0 1 0 -8 0" />
                                                                <path
                                                                    d="M8 12.5v3.75c0 .966 1.79 1.75 4 1.75s4 -.784 4 -1.75v-3.75" />
                                                                <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                                                <path
                                                                    d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                                                            </svg>
                                                            <span class="text-secondary placeholder placeholder-glow"
                                                                id="org-dataset-count">
                                                                0 Datasets
                                                            </span>
                                                        </div>
                                                        <div class="list-inline-item">
                                                            <!-- Download SVG icon from http://tabler.io/icons/icon/license -->
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon"
                                                                width="24" height="24" viewBox="0 0 24 24"
                                                                stroke-width="2" stroke="currentColor" fill="none"
                                                                stroke-linecap="round" stroke-linejoin="round">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                                <path d="M12 3l8 4.5v9l-8 4.5l-8 -4.5v-9l8 -4.5" />
                                                                <path d="M12 12l8 -4.5" />
                                                                <path d="M12 12l0 9" />
                                                                <path d="M12 12l-8 -4.5" />
                                                            </svg>
                                                            <span class="text-secondary placeholder placeholder-glow"
                                                                id="org-process-count">
                                                                0 Processes
                                                            </span>
                                                        </div>
                                                        <div class="list-inline-item">
                                                            <!-- Download SVG icon from http://tabler.io/icons/icon/license -->
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                                height="24" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2"
                                                                stroke-linecap="round" stroke-linejoin="round"
                                                                class="icon icon-tabler icons-tabler-outline icon-tabler-file-database">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                                <path d="M10 13a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                                                <path d="M8 21v-1a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v1" />
                                                                <path d="M15 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                                                <path d="M17 10h2a2 2 0 0 1 2 2v1" />
                                                                <path d="M5 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                                                <path d="M3 13v-1a2 2 0 0 1 2 -2h2" />
                                                            </svg>
                                                            <span class="text-secondary placeholder placeholder-glow"
                                                                id="org-user-count">
                                                                0 Members
                                                            </span>
                                                        </div>

                                                    </div>
                                                    <div class="mt-3 list mb-0 text-secondary d-block d-sm-none">
                                                        <div class="list-item">
                                                            <!-- Download SVG icon from http://tabler.io/icons/icon/building-community -->
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                                height="24" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2"
                                                                stroke-linecap="round" stroke-linejoin="round"
                                                                class="icon icon-tabler icons-tabler-outline icon-tabler-file-database">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                                <path
                                                                    d="M12 12.75m-4 0a4 1.75 0 1 0 8 0a4 1.75 0 1 0 -8 0" />
                                                                <path
                                                                    d="M8 12.5v3.75c0 .966 1.79 1.75 4 1.75s4 -.784 4 -1.75v-3.75" />
                                                                <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                                                <path
                                                                    d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                                                            </svg>
                                                            0 Datasets
                                                        </div>
                                                        <div class="list-item">
                                                            <!-- Download SVG icon from http://tabler.io/icons/icon/license -->
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                                height="24" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2"
                                                                stroke-linecap="round" stroke-linejoin="round"
                                                                class="icon icon-tabler icons-tabler-outline icon-tabler-file-database">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                                <path d="M10 13a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                                                <path d="M8 21v-1a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v1" />
                                                                <path d="M15 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                                                <path d="M17 10h2a2 2 0 0 1 2 2v1" />
                                                                <path d="M5 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                                                <path d="M3 13v-1a2 2 0 0 1 2 -2h2" />
                                                            </svg>
                                                            1 Members
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="icon icon-tabler icons-tabler-outline icon-tabler-file-database">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path d="M12 12.75m-4 0a4 1.75 0 1 0 8 0a4 1.75 0 1 0 -8 0" />
                                        <path d="M8 12.5v3.75c0 .966 1.79 1.75 4 1.75s4 -.784 4 -1.75v-3.75" />
                                        <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                        <path
                                            d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="m-0">Most Recent Datasets</h3>
                                    <small class="text-secondary">Datasets, that have
                                        been recently published or
                                        modified</small>
                                </div>
                                <div class="ms-auto">
                                    <a href="{{ url_for('dashboard_blueprint.catalog' )}}?org={{organization.name}}"
                                        class="btn btn-sm py-1 btn-pill btn-outline-primary text-wrap"
                                        target="_blank">Browse
                                        all datasets
                                        of
                                        {{organization.title}}</a>
                                </div>
                            </div>

                            <div class="row row-deck row-cards" id="org-recent-datasets">
                                {% for i in range(0,4) %}
                                <div class="col-lg-6 col-sm-6">
                                    <a class="card placeholder-glow">
                                        <div class="card-body">
                                            <div>
                                                <h3 class="m-0 placeholder col-9"></h3>
                                                <small class="placeholder col-4 mt-1"></small>
                                                <div class="d-flex mt-4">

                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>

                        </div>
                        <div class="col-lg-5">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3">
                                            <!-- Download SVG icon from http://tabler.io/icons/icon/scale -->
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                                                <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="m-0">Members</h3>
                                            <small class="text-secondary">People with access to organization
                                                resources</small>
                                        </div>
                                        {% if admin %}
                                        <div class="ms-auto">
                                            <a class="cursor-pointer" data-bs-toggle="modal"
                                                data-bs-target="#org-users-modal">
                                                Manage Members
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="avatar-list me-3 mb-3" id="org-recent-users">
                                        {% for i in range(0,10) %}
                                        <span class="avatar avatar-sm placeholder placeholder-glow">
                                            <span class="placeholder col-6"></span>
                                        </span>
                                        {% endfor %}
                                    </div>
                                    <hr>
                                    <!-- <div class="d-flex align-items-center mb-3">
                                        <div class="me-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                class="icon icon-tabler icons-tabler-outline icon-tabler-users-group">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                <path d="M10 13a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                                <path d="M8 21v-1a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v1" />
                                                <path d="M15 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                                <path d="M17 10h2a2 2 0 0 1 2 2v1" />
                                                <path d="M5 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                                <path d="M3 13v-1a2 2 0 0 1 2 -2h2" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="m-0">Groups</h3>
                                            <small class="text-secondary">Collections of entities within the
                                                organization</small>
                                        </div>
                                    </div> 
                                    <hr>-->
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                <path d="M12 3l8 4.5v9l-8 4.5l-8 -4.5v-9l8 -4.5" />
                                                <path d="M12 12l8 -4.5" />
                                                <path d="M12 12l0 9" />
                                                <path d="M12 12l-8 -4.5" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="m-0">Processes</h3>
                                            <small class="text-secondary">Workflow Processes executed within the
                                                organization</small>
                                        </div>

                                        <div class="ms-auto">
                                            <a class="cursor-pointer text-link"
                                                href="{{ url_for('dashboard_blueprint.processes') }}?q={{ organization.title | urlencode }}"
                                                target="_blank">
                                                Browse Processes
                                            </a>
                                        </div>


                                    </div>
                                    <div class="row row-cards" id="org-processes">
                                        {% for i in range(0,4) %}
                                        <div class="col-sm-6 col-lg-6">
                                            <a class="card placeholder-glow">
                                                <div class="card-body">
                                                    <div>
                                                        <h3 class="m-0 placeholder col-9"></h3>
                                                        <small class="placeholder col-4 mt-1"></small>
                                                        <div class="d-flex mt-4">
                                                            <span class="placeholder col-6"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <hr>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                class="icon icon-tabler icons-tabler-outline icon-tabler-tool">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                <path
                                                    d="M7 10h3v-3l-3.5 -3.5a6 6 0 0 1 8 8l6 6a2 2 0 0 1 -3 3l-6 -6a6 6 0 0 1 -8 -8l3.5 3.5" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="m-0">Tools</h3>
                                            <small class="text-secondary">STELAR tools belonging to the
                                                organization</small>
                                        </div>
                                    </div>
                                    <div class="row row-cards" id="org-tools">
                                        {% for i in range(0,4) %}
                                        <div class="col-sm-6 col-lg-6">
                                            <a class="card placeholder-glow">
                                                <div class="card-body">
                                                    <div>
                                                        <h3 class="m-0 placeholder col-9"></h3>
                                                        <small class="placeholder col-4 mt-1"></small>
                                                        <div class="d-flex mt-4">
                                                            <span class="placeholder col-6"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                        {% endfor %}
                                    </div>

                                </div>
                                <div class="card-footer">
                                    Learn more about organizations in the <a href="#">documentation</a>.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if admin %}
            <div class="modal modal-blur fade" id="org-users-modal" tabindex="-1" style="display: none;"
                aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header border-0">
                            <h5 class="modal-title">Organization Members</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0">
                            <table class="table table-bordered m-0">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Capacity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="org-users-list">
                                    <tr id="new-org-member">
                                        <td colspan="4" class="text-center p-2">
                                            <a class="text-green cursor-pointer" onclick="addUserField()"
                                                title="Add New User">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                    class="icon icon-tabler icons-tabler-outline icon-tabler-circle-dashed-plus">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                    <path d="M8.56 3.69a9 9 0 0 0 -2.92 1.95" />
                                                    <path d="M3.69 8.56a9 9 0 0 0 -.69 3.44" />
                                                    <path d="M3.69 15.44a9 9 0 0 0 1.95 2.92" />
                                                    <path d="M8.56 20.31a9 9 0 0 0 3.44 .69" />
                                                    <path d="M15.44 20.31a9 9 0 0 0 2.92 -1.95" />
                                                    <path d="M20.31 15.44a9 9 0 0 0 .69 -3.44" />
                                                    <path d="M20.31 8.56a9 9 0 0 0 -1.95 -2.92" />
                                                    <path d="M15.44 3.69a9 9 0 0 0 -3.44 -.69" />
                                                    <path d="M9 12h6" />
                                                    <path d="M12 9v6" />
                                                </svg>
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer border-0" id="org-users-footer">
                            <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}




        </div>
        {% include 'footer.html'%}
    </div>
    <script>

        function renderDatasetCard(dataset) {
            return `
            <div class="col-sm-6 col-lg-6">
                <a class="card card-link" href="{{url_for('dashboard_blueprint.dataset_detail', dataset_id='')}}${dataset.id}" target="_blank">
                    <div class="card-body">
                        <div>
                            <h5 class="m-0">${dataset.title}</h5>
                            <div class="d-flex">
                                <small class="text-secondary">${dataset.author}</small>
                                <div class="ms-auto d-flex justify-content-end flex-wrap mt-4 badges h5">
                                    ${dataset.tags && dataset.tags.length ? 
                                        (dataset.tags.length > 3 ? 
                                            dataset.tags.slice(0, 3).map(tag => `<span class="tag m-1 mb-0">${tag}</span>`).join('') + 
                                            `<p class="text-secondary m-1 mb-0" title="${dataset.tags.slice(3).join(', ')}">+${dataset.tags.length - 3} more...</p>` 
                                            : 
                                            dataset.tags.map(tag => `<span class="tag m-1 mb-0">${tag}</span>`).join(''))
                                        : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>`;
        }

        function fetchOrganizationDatasets() {

            q = {
                "fl": [
                    "id",
                    "name",
                    "title",
                    "organization",
                    "author",
                    "tags",
                    "metadata_modified",
                ],
                "limit": 4,
                "sort": "metadata_modified desc",
                "fq": [
                    "owner_org:{{ organization.id }}",
                ],
                "facet": {
                    "fields": []
                }
            }

            org_name = "{{ organization.name }}";

            $.ajax({
                url: "{{url_for('catalog_blueprint.api_search_datasets')}}",
                type: "POST",
                data: JSON.stringify(q),
                contentType: "application/json",
                success: function (response) {
                    if (response.success) {
                        $('#org-recent-datasets').empty();

                        if (response.result.count > 0) {
                            $('#org-dataset-count').removeClass('placeholder placeholder-glow');
                            $('#org-dataset-count').text(response.result.count + (response.result.count === 1 ? ' Dataset' : ' Datasets'));
                            const datasets = response.result.results;
                            datasets.forEach(function (dataset) {
                                if (dataset.organization != org_name) {
                                    return;
                                }
                                $('#org-recent-datasets').append(renderDatasetCard(dataset));

                            });
                        } else {
                            $('#org-dataset-count').removeClass('placeholder placeholder-glow');
                            $('#org-dataset-count').text('0 Datasets');
                            $('#org-recent-datasets').append(`<p class="text-secondary">No recent datasets found for this organization</p>`);
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                }
            });


        }

        function fetchOrganizationProcesses() {
            pq = {
                "fl": [
                    "name",
                    "title",
                    "metadata_created",
                    "organization",
                    "author",
                    "tags",
                    "id"
                ],
                "limit": 4,
                "sort": "metadata_modified desc",
                "fq": [
                    "owner_org:{{ organization.id }}",
                ],
                "facet": {
                    "fields": []
                }
            }

            $.ajax({
                url: "{{url_for('rest_workflows_blueprint.api_search_processes')}}",
                type: "POST",
                data: JSON.stringify(pq),
                contentType: "application/json",
                success: function (response) {
                    if (response.success) {
                        if (response.result.count > 0) {
                            $('#org-processes').empty();
                            response.result.results.forEach(function (process) {
                                if (process.organization != "{{ organization.name }}") {
                                    return;
                                }
                                $('#org-process-count').removeClass('placeholder placeholder-glow');
                                $('#org-process-count').text(response.result.count + (response.result.count === 1 ? ' Process' : ' Processes'));
                                $('#org-processes').append(`
                                    <div class="col-sm-6 col-lg-6">
                                        <a class="card card-link" href="{{url_for('dashboard_blueprint.process', process_id='')}}${process.id}" target="_blank">
                                            <div class="card-body">
                                                <div>
                                                    <h4 class="m-0">${process.title}</h4>
                                                    <div class="d-flex">
                                                        <small class="text-secondary">${process.author}</small>
                                                        <div class="ms-auto mt-3 badges">
                                                            ${process.tags && process.tags.length ? 
                                                                (process.tags.length > 3 ? 
                                                                    process.tags.slice(0, 3).map(tag => `<span class="tag m-1 mb-0">${tag}</span>`).join('') + 
                                                                    `<p class="m-1 mb-0 text-secondary" title="${process.tags.slice(3).join(', ')}">+ ${process.tags.length - 3} more...</p>` 
                                                                    : 
                                                                    process.tags.map(tag => `<span class="tag m-1 mb-0">${tag}</span>`).join('')) 
                                                                : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                `);
                            });
                        } else {
                            $('#org-process-count').removeClass('placeholder placeholder-glow');
                            $('#org-process-count').text('0 Processes');
                            $('#org-processes').html('<p class="text-secondary">No recent processes found for this organization</p>');
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                }
            });
        }

        function fetchOrganizationTools() {
            tq = {
                "fl": [],
                "fq": [
                    "owner_org:{{ organization.id }}",
                ],
                "facet": {
                    "fields": []
                }
            }

            $.ajax({
                url: "{{url_for('rest_workflows_blueprint.api_search_tools')}}",
                type: "POST",
                data: JSON.stringify(tq),
                contentType: "application/json",
                success: function (response) {
                    if (response.success) {
                        if (response.result.count > 0) {
                            $('#org-tools').empty();
                            response.result.results.forEach(function (tool) {
                                let toolImage;
                                const categoryExtra = tool.extras.find(extra => extra.key === 'category');
                                const category = categoryExtra ? categoryExtra.value.replace(/"/g, '') : null;

                                if (category === 'discovery') {
                                    toolImage = "{{ url_for('static', filename='logos/tools/discovery.png') }}";
                                } else if (category === 'annotation') {
                                    toolImage = "{{ url_for('static', filename='logos/tools/annotation.png') }}";
                                } else if (category === 'interlinking') {
                                    toolImage = "{{ url_for('static', filename='logos/tools/linking.png') }}";
                                } else {
                                    const initials = tool.title.split('-').map(word => word[0].toUpperCase()).join('');
                                    toolImage = `<div class="avatar avatar-sm rounded mt-1">${initials}</div>`;
                                }

                                $('#org-tools').append(`
                                <div class="col-sm-6 col-lg-6">
                                <a class="card card-link" href="{{url_for('dashboard_blueprint.tool', tool_id='')}}${tool.id}" target="_blank">
                                    <div class="card-body d-flex">
                                    ${toolImage.startsWith('<div') ? toolImage : `<img src="${toolImage}" alt="${tool.title}" class="avatar avatar-sm mt-1">`}
                                    <div class="me-auto ms-2 mt-0 text-truncate align-items-center">
                                        <div class="ms-2">
                                            <h4 class="m-0 text-truncate" title=${tool.title}>${tool.title}</h4>
                                            <div class="d-flex">
                                                <small class="text-secondary">${tool.author}</small>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </a>
                                </div>
                            `);
                            });
                        } else {
                            $('#org-tools').html('<p class="text-secondary">No tools found for this organization</p>');
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                }
            });
        }


        systemUsers = [];
        organizationUsers = [];

        function fetchOrganizationUsers(usersRep) {
            $.ajax({
                url: "{{url_for('catalog_blueprint.api_list_user_members_of_organization', entity_id=organization.id)}}",
                type: "GET",
                success: function (response) {
                    if (response.success) {
                        count = response.result.length;
                        $('#org-user-count').removeClass('placeholder placeholder-glow');
                        $('#org-user-count').text(count + (count === 1 ? ' Member' : ' Members'));

                        if (count > 0) {
                            $('#org-recent-users').empty();
                            $('#org-users-list').find('tr:not(#new-org-member)').remove();
                            organizationUsers = response.result.map(user => user[0]);

                            // Populate organization users
                            response.result.forEach(function (user) {
                                var userId = user[0];
                                var userDetails = usersRep.find(u => u.id === userId);
                                var userName = userDetails ? userDetails.fullname : 'Unknown';
                                var userInitials = userName.split(' ').map(n => n[0].toUpperCase()).join('');
                                $('#org-recent-users').append(`
                                    <span class="avatar avatar-sm rounded" title="${userName}">
                                        ${userInitials}
                                    </span>
                                `);
                                var userRole = user[2] || 'Member';
                                $("#org-users-list").prepend(`
                                    <tr id="user-${userId}">
                                        <td>${userDetails.username}</td>
                                        <td>${userName}</td>
                                        <td>${userRole}</td>
                                        <td>
                                            ${userDetails.username !== 'admin' ? `
                                                <a class="text-link me-2 cursor-pointer" onclick="editUserMembership('${userId}')">Edit</a>
                                                <a class="text-link text-danger cursor-pointer" onclick="removeUserFromOrg('${userId}')">Remove</a>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `);
                            });

                            // Populate system users not in the organization
                            systemUsers = usersRep.filter(user => !organizationUsers.includes(user.id));
                        } else {
                            $('#org-recent-users').html('<p class="text-secondary">No members found in this organization</p>');
                        }
                    } else {
                        $('#org-user-count').text('0 Members');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                    $('#org-user-count').text('0 Members');
                }
            })
        }

        function fetchSystemUsers(callback) {
            $.ajax({
                url: "{{url_for('users_blueprint.api_list_users')}}",
                type: "GET",
                success: function (response) {
                    if (response.success) {
                        if (callback && typeof callback === 'function') {
                            callback(response.result);
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                }
            })
        }

        $(document).ready(function () {
            fetchOrganizationDatasets();
            fetchOrganizationProcesses();
            fetchOrganizationTools();
            fetchSystemUsers(function (usersRep) {
                fetchOrganizationUsers(usersRep);
            });
        });
    </script>
    <script>
        function buildNormalUserRow(fullname, username, userId, capacity) {
            return `<tr id="user-${userId}">
                        <td>${username}</td>
                        <td>${fullname}</td>
                        <td>${capacity}</td>
                        <td>
                            ${username !== 'admin' ? `
                                <a class="text-link me-2 cursor-pointer" onclick="editUserMembership('${userId}')">Edit</a>
                                <a class="text-link text-danger cursor-pointer" onclick="removeUserFromOrg('${userId}')">Remove</a>
                            ` : ''}
                        </td>
                    </tr>`;
        }

        function buildUserEditRow(fullname, username, userId, capacity) {
            return `
                <tr id="user-row-edit">
                <td> ${username}</td>
                <td> ${fullname}</td>
                <td>
                    <select id="select-capacity" placeholder="Select a capacity..." autocomplete="off">
                            <option value="">Select a capacity...</option>
                            <option value="reader">Reader</option>
                            <option value="editor">Editor</option>
                            <option value="reviewer">Reviewer</option>
                            <option value="Admin">Admin</option>
                    </select>                
                    <input type="hidden" name="user-original-capacity" value="${capacity}">
                    <input type="hidden" name="user-original-id" value="${userId}">
                </td>
                <td>
                    <a class="text-link cursor-pointer" onclick="saveMember()">Save</a>
                    <a class="text-danger cursor-pointer ms-2" onclick="cancelEditUser()">Cancel</a>
                </td>
                </tr>`;
        }

        function buildAddUserRow() {
            return `
                <tr id="user-row-new">
                    <td colspan="2">
                        <select id="select-user" placeholder="Select a user..." autocomplete="off">
                            <option value="">Select a user...</option>
                        </select>
                    </td>
                    <td>
                        <select id="select-capacity" placeholder="Select a capacity..." autocomplete="off">
                            <option value="">Select a capacity...</option>
                            <option value="reader">Reader</option>
                            <option value="editor">Editor</option>
                            <option value="reviewer">Reviewer</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </td>
                    <td>
                        <a class="text-link cursor-pointer" onclick="saveNewMember()">Save</a>
                        <a class="text-danger cursor-pointer ms-2" onclick="cancelAddUser()">Cancel</a>
                </td>
            `;
        }

        function addUserField() {
            const userRow = $('#user-row-new');
            const editRow = $('#user-row-edit');
            if (editRow.length > 0) {
                cancelEditUser();
            }
            if (userRow.length === 0) {
                $('#new-org-member').before(buildAddUserRow());
                const selectUser = $('#select-user');
                systemUsers.forEach(user => {
                    selectUser.append(`<option value="${user.id}">${user.username} - ${user.fullname}</option>`);
                });

                new TomSelect("#select-user", {
                    sortField: {
                        field: "text",
                        direction: "asc"
                    }
                });

                new TomSelect("#select-capacity", {
                    create: true,
                    sortField: {
                        field: "text",
                        direction: "asc"
                    }
                });

            } else if (!userRow.hasClass('glowing-row')) {
                userRow.addClass('glowing-row');
                setTimeout(function () {
                    userRow.removeClass('glowing-row');
                }, 2000);
            }
        }

        function editUserMembership(id) {
            const addRow = $('#user-row-new');
            if (addRow.length > 0) {
                cancelAddUser();
            }
            const userRow = $(`#user-${id}`);
            if (userRow.length > 0) {
                cancelEditUser();
                const value = userRow.find('td:nth-child(2)').text().trim();
                const username = userRow.find('td:first').text().trim();
                const fullname = userRow.find('td:nth-child(2)').text().trim();
                const originalCapacity = userRow.find('td:nth-child(3)').text().trim();
                userRow.replaceWith(buildUserEditRow(fullname, username, id, originalCapacity));
                const capacitySelect = new TomSelect("#select-capacity", {
                    create: true,
                    sortField: {
                        field: "text",
                        direction: "asc"
                    }
                });
                if (originalCapacity) {
                    capacitySelect.setValue(originalCapacity);
                }
            } else {
                console.error(`User with key ${id} not found.`);
            }
        }

        function cancelAddUser() {
            $('#user-row-new').remove();
        }

        function cancelEditUser() {
            const userRow = $('#user-row-edit');
            if (userRow.length > 0) {
                const username = userRow.find('td:first').text().trim();
                const fullname = userRow.find('td:nth-child(2)').text().trim();
                const originalCapacity = userRow.find('input[name="user-original-capacity"]').val();
                const userId = userRow.find('input[name="user-original-id"]').val();
                userRow.replaceWith(buildNormalUserRow(fullname, username, userId, originalCapacity));
            } else {
                console.error("No edit row found.");
            }
        }


        function saveMember(){
            const userRow = $('#user-row-edit');
            const selectCapacity = $('#select-capacity');
            const userId = userRow.find('input[name="user-original-id"]').val();
            const originalCapacity = userRow.find('input[name="user-original-capacity"]').val();
            const newCapacity = selectCapacity.val();

            if (!newCapacity) {
                alert("Please select a capacity.");
                return;
            }

            if (newCapacity === originalCapacity) {
                cancelEditUser();
                return;
            }else {
                deleteMember(userId, function() {

                    $('#org-users-footer .stelar-loader').remove();
                    $('#org-users-footer .alert').remove();
                    $('#org-users-footer').prepend(createLoaderElement(false, true));
                    $.ajax({
                        url: "{{url_for('catalog_blueprint.api_add_user_member_to_organization', entity_id=organization.id, member_id='')}}"+userId,
                        type: "POST",
                        data: JSON.stringify({ capacity: newCapacity }),
                        contentType: "application/json",
                        success: function(response) {
                            $('#org-users-footer .stelar-loader').remove();
                            $('#org-users-footer .alert').remove();
                            if (response.success) {
                                const userDetails = systemUsers.find(user => user.id === userId);
                                if (userDetails) {
                                    $(`#user-${userId}`).replaceWith(buildNormalUserRow(userDetails.fullname, userDetails.username, userId, newCapacity.slice(0, 1).toUpperCase() + newCapacity.slice(1)));
                                    organizationUsers.push(userId);
                                    systemUsers = systemUsers.filter(user => user.id !== userId);
                                }
                                $('#org-users-footer').prepend(createAlertElement("success", "User updated successfully."));
                                setTimeout(function () {
                                    $('#org-users-footer .alert').fadeOut(500, function () {
                                        $(this).remove();
                                    });
                                }, 3000);
                                fetchSystemUsers(function(usersRep) {
                                    fetchOrganizationUsers(usersRep);
                                });
                            } else {
                                $('#org-users-footer').prepend(createAlertElement("danger", "Failed to update user: " + response.error));
                                setTimeout(function () {
                                    $('#org-users-footer .alert').fadeOut(500, function () {
                                        $(this).remove();
                                    });
                                }, 3000);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("AJAX Error:", status, error);
                            alert("An error occurred while updating the user.");
                        }
                    });
                });
            }           
        }


        function deleteMember(userId, callback){
            $.ajax({
                url: "{{url_for('catalog_blueprint.api_remove_user_member_from_organization', entity_id=organization.id, member_id='')}}"+userId,
                type: "DELETE",
                success: function(response) {
                    if (response.success) {
                        if (callback && typeof callback === 'function') {
                            callback();
                        }
                    } 
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                }
            });
        }


        function removeUserFromOrg(userId){
            if (!userId) {
                console.error("User ID is not defined.");
                return;
            }

            if (!confirm("Are you sure you want to remove this user from the organization?")) {
                return;
            }

            $('#org-users-footer .stelar-loader').remove()
            $('#org-users-footer .alert').remove();
            $('#org-users-footer').prepend(createLoaderElement(false, true));
            $.ajax({
                url: "{{url_for('catalog_blueprint.api_remove_user_member_from_organization', entity_id=organization.id, member_id='')}}"+userId,
                type: "DELETE",
                success: function(response) {
                    $('#org-users-footer .stelar-loader').remove();
                    $('#org-users-footer .alert').remove();
                    if (response.success) {
                        $(`#user-${userId}`).remove();
                        organizationUsers = organizationUsers.filter(user => user !== userId);
                        $('#org-users-footer').prepend(createAlertElement("success", "User removed successfully."));
                        setTimeout(function () {
                            $('#org-users-footer .alert').fadeOut(500, function () {
                                $(this).remove();
                            });
                        }, 3000);

                        fetchSystemUsers(function(usersRep) {
                            fetchOrganizationUsers(usersRep);
                        });
                    } else {
                        $('#org-users-footer').prepend(createAlertElement("danger", "Failed to remove user: " + response.error));
                        setTimeout(function () {
                            $('#org-users-footer .alert').fadeOut(500, function () {
                                $(this).remove();
                            });
                        }, 3000);
                    }
                },
                error: function(xhr, status, error) {

                    console.error("AJAX Error:", status, error);
                    alert("An error occurred while removing the user.");
                }
            });
        }


        function saveNewMember(){
            const selectUser = $('#select-user');
            const selectCapacity = $('#select-capacity');
            const userId = selectUser.val();
            const capacity = selectCapacity.val();

            if (!userId || !capacity) {
                alert("Please select a user and a capacity.");
                return;
            }

            if (organizationUsers.includes(userId)) {
                alert("This user is already a member of the organization.");
                return;
            }
            $('#org-users-footer .stelar-loader').remove()
            $('#org-users-footer .alert').remove();
            $('#org-users-footer').prepend(createLoaderElement(false, true));
            $.ajax({
                url: "{{url_for('catalog_blueprint.api_add_user_member_to_organization', entity_id=organization.id, member_id='')}}" + userId,
                type: "POST",
                data: JSON.stringify({ capacity: capacity }),
                contentType: "application/json",
                success: function (response) {
                    $('#org-users-footer .stelar-loader').remove();
                    $('#org-users-footer .alert').remove();
                    if (response.success) {
                        const userDetails = systemUsers.find(user => user.id === userId);
                        if (userDetails) {
                            $('#org-users-list').prepend(buildNormalUserRow(userDetails.fullname, userDetails.username, userId, capacity));
                            cancelAddUser();
                            organizationUsers.push(userId);
                            systemUsers = systemUsers.filter(user => user.id !== userId);
                        }
                        $('#org-users-footer').prepend(createAlertElement("success", "User added successfully."));
                        setTimeout(function () {
                            $('#org-users-footer .alert').fadeOut(500, function () {
                                $(this).remove();
                            });
                        }, 3000);
                        fetchSystemUsers(function (usersRep) {
                            fetchOrganizationUsers(usersRep);
                        });

                    } else {
                        $('#org-users-footer').prepend(createAlertElement("danger", "Failed to add user: " + response.error));
                        setTimeout(function () {
                            $('#org-users-footer .alert').fadeOut(500, function () {
                                $(this).remove();
                            });
                        }, 3000);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                    alert("An error occurred while adding the user.");
                }
            });
        }


    </script>
</body>