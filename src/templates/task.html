<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>STELAR | Task Overview</title>
    {% include 'tabler.html' %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="{{ url_for('static', filename='utils.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='stelar.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png">
</head>

<body>
    <div class="page">
        {% include 'header.html' %}
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">

                            
                            <div class="d-flex align-items-center justify-content-end">
                                <div class="col">
                                    <div class="page-pretitle">
                                        PROCESSES
                                    </div>
                                    <h3 class="page-title">
                                        <ol class="breadcrumb breadcrumb-arrows">
                                            <li class="breadcrumb-item"><a class="text-secondary"
                                                    href="{{ url_for('dashboard_blueprint.processes')}}">
                                                    Workflow Processes
                                                </a>
                                            </li>
                                            <li class="breadcrumb-item"><a class="text-secondary"
                                                    href="{{ url_for('dashboard_blueprint.process', process_id=task.process_id)}}">
                                                    Parent Process
                                                </a>
                                            </li>
                                            <li class="breadcrumb-item active"><a href="#"><span
                                                        class="text-strong">{{ task.name or task.id }}</span></a></li>
                                        </ol>
                                    </h3>
                                </div>
                                <div class="m-2 ms-auto">
                                    <span class="me-1" id="termination-status-area"></span>
                                    <button class="btn btn-outline-danger
                                        {% if task.exec_state in ['succeeded', 'failed'] or not task.image  %}disabled{% endif %}"
                                            onclick="terminateTask('{{ task.id }}')" id="terminate-task-btn">
                                        <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-power"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 6a7.75 7.75 0 1 0 10 0" /><path d="M12 4l0 8" /></svg>
                                        Terminate
                                    </button>
                                </div>
                                <div class="m-0 ms-2 h2 d-flex align-items-center justify-content-end">
                                    <span id="task-state-text" class="ms-2 me-1">{{ task.exec_state |
                                        capitalize }}</span>
                                    <span id="task-state-badge"
                                        class="status-indicator {% if task.exec_state == 'succeeded' %}status-green{% elif task.exec_state == 'failed' %}status-red{% elif task.exec_state == 'created' %}status-secondary{% else %}status-yellow status-indicator-animated{% endif %}">
                                        <span class="status-indicator-circle"></span>
                                        <span class="status-indicator-circle"></span>
                                        <span class="status-indicator-circle"></span>
                                    </span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="page-body">
                <div class="container-xl">
                    <div class="row row-cards">
                        <div class="col-lg-7">
                            <div class="card">
                                <div class="card-body">
                                    <div class="card-title">Basic Information</div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="icon me-2 text-secondary icon-tabler icons-tabler-outline icon-tabler-e-passport">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path
                                                d="M2 5m0 2a2 2 0 0 1 2 -2h16a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-16a2 2 0 0 1 -2 -2z" />
                                            <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                                            <path d="M9 12h-7" />
                                            <path d="M15 12h7" />
                                        </svg>
                                        ID: <strong id="task-id">{{ task.id }}</strong>
                                        <button type="button"
                                            class="btn btn-pill ms-1 px-2 py-0 btn-sm btn-outline-secondary"
                                            onclick="
                                                                              navigator.clipboard.writeText(document.getElementById('task-id').innerText);
                                                                              var el = document.getElementById('task-id');
                                                                              el.classList.remove('glowing-text');
                                                                              void el.offsetWidth; // trigger reflow to restart animation
                                                                              el.classList.add('glowing-text');">COPY</button>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="me-2 text-secondary icon"
                                            width="24" height="24" viewBox="0 0 24 24" stroke-width="2"
                                            stroke="currentColor" fill="none" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M12 3l8 4.5v9l-8 4.5l-8 -4.5v-9l8 -4.5" />
                                            <path d="M12 12l8 -4.5" />
                                            <path d="M12 12l0 9" />
                                            <path d="M12 12l-8 -4.5" />
                                        </svg>
                                        Parent Process: <strong><a
                                                href="{{ url_for('dashboard_blueprint.process', process_id=task.process_id)}}"
                                                target="_blank">{{ task.process_id }}</a></strong>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-brand-docker">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path
                                                d="M22 12.54c-1.804 -.345 -2.701 -1.08 -3.523 -2.94c-.487 .696 -1.102 1.568 -.92 2.4c.028 .238 -.32 1 -.557 1h-14c0 5.208 3.164 7 6.196 7c4.124 .022 7.828 -1.376 9.854 -5c1.146 -.101 2.296 -1.505 2.95 -2.46z" />
                                            <path d="M5 10h3v3h-3z" />
                                            <path d="M8 10h3v3h-3z" />
                                            <path d="M11 10h3v3h-3z" />
                                            <path d="M8 7h3v3h-3z" />
                                            <path d="M11 7h3v3h-3z" />
                                            <path d="M11 4h3v3h-3z" />
                                            <path d="M4.571 18c1.5 0 2.047 -.074 2.958 -.78" />
                                            <path d="M10 16l0 .01" />
                                        </svg>
                                        Tool Image: <strong>{{ task.get('image', 'Image Name
                                            Not
                                            Available')}}</strong>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="icon me-2 text-secondary icon-tabler icons-tabler-outline icon-tabler-player-play">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M7 4v16l13 -8z" />
                                        </svg>
                                        Started at: <strong>{{ task.start_date.strftime('%d-%m-%Y
                                            %H:%M:%S') }}</strong>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="icon me-2 text-secondary icon-tabler icons-tabler-outline icon-tabler-hand-stop">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M8 13v-7.5a1.5 1.5 0 0 1 3 0v6.5" />
                                            <path d="M11 5.5v-2a1.5 1.5 0 1 1 3 0v8.5" />
                                            <path d="M14 5.5a1.5 1.5 0 0 1 3 0v6.5" />
                                            <path
                                                d="M17 7.5a1.5 1.5 0 0 1 3 0v8.5a6 6 0 0 1 -6 6h-2h.208a6 6 0 0 1 -5.012 -2.7a69.74 69.74 0 0 1 -.196 -.3c-.312 -.479 -1.407 -2.388 -3.286 -5.728a1.5 1.5 0 0 1 .536 -2.022a1.867 1.867 0 0 1 2.28 .28l1.47 1.47" />
                                        </svg>
                                        Finished at: <span id="task-end-date"><strong>
                                                {% if task.get('end_date') %}
                                                {{ task.get('end_date').strftime('%d-%m-%Y %H:%M:%S') }}
                                                {% else %}
                                                Not Finished
                                                {% endif %}
                                            </strong></span>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-user">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                                            <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                                        </svg>
                                        Creator: <strong>{{ task.creator }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-5">
                            <div class="card">
                                <div class="card-body">
                                    <div class="card-title">Execution Parameters & Information</div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-brand-metabrainz">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M3 7v10l7 4v-18z" />
                                            <path d="M21 7v10l-7 4v-18z" />
                                        </svg>
                                        MinIO API Endpoint: <strong>{{ input.get('minio')['endpoint_url']
                                            }}</strong>
                                    </div>

                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-filter-cog">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path
                                                d="M12 20l-3 1v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v1.5" />
                                            <path d="M19.001 19m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                                            <path d="M19.001 15.5v1.5" />
                                            <path d="M19.001 21v1.5" />
                                            <path d="M22.032 17.25l-1.299 .75" />
                                            <path d="M17.27 20l-1.3 .75" />
                                            <path d="M15.97 17.25l1.3 .75" />
                                            <path d="M20.733 20l1.3 .75" />
                                        </svg>
                                        Parameters: <strong><a href="#" data-bs-toggle="modal"
                                                data-bs-target="#parameters-modal">View Tool Parameters</a></strong>
                                    </div>

                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-file-import">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                            <path
                                                d="M5 13v-8a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2h-5.5m-9.5 -2h7m-3 -3l3 3l-3 3" />
                                        </svg>
                                        Inputs: <strong><a href="#" data-bs-toggle="modal"
                                                data-bs-target="#inputs-json-modal">View Input
                                                Resources</a></strong>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-file-arrow-right">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                            <path
                                                d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                                            <path d="M9 15h6" />
                                            <path d="M12.5 17.5l2.5 -2.5l-2.5 -2.5" />
                                        </svg>
                                        Output: <strong><a href="#" data-bs-toggle="modal"
                                                data-bs-target="#outputs-json-modal">View Output
                                                Resources</a></strong>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-chart-arcs-3">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
                                            <path d="M7 12a5 5 0 1 0 5 -5" />
                                            <path d="M6.29 18.957a9 9 0 1 0 5.71 -15.957" />
                                        </svg>
                                        Metrics: <strong><a href="#" data-bs-toggle="modal"
                                                data-bs-target="#metrics-json-modal">View Metrics</a></strong>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-message">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M8 9h8" />
                                            <path d="M8 13h6" />
                                            <path
                                                d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12z" />
                                        </svg>
                                        Tool Messages: <strong><a href="#" data-bs-toggle="modal"
                                                data-bs-target="#messages-modal">View Tool Messages</a></strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row">
                                        <h3 class="card-title">Task In-Cluster Jobs</h3>
                                        <div class="text-secondary">
                                            <small>
                                                Jobs and logs are only available for tools executed within the KLMS
                                                cluster. Logs are available for 12h after a job is executed.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="accordion accordion-flush" id="jobs-accordion">
                                        {% if 'message' not in logs %}
                                        {% for job_id, job in logs.items() %}
                                        <div class="accordion-item" id="{{ job_id }}">
                                            <button class="accordion-header collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#logs-collapse-{{job_id}}"
                                                aria-expanded="true">
                                                <div class="row w-100">
                                                    <div class="col-6 d-flex align-items-center">
                                                        <span>{{ job_id }}</span>
                                                    </div>
                                                    <div class="col-6 d-flex align-items-center justify-content-end">
                                                        <span id="job-{{ job_id }}-badge"
                                                            class="badge {% if job['status'] == 'Succeeded' %}bg-success{% elif job['status'] =='Running' %}bg-warning{% else %}bg-danger{% endif %} me-1"></span>
                                                        <span id="job-{{ job_id }}-status" class="d-inline m-1">{{
                                                            job['status'] }}</span>
                                                    </div>
                                                </div>
                                                <div class="accordion-header-toggle">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                        class="icon icon-1">
                                                        <path d="M6 9l6 6l6 -6"></path>
                                                    </svg>
                                                </div>
                                            </button>
                                            <div id="logs-collapse-{{job_id}}" class="accordion-collapse collapse"
                                                data-bs-parent="#jobs-accordion" style="">
                                                <div class="accordion-body px-6">
                                                    <h4>Runtime Logs</h4>
                                                    <div style="max-height: 40rem; overflow: auto;">
                                                        <pre id="job-{{ job_id }}-logs"
                                                            style="max-height: 100%; overflow: auto; white-space: pre-wrap; word-break: break-all;">{{ job['logs'] | replace('\n', '<br>') | replace('\"', '') | safe }}</pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal modal-blur fade" id="inputs-json-modal" tabindex="-1" role="dialog"
                    aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Task Inputs</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-sm table-borderless">
                                    <thead>
                                        <tr>
                                            <th class="w-25">Resource ID</th>
                                            <th>Input Path</th>
                                            <th>Input Group</th>
                                            <th class="text-end w-25">File Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for field, files in input['input'].items() %}
                                        {% for file in files %}
                                        <tr>
                                            <td> {% if file.get('id') %}
                                                <div><a target="_blank"
                                                        href='{{ url_for("dashboard_blueprint.viewResource", resource_id= file.get("id")) }}'>
                                                        {{ file.get('id') }}</a>
                                                </div>
                                                {% else %}
                                                <div> Not associated</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div>{{ file.get('path') }}</div>
                                            </td>
                                            <td>
                                                <div>{{ field }}</div>
                                            </td>
                                            <td class="w-1 fw-bold text-end">
                                                <a href="/s3/browser/{{ file.get('path') | replace('s3://', '') }}"
                                                    target="_blank">Open in S3</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn me-auto" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal modal-blur fade" id="outputs-json-modal" tabindex="-1" role="dialog"
                    aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Task Output Resources</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-sm table-borderless">
                                    <thead>
                                        <tr>
                                            <th>Output Name</th>
                                            <th>Resource ID</th>
                                            <th>Output Path</th>
                                            <th class="text-end w-25">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if task.get('outputs') %}
                                        {% for key, item in task.get('outputs').items() %}
                                        <tr>
                                            <td>
                                                <div>{{ key }}</div>
                                            </td>
                                            <td>
                                                <div>
                                                    <a target="_blank"
                                                        href='{{ url_for("dashboard_blueprint.viewResource", resource_id= item.get("resource_id")) }}'>
                                                        {{ item.get('resource_id') }}</a>
                                                </div>
                                            </td>
                                            <td>
                                                <div>{{ item.get("url", "Not registered") }}</div>
                                            </td>
                                            <td class="w-1 fw-bold text-end">
                                                <a href="/s3/browser/{{ item.get('url') | replace('s3://', '') }}"
                                                    target="_blank">Open in S3</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn me-auto" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal modal-blur fade" id="metrics-json-modal" tabindex="-1" role="dialog"
                    aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Task Metrics</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-sm table-borderless">
                                    <thead>
                                        <tr>
                                            <th>Metrics Key</th>
                                            <th class="text-end w-75">Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if task.get('metrics') %}
                                        {% for key, value in task.get('metrics').items() %}
                                        <tr>
                                            <td>
                                                <div>{{ key }}</div>
                                            </td>
                                            <td class="w-3 fw-bold text-end">
                                                {{ value }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="2">No Metrics Available</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn me-auto" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal modal-blur fade" id="parameters-modal" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog  modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Task Parameters</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-sm table-borderless">
                                    <thead>
                                        <tr>
                                            <th>Parameter</th>
                                            <th class="text-end w-75">Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if input.get('parameters') %}
                                        {% for key, value in input.get('parameters').items() %}
                                        <tr>
                                            <td>
                                                <div>{{ key }}</div>
                                            </td>
                                            <td class="w-3 fw-bold text-end">
                                                {% if value is mapping %}
                                                    <pre style="text-align: left; white-space: pre-wrap;">{{ value | tojson(indent=2) }}</pre>
                                                    {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="2">No Parameters Available</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn me-auto" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal modal-blur fade" id="messages-modal" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Tool Messages</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                {% if task.get('tags') %}
                                    <p>{{ task['tags'].get('log', 'No Messages Available') }}</p>
                                {% else %}
                                    <p>No Messages Available</p>
                                {% endif %}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn me-auto" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% include 'footer.html' %}
        </div>
    </div>
    <script>

        function fetchTaskJobs() {
            $.ajax({
                url: `{{ url_for('rest_workflows_blueprint.api_get_task_jobs', task_id=task.id) }}`,
                method: 'GET',
                success: function (response) {
                    updateJobsTable(response.result);

                    if ($('#task-state-text').text().trim().toLowerCase() === 'failed' ||
                        $('#task-state-text').text().trim().toLowerCase() === 'succeeded') {
                        clearInterval(fetchTaskJobsInterval);
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/';
                    } else {
                        console.error(xhr);
                    }
                }
            });
        }

        function createJobAccordion(job, id) {
            return `
            <div class="accordion-item" id="${id}">
                <button class="accordion-header collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#logs-collapse-${id}"
                aria-expanded="true">
                <div class="row w-100">
                    <div class="col-6 d-flex align-items-center">
                    <span>${id}</span>
                    </div>
                    <div class="col-6 d-flex align-items-center justify-content-end">
                    <span id="job-${id}-badge"
                        class="badge ${job.status === 'Succeeded' ? 'bg-success' : (job.status === 'Running' ? 'bg-warning' : 'bg-danger')} me-1"></span>
                    <span id="job-${id}-status" class="d-inline m-1">${job.status}</span>
                    </div>
                </div>
                <div class="accordion-header-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-1">
                    <path d="M6 9l6 6l6 -6"></path>
                    </svg>
                </div>
                </button>
                <div id="logs-collapse-${id}" class="accordion-collapse collapse"
                data-bs-parent="#jobs-accordion">
                <div class="accordion-body px-6">
                    <h4>Runtime Logs</h4>
                    <div style="max-height: 40rem; overflow: auto;">
                    <pre id="job-${id}-logs"
                        style="max-height: 100%; overflow: auto; white-space: pre-wrap; word-break: break-all;">${job.logs.replace(/\n/g, '<br>').replace(/"/g, '')}</pre>
                    </div>
                </div>
                </div>
            </div>`;
        }

        function updateJobsTable(jobs) {
            if ("message" in jobs) {
                clearInterval(fetchTaskJobsInterval);
                return;
            }

            for (const id in jobs) {
                job = jobs[id];
                const existingJobEl = document.getElementById(id);
                if (!existingJobEl) {
                    const accordionEl = document.getElementById('jobs-accordion');
                    accordionEl.insertAdjacentHTML('beforeend', createJobAccordion(job, id));
                } else {
                    // Update logs for existing jobs
                    const logsEl = document.getElementById(`job-${id}-logs`);
                    if (logsEl) {
                        logsEl.innerHTML = job.logs.replace(/\n/g, '<br>').replace(/\"/g, '');
                    }
                    // Update job status text and badge
                    const statusEl = document.getElementById(`job-${id}-status`);
                    if (statusEl) {
                        statusEl.textContent = job.status;
                    }
                    const badgeEl = document.getElementById(`job-${id}-badge`);
                    if (badgeEl) {
                        if (job.status === 'Succeeded') {
                            badgeEl.className = 'badge bg-success me-1';
                        } else if (job.status === 'Running') {
                            badgeEl.className = 'badge bg-warning me-1';
                        } else {
                            badgeEl.className = 'badge bg-danger me-1';
                        }
                    }
                }
            }
        }

        var fetchTaskJobsInterval = setInterval(fetchTaskJobs, 10000);
        $(document).ready(function () {
            fetchTaskJobs();
        });

    </script>


    <script>
        function loadTaskMetadata() {
            $.ajax({
                url: `{{ url_for('rest_workflows_blueprint.api_get_task_metadata', entity_id=task.id) }}`,
                method: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response.success) {

                        // Update Output Resources Modal
                        updateOutputModal(response.result.outputs);

                        // Update Metrics Modal
                        updateMetricsModal(response.result.metrics);

                        // Update Logs Modal
                        updateLogsModal(response.result.messages);

                        // Update the task state
                        updateTaskState(response.result.exec_state, response.result.end_date);

                        if (response.result.exec_state === 'succeeded' || response.result.exec_state === 'failed') {
                            clearInterval(loadTaskMetadataInterval);
                        }
                    }
                },
                error: function (xhr, status, error) {
                    if (xhr.status === 401 || xhr.status === 403) {
                        window.location.href = '/';
                    }
                }
            });
        }

        function updateOutputModal(output) {
            const outputModalBody = $('#outputs-json-modal .modal-body tbody');
            outputModalBody.empty();
            if (output && Object.keys(output).length > 0) {
            Object.entries(output).forEach(([key, item]) => {
                const resourceUrl = "{{ url_for('dashboard_blueprint.viewResource', resource_id='') }}" + item.resource_id;
                const displayUrl = item.url ? item.url : "Not registered";
                const s3Url = item.url ? "/s3/browser/" + item.url.replace("s3://", "") : "#";
                const row = `<tr>
                <td>
                    <div>${key}</div>
                </td>
                <td>
                    <div>
                    <a target="_blank" href="${resourceUrl}">
                        ${item.resource_id}
                    </a>
                    </div>
                </td>
                <td>
                    <div>${displayUrl}</div>
                </td>
                <td class="w-1 fw-bold text-end">
                    <a href="${s3Url}" target="_blank">Open in S3</a>
                </td>
                </tr>`;
                outputModalBody.append(row);
            });
            } else {
            outputModalBody.append('<tr><td colspan="2">No Output Resources Available</td></tr>');
            }
        }

        function updateMetricsModal(metrics) {
            const metricsModalBody = $('#metrics-json-modal .modal-body tbody');
            metricsModalBody.empty();

            if (metrics) {
            Object.keys(metrics).forEach(key => {
                let value = metrics[key];
                if (typeof value === 'object' && value !== null) {
                    value = `<pre style="text-align: left; white-space: pre-wrap;">${JSON.stringify(value, null, 2)}</pre>`;
                }
                const row = `<tr>
                        <td><div>${key}</div></td>
                        <td class="w-3 fw-bold text-end">${value}</td>
                    </tr>`;
                metricsModalBody.append(row);
            });
            } else {
            metricsModalBody.append('<tr><td colspan="2">No Metrics Available</td></tr>');
            }
        }

        function updateLogsModal(log) {
            const logsModalBody = $('#messages-modal .modal-body p');
            if (log) {
                logsModalBody.text(log);
            } else {
                logsModalBody.text('No Messages Available');
            }
        }

        function updateTaskState(newState, newEndDate) {
            const taskStateBadgeId = `task-state-badge`;
            const taskStateTextId = `task-state-text`;

            const taskStateBadge = document.getElementById(taskStateBadgeId);
            if (taskStateBadge) {
                if (newState === 'succeeded') {
                    taskStateBadge.className = 'status-indicator status-green';
                    $('#terminate-task-btn').addClass('disabled');
                } else if (newState === 'failed') {
                    taskStateBadge.className = 'status-indicator status-red';
                    $('#terminate-task-btn').addClass('disabled');
                } else if (newState === 'created') {
                    taskStateBadge.className = 'status-indicator status-secondary';
                } else {
                    taskStateBadge.className = 'status-indicator status-indicator-animated status-yellow';
                }
            }

            const taskStateText = document.getElementById(taskStateTextId);
            if (taskStateText) {
                taskStateText.textContent = newState.charAt(0).toUpperCase() + newState.slice(1);
            }


            if (newEndDate && (newState === 'succeeded' || newState === 'failed')) {
                // Change the second parameter to false if you don't want seconds.
                const formattedDate = formatIsoDate(newEndDate, true);
                const taskEndDateEl = document.getElementById('task-end-date');
                if (taskEndDateEl) {
                    const strongEl = taskEndDateEl.querySelector('strong');
                    if (strongEl) {
                        strongEl.textContent = formattedDate;
                    }
                }
            }

        }


        function terminateTask() {
            if (confirm("Are you sure you want to terminate this task? This action cannot be undone.")) {

                $('#terminate-task-btn').addClass('disabled');
                $('#termination-status-area').prepend(createLoaderElement(true, false));
                $('#termination-status-area .stelar-symbol').remove();
                $('#termination-status-area .stelar-loader').remove();

                $.ajax({
                    url: `{{ url_for('rest_workflows_blueprint.api_post_task_terminate', task_id=task.id) }}`,
                    method: 'POST',
                    success: function (response) {
                        $('#termination-status-area .stelar-symbol').remove();
                        $('#termination-status-area .stelar-loader').remove();
                       
                        if (response.success) {
                            $('#termination-status-area').prepend(createGreenTick());
                            setTimeout(function () {
                                $('#termination-status-area .stelar-symbol').fadeOut(500, function () {
                                    $(this).remove();
                                });
                            }, 3000);
                            loadTaskMetadata();
                            fetchTaskJobs();
                        }
                    },
                    error: function (xhr) {
                        $('#termination-status-area .stelar-symbol').remove();
                        $('#termination-status-area .stelar-loader').remove();
                        if (xhr.status === 401 || xhr.status === 403) {
                            window.location.href = '/';
                        } else {
                            $('#termination-status-area').prepend(createRedCross());
                            setTimeout(function () {
                                $('#termination-status-area .stelar-symbol').fadeOut(500, function () {
                                    $(this).remove();
                                });
                            }, 3000);
                            console.error(xhr);
                        }
                    }
                });
            }
        }

        var loadTaskMetadataInterval = setInterval(loadTaskMetadata, 8000);

        $(document).ready(function () {
            loadTaskMetadata();
        });
    </script>
</body>

</html>