<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>STELAR | Data Catalog</title>
  {% include 'tabler.html' %}
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet PM CSS (for polygon editing) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.css" />

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="{{ url_for('static', filename='images.js') }}"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='stelar.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png">
</head>

<body>
  <div class="page">
    <!-- Navbar -->
    {% include 'header.html' %}
    <div class="page-wrapper">
      <!-- Page header -->
      <div class="page-header d-print-none">
        <div class="container-xl">
          <div class="row g-2 align-items-center">
            <div class="col">
              <!-- Page pre-title -->
              <div class="page-pretitle">
                Data Catalog
              </div>
              <h2 class="page-title">
                Browse & Manage Packages
              </h2>
            </div>
            <div class="col-auto me-2 d-print-none">
              <div class="input-group">

                <button type="button" class="btn btn-secondary" id="compare-datasets-button"
                  onclick="window.location.href='{{url_for('dashboard_blueprint.dataset_compare')}}'">Compare Selected
                  <span class="ms-1" id="dataset-compare-number">(0)</span></button>

                <button data-bs-toggle="dropdown" role="button" class="btn btn-secondary dropdown-toggle"
                  datas-bs-auto-close="outside"></button>
                <div class="dropdown-menu dropdown-menu-end" id="compare-dataset-options">

                </div>
              </div>
            </div>
            <div class="col-auto ms-auto d-print-none">
              <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-new-dataset">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M12 5l0 14" />
                  <path d="M5 12l14 0" />
                </svg>
                Publish
              </a>
            </div>
          </div>
        </div>
      </div>
      <!-- Page body -->
      <div class="page-body">
        <div class="container-xl">
          <div class="row g-4">
            <div class="col-md-3">

              <div class="form-label">Spatial Queries</div>
              <a data-bs-toggle="modal" data-bs-target="#spatial-search-modal" href="#" class="mb-4 card card-link m"
                style="height: 15%;" id="map">

              </a>

              <div class="form-label h3">Tags</div>
              <div class="mb-1 p-1" style="max-height: 16.5rem; overflow: auto;">
                {% for tag in tags %}
                {% if loop.index <= 8 %} <label class="form-check tag-item">
                  <input type="checkbox" class="form-check-input" name="form-type[]" value="{{ tag }}">
                  <span class="form-check-label">{{ tag }}</span>
                  </label>
                  {% else %}
                  <label class="form-check tag-item more-tag" style="display: none;">
                    <input type="checkbox" class="form-check-input" name="form-type[]" value="{{ tag }}">
                    <span class="form-check-label">{{ tag }}</span>
                  </label>
                  {% endif %}
                  {% endfor %}
              </div>
              {% if tags|length > 8 %}
              <a id="toggle-tags-btn" class="me-1 mb-1 cursor-pointer" data-expanded="false" onclick="
                          var moreTags = document.querySelectorAll('.more-tag');
                          var btn = document.getElementById('toggle-tags-btn');
                          if (btn.getAttribute('data-expanded') === 'true') {
                          moreTags.forEach(el => el.style.display = 'none');
                          btn.innerHTML = 'Show All <svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;24&quot; height=&quot;24&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; class=&quot;me-2 icon icon-tabler icons-tabler-outline icon-tabler-chevron-down&quot;><path stroke=&quot;none&quot; d=&quot;M0 0h24v24H0z&quot; fill=&quot;none&quot;/><path d=&quot;M6 9l6 6l6 -6&quot; /></svg>';
                          btn.setAttribute('data-expanded','false');
                          } else {
                          moreTags.forEach(el => el.style.display = 'block');
                          btn.innerHTML = 'Show Less <svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;24&quot; height=&quot;24&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; class=&quot;me-2 icon icon-tabler icons-tabler-outline icon-tabler-chevron-up&quot;><path stroke=&quot;none&quot; d=&quot;M0 0h24v24H0z&quot; fill=&quot;none&quot;/><path d=&quot;M6 15l6 -6l6 6&quot; /></svg>';
                          btn.setAttribute('data-expanded','true');
                          }
                        ">
                Show All
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-chevron-down">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M6 9l6 6l6 -6" />
                </svg>
              </a>
              {% endif %}
              <hr>
              <div class="form-label">Resource Formats</div>
              <div class="mb-4">
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" name="form-type[]" value="1" checked>
                  <span class="form-check-label">JSON</span>
                </label>
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" name="form-type[]" value="2" checked>
                  <span class="form-check-label">XML</span>
                </label>
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" name="form-type[]" value="3">
                  <span class="form-check-label">CSV</span>
                </label>
              </div>

              <div class="mt-5">
                <button class="btn btn-primary w-100">
                  Apply filters
                </button>
                <a href="#" class="btn btn-link w-100">
                  Reset to defaults
                </a>
              </div>
            </div>
            <div class="col-md-9">
              <div class="mb-4 mt-2">
                <div class="input-icon">
                  <span class="input-icon-addon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                      <path d="M21 21l-6 -6" />
                    </svg>
                  </span>
                  <input type="text" value="" class="form-control" placeholder="Search for a keyword"
                    id="catalog-search-box" aria-label="Catalog Search">
                </div>
              </div>

              <ul class="pagination d-flex justify-content-end">
                {% if page_number > 1 %}
                <!-- Previous Button -->
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('dashboard_blueprint.catalog', page_number=page_number - 1) }}"
                    aria-label="Previous">
                    <span aria-hidden="true">&laquo; prev</span>
                  </a>
                </li>
                {% endif %}

                <!-- First Page Button -->
                {% if total_pages > 1 %}
                <li class="page-item {% if page_number == 1 %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('dashboard_blueprint.catalog', page_number=1) }}">1</a>
                </li>
                {% endif %}

                <!-- Handle Middle Pages -->
                {% if total_pages > 8 %}
                {% if page_number > 4 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}

                {% for page in range(page_number - 2, page_number + 3) %}
                {% if page > 1 and page < total_pages %} <li
                  class="page-item {% if page == page_number %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('dashboard_blueprint.catalog', page_number=page) }}">{{ page
                    }}</a>
                  </li>
                  {% endif %}
                  {% endfor %}

                  {% if page_number < total_pages - 3 %} <li class="page-item disabled"><span
                      class="page-link">...</span></li>
                    {% endif %}
                    {% else %}
                    {% for page in range(2, total_pages) %}
                    <li class="page-item {% if page == page_number %}active{% endif %}">
                      <a class="page-link" href="{{ url_for('dashboard_blueprint.catalog', page_number=page) }}">{{
                        page }}</a>
                    </li>
                    {% endfor %}
                    {% endif %}

                    <!-- Last Page Button -->
                    {% if total_pages > 1 %}
                    <li class="page-item {% if page_number == total_pages %}active{% endif %}">
                      <a class="page-link"
                        href="{{ url_for('dashboard_blueprint.catalog', page_number=total_pages) }}">{{
                        total_pages
                        }}</a>
                    </li>
                    {% endif %}

                    {% if page_number < total_pages %} <!-- Next Button -->
                      <li class="page-item">
                        <a class="page-link"
                          href="{{ url_for('dashboard_blueprint.catalog', page_number=page_number + 1) }}"
                          aria-label="Next">
                          <span aria-hidden="true">next &raquo;</span>
                        </a>
                      </li>
                      {% endif %}
              </ul>

              <div class="row row-cards">
                <div class="space-y" id='dataset-container'>
                  {% if datasets %}
                  <!-- An example placeholder to avoid destruction of the first element -->
                  <div class="card card-link cursor-pointer disabled mb-3" style="display:none;">
                  </div>
                  {% for dataset in datasets %}
                  <div class="card card-link cursor-pointer disabled mb-3">
                    <div class="row g-0">
                      <div class="col-auto">
                        <div class="card-body">
                          <div class="avatar avatar-md bg-white" style="background-image: url({{ PARTNER_IMAGE_SRC }})">
                          </div>
                        </div>
                      </div>
                      <div class="col">
                        <div class="card-body ps-0">
                          <div class="row">
                            <div class="col-md-11">
                              <h3 class="mb-0">
                                <a
                                  href="{{url_for('dashboard_blueprint.dataset_detail', dataset_id=dataset.get('id'))}}">{{
                                  dataset.get('title', 'Untitled Dataset') }}</a>
                                {% if dataset.get('type') == 'workflow' %}
                                <span class="badge bg-purple-lt ms-2">WORKFLOW</span>
                                {% elif dataset.get('type') == 'dataset' %}
                                <span class="badge bg-blue-lt ms-2">DATASET</span>
                                {% elif dataset.get('type') == 'process' %}
                                <span class="badge bg-yellow-lt ms-2">PROCESS</span>
                                {% endif %}
                              </h3>
                              <p class="text-secondary mt-1">{{ dataset.get('notes', 'No description specified') }}
                              </p>
                            </div>
                            <div class="col-md-1 d-flex justify-content-end">
                              <button
                                class="btn btn-pill btn-outline-success m-3 me-1 p-1 text-center comparator-btn align-self-center"
                                data-dataset-id="{{ dataset.get('id') }}" title="Add to comparison">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                  stroke-linejoin="round"
                                  class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-git-compare">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                  <path d="M6 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                                  <path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                                  <path d="M11 6h5a2 2 0 0 1 2 2v8" />
                                  <path d="M14 9l-3 -3l3 -3" />
                                  <path d="M13 18h-5a2 2 0 0 1 -2 -2v-8" />
                                  <path d="M10 15l3 3l-3 3" />
                                </svg>
                              </button>
                              <!-- <button class="btn btn-pill btn-outline-yellow m-3 me-1 p-1 text-center"><svg
                                  xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                  stroke-linejoin="round"
                                  class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-star">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                  <path
                                    d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                                </svg></button> -->
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-md">
                              <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                                <div class="list-inline-item">
                                  <svg xmlns="http://www.w3.org/2000/svg"
                                    class="icon icon-tabler icon-tabler-building-bank" width="44" height="44"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path d="M3 21l18 0" />
                                    <path d="M3 10l18 0" />
                                    <path d="M5 6l7 -3l7 3" />
                                    <path d="M4 10l0 11" />
                                    <path d="M20 10l0 11" />
                                    <path d="M8 14l0 3" />
                                    <path d="M12 14l0 3" />
                                    <path d="M16 14l0 3" />
                                  </svg>
                                  {{ dataset.organization.title }}
                                </div>
                                <div class="list-inline-item">
                                  <svg xmlns="http://www.w3.org/2000/svg"
                                    class="icon icon-tabler icon-tabler-calendar-month" width="44" height="44"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path
                                      d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z" />
                                    <path d="M16 3v4" />
                                    <path d="M8 3v4" />
                                    <path d="M4 11h16" />
                                    <path d="M7 14h.013" />
                                    <path d="M10.01 14h.005" />
                                    <path d="M13.01 14h.005" />
                                    <path d="M16.015 14h.005" />
                                    <path d="M13.015 17h.005" />
                                    <path d="M7.01 17h.005" />
                                    <path d="M10.01 17h.005" />
                                  </svg>
                                  {{ dataset.get('metadata_modified').strftime('%d-%m-%Y %H:%M') or
                                  dataset.get('metadata_created').strftime('%d-%m-%Y %H:%M') }}
                                </div>
                                <div class="list-inline-item">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                                    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                                  </svg>
                                  {{ dataset.get('author', 'Not specified')}}
                                </div>
                              </div>
                            </div>
                            <div class="col-md-auto">
                              <div class="mt-3 badges">
                                {% for tag in dataset.get('tags') %}
                                <span class="tag m-1 mb-0">{{ tag }}</span>
                                {% endfor %}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                  {% else %}
                  <h3>No Datasets Found</h3>
                  {% endif %}
                </div>
              </div>
              <ul class="pagination d-flex justify-content-end">
                {% if page_number > 1 %}
                <!-- Previous Button -->
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('dashboard_blueprint.catalog', page_number=page_number - 1) }}"
                    aria-label="Previous">
                    <span aria-hidden="true">&laquo; prev</span>
                  </a>
                </li>
                {% endif %}

                <!-- First Page Button -->
                {% if total_pages > 1 %}
                <li class="page-item {% if page_number == 1 %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('dashboard_blueprint.catalog', page_number=1) }}">1</a>
                </li>
                {% endif %}

                <!-- Handle Middle Pages -->
                {% if total_pages > 8 %}
                {% if page_number > 4 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}

                {% for page in range(page_number - 2, page_number + 3) %}
                {% if page > 1 and page < total_pages %} <li
                  class="page-item {% if page == page_number %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('dashboard_blueprint.catalog', page_number=page) }}">{{ page
                    }}</a>
                  </li>
                  {% endif %}
                  {% endfor %}

                  {% if page_number < total_pages - 3 %} <li class="page-item disabled"><span
                      class="page-link">...</span></li>
                    {% endif %}
                    {% else %}
                    {% for page in range(2, total_pages) %}
                    <li class="page-item {% if page == page_number %}active{% endif %}">
                      <a class="page-link" href="{{ url_for('dashboard_blueprint.catalog', page_number=page) }}">{{
                        page }}</a>
                    </li>
                    {% endfor %}
                    {% endif %}

                    <!-- Last Page Button -->
                    {% if total_pages > 1 %}
                    <li class="page-item {% if page_number == total_pages %}active{% endif %}">
                      <a class="page-link"
                        href="{{ url_for('dashboard_blueprint.catalog', page_number=total_pages) }}">{{ total_pages
                        }}</a>
                    </li>
                    {% endif %}

                    {% if page_number < total_pages %} <!-- Next Button -->
                      <li class="page-item">
                        <a class="page-link"
                          href="{{ url_for('dashboard_blueprint.catalog', page_number=page_number + 1) }}"
                          aria-label="Next">
                          <span aria-hidden="true"> next &raquo;</span>
                        </a>
                      </li>
                      {% endif %}
              </ul>
            </div>
          </div>
        </div>
        <div class="modal modal-blur fade" id="spatial-search-modal" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog me-6 ms-6 mt-2 modal-full-width modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Spatial Search </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">

                <div class="row">
                  <div class="col-lg-2">
                    <div class="h3">Saved Polygons</div>
                    <p class="text-secondary text-sm ">Here you may find any saved polygons in the STELAR KLMS, used
                      in
                      previous searches.</p>
                    <ul id="savedPolygonList" class="list-group">

                    </ul>
                  </div>
                  <div class="col-lg-10">
                    <div class="h3 ms-4">Interactive Map</div>
                    <p class="ms-4 text-sm text-secondary">Use the drawing toolbox below to define an area on the map.
                      A
                      search will be performed on the available datasets to find results lying within the marked area.
                    </p>
                    <div id="search-map" class="m-4 card card-link m" style="height: 60vh">



                    </div>
                    <p class="ms-4 text-sm text-secondary">Only one polygon can be used in a search query. Make sure
                      your polygon is convex for optimal results.</p>
                  </div>
                </div>

              </div>
              <div class="modal-footer" id="spatial-search-modal-footer">
                <a href="#" class="btn btn-primary ms-auto" data-bs-dismiss="modal">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-search">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                    <path d="M21 21l-6 -6" />
                  </svg>
                  Search
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div class="toast fade hide" role="alert" id="toast-message-alert" aria-live="assertive" aria-atomic="true"
            data-bs-autohide="false">
            <div class="toast-header">
              <strong class="me-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                  class="me-2 text-primary icon icon-tabler icons-tabler-filled icon-tabler-alert-square-rounded">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M12 2l.642 .005l.616 .017l.299 .013l.579 .034l.553 .046c4.687 .455 6.65 2.333 7.166 6.906l.03 .29l.046 .553l.041 .727l.006 .15l.017 .617l.005 .642l-.005 .642l-.017 .616l-.013 .299l-.034 .579l-.046 .553c-.455 4.687 -2.333 6.65 -6.906 7.166l-.29 .03l-.553 .046l-.727 .041l-.15 .006l-.617 .017l-.642 .005l-.642 -.005l-.616 -.017l-.299 -.013l-.579 -.034l-.553 -.046c-4.687 -.455 -6.65 -2.333 -7.166 -6.906l-.03 -.29l-.046 -.553l-.041 -.727l-.006 -.15l-.017 -.617l-.004 -.318v-.648l.004 -.318l.017 -.616l.013 -.299l.034 -.579l.046 -.553c.455 -4.687 2.333 -6.65 6.906 -7.166l.29 -.03l.553 -.046l.727 -.041l.15 -.006l.617 -.017c.21 -.003 .424 -.005 .642 -.005zm.01 13l-.127 .007a1 1 0 0 0 0 1.986l.117 .007l.127 -.007a1 1 0 0 0 0 -1.986l-.117 -.007zm-.01 -8a1 1 0 0 0 -.993 .883l-.007 .117v4l.007 .117a1 1 0 0 0 1.986 0l.007 -.117v-4l-.007 -.117a1 1 0 0 0 -.993 -.883z" />
                </svg>System Alert</strong>
              <small>Just now</small>
              <button type="button" class="ms-2 btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message-body">
              Message not available
            </div>
          </div>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div class="toast fade hide" role="alert" id="toast-message-info" aria-live="assertive" aria-atomic="true"
            data-bs-autohide="false">
            <div class="toast-header">
              <strong class="me-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                  class="me-2 text-primary icon icon-tabler icons-tabler-filled icon-tabler-bulb">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M4 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z" />
                  <path
                    d="M12 2a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z" />
                  <path d="M21 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z" />
                  <path
                    d="M4.893 4.893a1 1 0 0 1 1.32 -.083l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 0 -1.414z" />
                  <path
                    d="M17.693 4.893a1 1 0 0 1 1.497 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7z" />
                  <path d="M14 18a1 1 0 0 1 1 1a3 3 0 0 1 -6 0a1 1 0 0 1 .883 -.993l.117 -.007h4z" />
                  <path
                    d="M12 6a6 6 0 0 1 3.6 10.8a1 1 0 0 1 -.471 .192l-.129 .008h-6a1 1 0 0 1 -.6 -.2a6 6 0 0 1 3.6 -10.8z" />
                </svg>System Info</strong>
              <small>Just now</small>
              <button type="button" class="ms-2 btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-info-body">
              Message not available
            </div>
          </div>
        </div>
        <div class="modal modal-blur fade" id="modal-new-dataset" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
              <form>
                <div class="modal-header">
                  <h5 class="modal-title">New Dataset</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-lg-12">

                      <div class="mb-3">
                        <label class="form-label">Title</label>
                        <div class="row g-2">
                          <div class="col">
                            <input type="text" class="form-control" name="package-name-input"
                              placeholder="Dataset Title" required>
                          </div>
                          <div class="col-auto align-self-center">
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top"
                              data-bs-content="The dataset title <strong>must be unique</strong>. It serves as one of the unique identifiers of the dataset."
                              data-bs-html="true">?</span>
                          </div>
                        </div>
                      </div>
                      <div class="d-flex">
                        <div class="text-secondary text-start justify-content-left" id="availability-div">
                          <a onclick="checkNameAvailability()" class="text-sm p-2 cursor-pointer link-secondary"
                            title="Check Title Availability" data-bs-toggle="tooltip" tabindex="-1">
                            Check title availability
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="packageDescription" class="form-control" rows="3" required
                          placeholder="A nice informative description"></textarea>
                      </div>
                    </div>
                    <input type="hidden" name="packageTags" id="hiddenTagsInput" name="tags" />
                    <div class="col-lg-12">
                      <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" id="tagInput" class="form-control" placeholder="Type a tag and press enter"
                          required>
                        <div class="col tags-list mt-3" id="tagsContainer">
                          <!-- Tags will be dynamically added here -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer" id="new-dataset-modal-footer">
                  <a class="cursor-pointer btn btn-primary ms-auto" id="publish-dataset-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M12 5l0 14" />
                      <path d="M5 12l14 0" />
                    </svg>
                    Publish Dataset
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% include 'footer.html'%}
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <!-- Preview Map -->
  <script>
    var map = L.map('map', {
      center: [47.57536996623514, 8.261718750000002],
      zoom: 3,
      zoomControl: false,
      maxZoom: 3,
      minZoom: 3,
      scrollWheelZoom: false,
      dragging: false
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

  </script>

  <!-- Spatial Modal Map -->
  <script>
    // Initialize the map
    var searchMap = L.map('search-map', {
      center: [38.6137, 24.6116],
      zoom: 3,
    });

    // Base layers
    var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });

    var topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    });

    // Add the default layer to the map
    streetLayer.addTo(searchMap);

    // Layer control
    var baseLayers = {
      "Street Map": streetLayer,
      "Topographical Map": topoLayer
    };

    L.control.layers(baseLayers).addTo(searchMap);

    // Feature Group to store the single drawn polygon
    var drawnPolygon = null;

    // Add drawing controls
    var drawControl = new L.Control.Draw({
      edit: false, // Disable bulk editing
      draw: {

        polygon: {
          allowIntersection: false,
          showArea: true,
          remove: true
        },
        polyline: false,
        rectangle: true,
        circle: false,
        marker: false,
        circlemarker: false
      }
    });

    searchMap.addControl(drawControl);

    let savedPolygons = [];

    // Function to generate a preview of a polygon
    function generatePreview(polygon) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 100;
      canvas.height = 100;

      const bounds = polygon.getBounds();
      const latLngs = polygon.getLatLngs()[0];

      const scaleX = canvas.width / (bounds.getEast() - bounds.getWest());
      const scaleY = canvas.height / (bounds.getNorth() - bounds.getSouth());

      ctx.fillStyle = 'rgba(210, 171, 203, 0.3)';
      ctx.beginPath();

      latLngs.forEach((latLng, index) => {
        const x = (latLng.lng - bounds.getWest()) * scaleX;
        const y = (bounds.getNorth() - latLng.lat) * scaleY;
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.closePath();
      ctx.fill();

      return canvas.toDataURL();
    }

    // Function to render saved polygons in the list
    function renderSavedPolygons() {
      const polygonList = document.getElementById("savedPolygonList");
      polygonList.innerHTML = "";

      savedPolygons.forEach((polygon, index) => {
        const listItem = document.createElement("li");
        listItem.classList.add("list-group-item", "d-flex", "align-items-center");
        listItem.style.cursor = "pointer";

        const previewImg = document.createElement("img");
        previewImg.src = polygon.preview;
        previewImg.style.width = "50px";
        previewImg.style.height = "50px";
        previewImg.style.marginRight = "10px";
        previewImg.alt = "Polygon Preview";

        const polygonName = document.createElement("span");
        polygonName.textContent = polygon.name;

        listItem.appendChild(previewImg);
        listItem.appendChild(polygonName);

        // Click event to load the polygon onto the map
        listItem.addEventListener("click", () => loadPolygon(index));

        polygonList.appendChild(listItem);
      });
    }

    // Function to save a polygon
    function savePolygon(name, polygon) {
      const polygonData = {
        name: name,
        coordinates: polygon.getLatLngs(),
        preview: generatePreview(polygon)
      };
      savedPolygons.push(polygonData);
      renderSavedPolygons();
    }



    // Function to load a saved polygon onto the map
    function loadPolygon(index) {
      const polygonData = savedPolygons[index];

      if (drawnPolygon) {
        searchMap.removeLayer(drawnPolygon);
      }

      drawnPolygon = L.polygon(polygonData.coordinates, {
        color: 'purple',
        fillOpacity: 0.3
      }).addTo(searchMap);

      drawnPolygon.on('click', function () {
        new L.EditToolbar.Edit(searchMap, {
          featureGroup: L.featureGroup([drawnPolygon]),
        }).enable();
      });

      searchMap.fitBounds(drawnPolygon.getBounds());
    }

    // Add a custom "Save Polygon" button
    L.Control.SavePolygon = L.Control.extend({
      onAdd: function () {
        var btn = L.DomUtil.create('button', 'save-polygon-button');
        btn.innerHTML = 'Save Polygon';
        btn.classList.add('btn', 'btn-primary', 'p-2');

        L.DomEvent.on(btn, 'click', function () {
          if (drawnPolygon) {
            const polygonName = prompt("Enter a name for this polygon:");
            if (polygonName) {
              savePolygon(polygonName, drawnPolygon);
              alert('Polygon saved successfully!');
            }
          } else {
            alert('No polygon to save! Please draw a polygon first.');
          }
        });

        return btn;
      },
      onRemove: function () {
        // No cleanup needed
      }
    });

    L.control.savePolygon = function (opts) {
      return new L.Control.SavePolygon(opts);
    };

    // Add the "Save Polygon" button to the map
    L.control.savePolygon({ position: 'topleft' }).addTo(searchMap);


    // Handle the creation of new shapes
    searchMap.on('draw:created', function (e) {
      var layer = e.layer;

      // Remove the previous polygon, if any
      if (drawnPolygon) {
        searchMap.removeLayer(drawnPolygon);
      }

      drawnPolygon = layer;
      drawnPolygon.addTo(searchMap);

      drawnPolygon.on('click', function () {
        new L.EditToolbar.Edit(searchMap, {
          featureGroup: L.featureGroup([drawnPolygon]),
        }).enable();
      });

      console.log("Drawn polygon coordinates:", drawnPolygon.toGeoJSON());
    });

    const spatialModal = document.getElementById('spatial-search-modal');
    spatialModal.addEventListener('shown.bs.modal', function () {
      searchMap.invalidateSize();
    });
  </script>


  <script>
    function setCookie(name, value, minutes) {
      var expires = "";
      if (minutes) {
        var date = new Date();
        date.setTime(date.getTime() + (minutes * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function appendClearAllOption() {
      if ($('#clear-all-datasets').length === 0) {
        $('#compare-dataset-options').append(`
        <div class="dropdown-item cursor-pointer text-center text-danger" id="clear-all-datasets" data-dataset-id="__clearall__" onclick="clearAllCompareDatasets()">
        Clear All
        </div>
      `);
      }
    }

    function appendDatasetCompareOption(datasetName, id) {
      $('#compare-dataset-options').append(`
        <div class="dropdown-item d-flex justify-content-between align-items-center" id="compare-dataset-option-${id}">
          ${datasetName} 
          <span class="ms-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger cursor-pointer icon icon-tabler icons-tabler-outline icon-tabler-trash remove-dataset" data-dataset-id="${id}">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M4 7l16 0" />
          <path d="M10 11l0 6" />
          <path d="M14 11l0 6" />
          <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
            </svg>
          </span>
        </div>
          `);
    }

    function refreshDatasetCompareOption(selectedIds) {
      // Remove any options not in selectedIds
      $('#compare-dataset-options .dropdown-item').each(function () {
        var datasetId = $(this).find('.remove-dataset').data('dataset-id');
        if (datasetId && datasetId.toString() === '__clearall__') {
          return;
        }
        if (datasetId && !selectedIds.includes(datasetId.toString())) {
          $(this).remove();
        }
      });

      // Add options for selectedIds
      selectedIds.forEach(function (id) {
        if ($(`#compare-dataset-option-${id}`).length === 0) {
          $.get(`/stelar/api/v2/dataset/${id}`, function (data) {
            appendDatasetCompareOption(data.result.title, id);
          });
        }
      });

      $('#dataset-compare-number').text(`(${selectedIds.length})`);
      appendClearAllOption();
    }

    function clearAllCompareDatasets() {
      setCookie('compare_datasets', '', -1);
      $('#compare-dataset-options').empty();
      $('.comparator-btn').removeClass('btn-success').addClass('btn-outline-success');
      $('#dataset-compare-number').text(`(0)`);
      appendClearAllOption();
    }


    $(document).ready(function () {
      // Mark buttons that are currently in the cookie
      var cookieValue = getCookie('compare_datasets');
      var selectedIds = cookieValue ? cookieValue.split(',') : [];
      selectedIds.forEach(function (id) {
        $('.comparator-btn[data-dataset-id="' + id + '"]').removeClass('btn-outline-success').addClass('btn-success');
      });

      refreshDatasetCompareOption(selectedIds);

      // Handle removal of datasets from the dropdown and cookie
      $(document).on('click', '.remove-dataset', function () {
        var datasetId = $(this).data('dataset-id');
        var cookieValue = getCookie('compare_datasets');
        var selectedIds = cookieValue ? cookieValue.split(',') : [];

        // Remove the dataset ID from the selected IDs
        selectedIds = selectedIds.filter(id => id !== datasetId.toString());
        setCookie('compare_datasets', selectedIds.join(','), 30);
        refreshDatasetCompareOption(selectedIds);
        $(`#compare-dataset-option-${datasetId}`).remove();
        $(`.comparator-btn[data-dataset-id="${datasetId}"]`).removeClass('btn-success').addClass('btn-outline-success');
      });


      $('.comparator-btn').on('click', function () {
        var datasetId = $(this).data('dataset-id');
        if (!datasetId) {
          console.error("Dataset ID not found!");
          return;
        }

        var cookieValue = getCookie('compare_datasets');
        var selectedIds = cookieValue ? cookieValue.split(',') : [];

        // If this dataset is already selected, remove it
        if (selectedIds.indexOf(datasetId.toString()) !== -1) {
          selectedIds = selectedIds.filter(id => id !== datasetId.toString());
          setCookie('compare_datasets', selectedIds.join(','), 30); // Cookie valid for 30 minutes
          $(this).removeClass('btn-success').addClass('btn-outline-success');
          refreshDatasetCompareOption(selectedIds);
        } else {
          // If this dataset isn't already selected, add it
          if (selectedIds.length < 5) {
            selectedIds.push(datasetId);
            setCookie('compare_datasets', selectedIds.join(','), 30);
            $(this).removeClass('btn-outline-success').addClass('btn-success');
            refreshDatasetCompareOption(selectedIds);
            if (selectedIds.length == 2) {
              $('#toast-message-info').removeClass('hide').addClass('show').addClass('fade');
              $('#toast-info-body').html("Looks like you have selected packages for comparison. Compare them <a href='{{url_for('dashboard_blueprint.dataset_compare')}}'>here</a>");
            }
          } else {
            $('#toast-message-alert').removeClass('hide').addClass('show').addClass('fade');
            $('#toast-message-body').text("Max 5 datasets can be compared at a time");
          }
        }
      });
    });
  </script>



  <script>
    $(document).ready(function () {
      const titleInput = $('input[name="package-name-input"]');

      titleInput.on('input', function () {
        titleInput.removeClass('is-valid is-invalid');
      });

      $('#publish-dataset-btn').on('click', function (event) {
        event.preventDefault();

        const title = $('input[name="package-name-input"]').val().trim();
        const notes = $('textarea[name="packageDescription"]').val().trim();
        const tags = $('#hiddenTagsInput').val().split(',').filter(tag => tag.trim() !== '');

        if (!title || !notes || tags.length === 0) {
          $('#new-dataset-modal-footer').prepend('<div class="alert alert-danger p-2 me-auto">Please fill in all fields</div>');
          return;
        }

        const payload = {
          name: slugifyTitle(title),
          title: title,
          notes: notes,
          tags: tags,
          'owner_org': 'stelar-klms',
        };

        $('#new-dataset-modal-footer .alert').remove()
        const loader = '<div class="spinner-border me-auto p-2 spinner-border-sm text-secondary" role="status"></div>'
        $("#new-dataset-modal-footer").prepend(loader)

        $.ajax({
          url: `{{ url_for('catalog_blueprint.api_create_dataset') }} `,
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(payload),
          success: function (response) {
            $('#new-dataset-modal-footer .spinner-border').remove()
            $('#new-dataset-modal-footer').prepend('<div class="alert alert-success p-2 me-auto">Dataset Published</div>');
            setTimeout(function () {
              $('#new-dataset-modal-footer .alert').fadeOut(500, function () {
                $(this).remove();
              });
            }, 3000);
          },
          error: function (xhr) {
            $('#new-dataset-modal-footer .spinner-border').remove()
            $('#new-dataset-modal-footer').prepend('<div class="alert alert-danger p-2 me-auto">Dataset Failed to Publish</div>');
            setTimeout(function () {
              $('#new-dataset-modal-footer .alert').fadeOut(500, function () {
                $(this).remove();
              });
            }, 3000);
          }
        });
      });

    });

    function slugifyTitle(title) {
      return title
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s]/g, '') // Remove any character that is not a letter, number, or space
        .replace(/\s+/g, '_'); // Replace spaces with underscores
    }

    function checkNameAvailability() {
      const titleInput = $('input[name="package-name-input"]');
      const title = titleInput.val().trim();

      if (title === '') {
        return;
      }

      titleInput.removeClass('is-valid is-invalid');

      const loader = '<div class="spinner-border me-auto p-2 spinner-border-sm text-secondary" role="status"></div>'
      $("#availability-div").append(loader)

      $.ajax({
        url: `{{ url_for('catalog_blueprint.api_get_dataset', entity_id = '') }}${slugifyTitle(title)}`,
        method: 'GET',
        success: function (response) {
          // If the response is 200, a dataset already exists
          $('#availability-div .spinner-border').remove()
          titleInput.addClass('is-invalid');
        },
        error: function (xhr) {
          if (xhr.status === 404) {
            // If the response is 404, a dataset doesn't exist
            $('#availability-div .spinner-border').remove()
            titleInput.addClass('is-valid');
          } else {
            $('#availability-div .spinner-border').remove()
          }
        }
      });
    }
  </script>


  <script>
    const tagInput = document.getElementById('tagInput');
    const tagsContainer = document.getElementById('tagsContainer');
    const hiddenTagsInput = document.getElementById('hiddenTagsInput');

    let tags = [];

    function renderTags() {
      tagsContainer.innerHTML = '';

      // Add each tag as a span with a close button
      tags.forEach((tag, index) => {
        const tagElement = document.createElement('span');
        tagElement.classList.add('tag', 'me-2', 'mb-2');

        tagElement.innerHTML = `
            ${tag}
    <a href="#" class="btn-close ms-1" data-index="${index}"></a>
          `;

        // Append the tag element to the container
        tagsContainer.appendChild(tagElement);
      });

      // Add event listeners to each close button
      const closeButtons = document.querySelectorAll('.btn-close');
      closeButtons.forEach(button => {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          const index = button.getAttribute('data-index');
          removeTag(index);
        });
      });

      // Update the hidden input with the current tags as a comma-separated string
      hiddenTagsInput.value = tags.join(',');
    }

    // Function to remove a tag by index
    function removeTag(index) {
      tags.splice(index, 1);
      renderTags();
    }

    // Function to handle input and add tag
    tagInput.addEventListener('keydown', function (event) {
      // If Enter is pressed, add the tag
      if (event.key === 'Enter') {
        event.preventDefault();
        const newTag = tagInput.value.trim();

        if (newTag !== '' && !tags.includes(newTag)) {
          tags.push(newTag);
          tagInput.value = ''; // Clear the input after adding the tag
          renderTags();
        }
      }

      // If backspace is pressed and input is empty, remove the last tag
      if (event.key === 'Backspace' && tagInput.value === '') {
        tags.pop();
        renderTags();
      }
    });
  </script>
</body>

</html>