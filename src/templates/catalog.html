<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>STELAR | Data Catalog</title>
  {% include 'tabler.html' %}
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet PM CSS (for polygon editing) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.css" />

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="{{ url_for('static', filename='images.js') }}"></script>
  <script src="{{ url_for('static', filename='utils.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='stelar.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png">
</head>

<body>
  <div class="page">
    <!-- Navbar -->
    {% include 'header.html' %}
    <div class="page-wrapper">
      <!-- Page header -->
      <div class="page-header d-print-none">
        <div class="container-xl">
          <div class="row g-2 align-items-center">
            <div class="col">
              <!-- Page pre-title -->
              <div class="page-pretitle">
                Data Catalog
              </div>
              <h2 class="page-title">
                Browse & Manage Packages
              </h2>
            </div>
            <div class="col-auto me-2 d-print-none">
              <div class="input-group">

                <button type="button" class="btn btn-outline-primary" id="compare-datasets-button"
                  onclick="window.location.href='{{url_for('dashboard_blueprint.dataset_compare')}}'">Compare Selected
                  <span class="ms-1" id="dataset-compare-number">(0)</span></button>

                <button data-bs-toggle="dropdown" role="button" class="btn btn-outline-primary dropdown-toggle"
                  datas-bs-auto-close="outside"></button>
                <div class="dropdown-menu dropdown-menu-end" id="compare-dataset-options">

                </div>
              </div>
            </div>
            <div class="col-auto ms-auto d-print-none">
              <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-new-dataset">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M12 5l0 14" />
                  <path d="M5 12l14 0" />
                </svg>
                Publish
              </a>
            </div>
          </div>
        </div>
      </div>
      <!-- Page body -->
      <div class="page-body">
        <div class="container-xl">
          <div class="mt-2" style="position: relative;">
            <div class="input-icon">
              <span class="input-icon-addon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path>
                  <path d="M21 21l-6 -6"></path>
                </svg>
              </span>
              <div class="input-group">
                <input type="text" value="" class="form-control query-param mb-0 h3" placeholder="Search for a keyword"
                  id="catalog-search-box" aria-label="Catalog Search" style="height:3.5rem;" autocomplete="off">
                <button class="btn query-param" type="button">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="me-1 icon icon-tabler icons-tabler-outline icon-tabler-search">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                    <path d="M21 21l-6 -6" />
                  </svg>
                  Search</button>
              </div>
            </div>
            <ul id="suggestions-list" class="bg-white list-group"
              style="position:absolute; top:100%; left:0; z-index:1001; display:none; width:100%;">
            </ul>
          </div>
          <div class="badges-list mt-3 mb-0" id="filter-list">
          


          </div>

          <div class="row g-6 mt-3">
            <div class="col-md-3">

              <div class="form-label h3">Spatial Coverage</div>
              <a data-bs-toggle="modal" data-bs-target="#spatial-search-modal" href="#" class="mb-4 card card-link m"
                style="height: 16rem;" id="map">

              </a>
              <div class="form-label h3">Temporal Coverage</div>
              <div class="mb-0 p-1" style="max-height: 16.5rem; overflow: auto;" id="facet-temporal">
                <div>
                  <div class="mb-1">
                    <label for="start-datetime" class="form-label">Start Time</label>
                    <input type="datetime-local" id="start-datetime" class="form-control query-param"
                      onchange="updateChart()">
                  </div>
                  <div>
                    <label for="end-datetime" class="form-label">End Time</label>
                    <input type="datetime-local" id="end-datetime" class="form-control query-param"
                      onchange="updateChart()">
                  </div>
                  <div class="mt-2" id="temporal-chart"></div>
                </div>
              </div>
              <hr class="mt-0">
              <div class="form-label h3">Tags</div>
              <div class="mb-1 p-1" style="max-height: 16.5rem; overflow: auto;" id="facet-tags">

                <div class="placeholder-glow">
                  {% for i in range(0, 7) %}
                  <label class="form-check tag-item">
                    <div class="placeholder placeholder-xs col-3 m-0"></div>
                  </label>
                  {% endfor %}
                </div>
              </div>
              <hr>
              <div class="form-label h3">Resource Format</div>
              <div class="mb-1 p-1" style="max-height: 16.5rem; overflow: auto;" id="facet-format">
                <div class="placeholder-glow">
                  {% for i in range(0, 7) %}
                  <label class="form-check tag-item">
                    <div class="placeholder placeholder-xs col-3 m-0"></div>
                  </label>
                  {% endfor %}
                </div>
              </div>
              <hr>
              <div class="form-label h3">Creator</div>
              <div class="mb-1 p-1" style="max-height: 16.5rem; overflow: auto;" id="facet-author">
                <div class="placeholder-glow">
                  {% for i in range(0, 7) %}
                  <label class="form-check tag-item">
                    <div class="placeholder placeholder-xs col-3 m-0"></div>
                  </label>
                  {% endfor %}
                </div>
              </div>
              <hr>
              <div class="form-label h3">Owner Organization</div>
              <div class="mb-1 p-1" style="max-height: 16.5rem; overflow: auto;" id="facet-organization">
                <div class="placeholder-glow">
                  {% for i in range(0, 7) %}
                  <label class="form-check tag-item">
                    <div class="placeholder placeholder-xs col-3 m-0"></div>
                  </label>
                  {% endfor %}
                </div>
              </div>
              <div class="mt-5">
                <button class="btn btn-primary w-100 query-param" onclick="window.location.reload()">
                Apply filters
                </button>
                <a class="btn btn-link w-100 query-param" onclick="resetCheckedFilters()">
                  Reset to defaults
                </a>
              </div>
            </div>
            <div class="col-md-9 mt-3">

              <ul class="pagination d-flex justify-content-end mb-5">
                <span class="m-1 ms-auto me-2 h3">Sort By:</span>
                <select name="result-sort" class="form-select w-25 h-25 query-param" id="result-sort">
                  <option value="metadata_modified desc" {% if search_q.get('sort', 'metadata_modified desc'
                    )=='metadata_modified desc' %}selected="selected" {% endif %}>Latest</option>
                  <option value="metadata_modified asc" {% if search_q.get('sort')=='metadata_modified asc'
                    %}selected="selected" {% endif %}>Oldest</option>
                  <option value="score desc" {% if search_q.get('sort')=='score desc' %}selected="selected" {% endif %}>
                    Most Relevant</option>
                  <option value="name asc" {% if search_q.get('sort')=='name asc' %}selected="selected" {% endif %}>Name
                    A-Z</option>
                </select>
              </ul>

              <div class="row row-cards" id="package-list">

                {% for i in range(0, 9) %}
                <div class="card card-link m-0 placeholder-glow cursor-pointer disabled mb-3">
                  <div class="row g-0">
                    <div class="col-auto">
                      <div class="card-body">
                        <div class="placeholder avatar avatar-md">

                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card-body ps-0">
                        <div class="row">
                          <div class="col-md-11">
                            <h3 class="mb-0">
                              <div class="placeholder col-4"></div>
                              <span class="placeholder col-2 ms-2"></span>
                            </h3>
                            <p class="text-secondary placeholder placeholder-xs col-9 mt-3"></p>
                          </div>
                          <div class="col-md-1 d-flex justify-content-end">
                            <button
                              class="btn placeholder btn-pill btn-outline-success m-3 me-1 p-1 text-center comparator-btn align-self-center"
                              data-dataset-id="" title="Add to comparison">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round"
                                class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-git-compare">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M6 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M11 6h5a2 2 0 0 1 2 2v8"></path>
                                <path d="M14 9l-3 -3l3 -3"></path>
                                <path d="M13 18h-5a2 2 0 0 1 -2 -2v-8"></path>
                                <path d="M10 15l3 3l-3 3"></path>
                              </svg>
                            </button>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md">
                            <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                              <div class="list-inline-item placeholder col-2">

                              </div>
                              <div class="list-inline-item placeholder col-3">
                              </div>
                              <div class="list-inline-item placeholder col-2">
                              </div>
                            </div>
                          </div>
                          <div class="col-md-auto">
                            <div class="mt-3 badges">
                              <span class="tag m-1 mb-0 placeholder">
                                STELAR
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              <ul class="pagination d-flex justify-content-end mb-5">
                <div class="text-secondary" id="pagination-info">
                </div>
                <div class="ms-auto" id="pagination-control">

                </div>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal modal-blur fade" id="spatial-search-modal" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog me-6 ms-6 mt-2 modal-full-width modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Spatial Search </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">

                <div class="row">
                  <div class="col-lg-2">
                    <div class="h3">Saved Polygons</div>
                    <p class="text-secondary text-sm ">Here you may find any saved polygons in the STELAR KLMS, used
                      in
                      previous searches.</p>
                    <ul id="savedPolygonList" class="list-group">

                    </ul>
                  </div>
                  <div class="col-lg-10">
                    <div class="h3 ms-4">Interactive Map</div>
                    <p class="ms-4 text-sm text-secondary">Use the drawing toolbox below to define an area on the map.
                      A
                      search will be performed on the available datasets to find results lying within the marked area.
                    </p>
                    <div id="search-map" class="m-4 card card-link m" style="height: 60vh">



                    </div>
                    <p class="ms-4 text-sm text-secondary">Only one polygon can be used in a search query. Make sure
                      your polygon is convex for optimal results.</p>
                  </div>
                </div>

              </div>
              <div class="modal-footer" id="spatial-search-modal-footer">
                <a href="#" class="btn btn-primary ms-auto" data-bs-dismiss="modal">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-search">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                    <path d="M21 21l-6 -6" />
                  </svg>
                  Search
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div class="toast fade hide" role="alert" id="toast-message-alert" aria-live="assertive" aria-atomic="true"
            data-bs-autohide="false">
            <div class="toast-header">
              <strong class="me-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                  class="me-2 text-primary icon icon-tabler icons-tabler-filled icon-tabler-alert-square-rounded">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M12 2l.642 .005l.616 .017l.299 .013l.579 .034l.553 .046c4.687 .455 6.65 2.333 7.166 6.906l.03 .29l.046 .553l.041 .727l.006 .15l.017 .617l.005 .642l-.005 .642l-.017 .616l-.013 .299l-.034 .579l-.046 .553c-.455 4.687 -2.333 6.65 -6.906 7.166l-.29 .03l-.553 .046l-.727 .041l-.15 .006l-.617 .017l-.642 .005l-.642 -.005l-.616 -.017l-.299 -.013l-.579 -.034l-.553 -.046c-4.687 -.455 -6.65 -2.333 -7.166 -6.906l-.03 -.29l-.046 -.553l-.041 -.727l-.006 -.15l-.017 -.617l-.004 -.318v-.648l.004 -.318l.017 -.616l.013 -.299l.034 -.579l.046 -.553c.455 -4.687 2.333 -6.65 6.906 -7.166l.29 -.03l.553 -.046l.727 -.041l.15 -.006l.617 -.017c.21 -.003 .424 -.005 .642 -.005zm.01 13l-.127 .007a1 1 0 0 0 0 1.986l.117 .007l.127 -.007a1 1 0 0 0 0 -1.986l-.117 -.007zm-.01 -8a1 1 0 0 0 -.993 .883l-.007 .117v4l.007 .117a1 1 0 0 0 1.986 0l.007 -.117v-4l-.007 -.117a1 1 0 0 0 -.993 -.883z" />
                </svg>System Alert</strong>
              <small>Just now</small>
              <button type="button" class="ms-2 btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message-body">
              Message not available
            </div>
          </div>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div class="toast fade hide" role="alert" id="toast-message-info" aria-live="assertive" aria-atomic="true"
            data-bs-autohide="false">
            <div class="toast-header">
              <strong class="me-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                  class="me-2 text-primary icon icon-tabler icons-tabler-filled icon-tabler-bulb">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M4 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z" />
                  <path
                    d="M12 2a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z" />
                  <path d="M21 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z" />
                  <path
                    d="M4.893 4.893a1 1 0 0 1 1.32 -.083l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 0 -1.414z" />
                  <path
                    d="M17.693 4.893a1 1 0 0 1 1.497 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7z" />
                  <path d="M14 18a1 1 0 0 1 1 1a3 3 0 0 1 -6 0a1 1 0 0 1 .883 -.993l.117 -.007h4z" />
                  <path
                    d="M12 6a6 6 0 0 1 3.6 10.8a1 1 0 0 1 -.471 .192l-.129 .008h-6a1 1 0 0 1 -.6 -.2a6 6 0 0 1 3.6 -10.8z" />
                </svg>System Info</strong>
              <small>Just now</small>
              <button type="button" class="ms-2 btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-info-body">
              Message not available
            </div>
          </div>
        </div>
        <div class="modal modal-blur fade" id="modal-new-dataset" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
              <form>
                <div class="modal-header">
                  <h5 class="modal-title">New Dataset</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="mb-0">
                      <label class="form-label">Title</label>
                      <div class="row g-2">
                        <div class="col">
                          <input type="text" class="form-control" name="package-name-input" placeholder="Dataset Title"
                            required>
                        </div>
                        <small class="form-hint">
                          <p>
                            A name in the format <code>the-new-dataset</code> (hyphens
                            instead of spaces) will be generated for the dataset. The name of
                            the dataset is one the identifiers of it, therefore it must be unique.
                          </p>
                        </small>
                      </div>
                    </div>
                    <div class="d-flex">
                      <div class="text-secondary ms-auto justify-content-right" id="availability-div">
                        <a onclick="checkNameAvailability()" class="text-sm p-2 cursor-pointer link-secondary"
                          title="Check Title Availability" data-bs-toggle="tooltip" tabindex="-1">
                          Check title availability
                        </a>
                      </div>
                    </div>
                    <div>
                      <label class="form-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                          stroke-linejoin="round"
                          class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-building-bank">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M3 21l18 0" />
                          <path d="M3 10l18 0" />
                          <path d="M5 6l7 -3l7 3" />
                          <path d="M4 10l0 11" />
                          <path d="M20 10l0 11" />
                          <path d="M8 14l0 3" />
                          <path d="M12 14l0 3" />
                          <path d="M16 14l0 3" />
                        </svg>Owner Organization</label>
                      <select class="form-select" id="owner-org" name="owner_org">

                      </select>
                      <small class="form-hint">
                        <p>
                          Creating a new dataset in an organization requires you to have
                          the permission to do so assigned by an administrator.
                        </p>
                      </small>
                    </div>
                    <div class="mt-1">
                      <label class="form-label">Visibility</label>
                      <div class="form-selectgroup-boxes row mb-1">
                          <div class="col-lg-6 text-success">
                              <label class="form-selectgroup-item">
                                  <input type="radio" name="package-visibility" value="public"
                                      class="form-selectgroup-input" checked="">
                                  <span class="form-selectgroup-label d-flex align-items-center p-3">
                                      <span class="me-3">
                                          <span class="form-selectgroup-check"></span>
                                      </span>
                                      <span class="form-selectgroup-label-content">
                                          <span class="form-selectgroup-title strong mb-1">Public</span>
                                          <span class="d-block text-secondary">Accessible to all users
                                              registered in the KLMS</span>
                                      </span>
                                  </span>
                              </label>
                          </div>
                          <div class="col-lg-6 text-danger">
                              <label class="form-selectgroup-item">
                                  <input type="radio" name="package-visibility" value="private"
                                      class="form-selectgroup-input">
                                  <span class="form-selectgroup-label d-flex align-items-center p-3">
                                      <span class="me-3">
                                          <span class="form-selectgroup-check"></span>
                                      </span>
                                      <span class="form-selectgroup-label-content">
                                          <span class="form-selectgroup-title strong mb-1">Private</span>
                                          <span class="d-block text-secondary">Accessible only to members
                                              of the organization that
                                              owns the package</span>
                                      </span>
                                  </span>
                              </label>
                          </div>
                      </div>
                  </div>
                  </div>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="packageDescription" class="form-control" rows="3" required
                          placeholder="A nice informative description"></textarea>
                      </div>
                    </div>
                    <small class="form-hint">
                      <p>
                        After the dataset is published, you will be able to add resources and 
                        manage every additional attribute of it (Spatial Coverage, Temporal Coverage, Extra Metadata, etc.)
                      </p>
                    </small>
                    <input type="hidden" name="packageTags" id="hiddenTagsInput" name="tags" />
                    <div class="col-lg-12">
                      <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" id="tagInput" class="form-control" placeholder="Type a tag and press enter"
                          required>
                        <div class="col tags-list mt-3" id="tagsContainer">
                          <!-- Tags will be dynamically added here -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer" id="new-dataset-modal-footer">
                  <a class="cursor-pointer btn btn-primary ms-auto" id="publish-dataset-btn" onclick="publishDataset()" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M12 5l0 14" />
                      <path d="M5 12l14 0" />
                    </svg>
                    Publish Dataset
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% include 'footer.html'%}
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <!-- Preview Map -->
  <script>
    var map = L.map('map', {
      center: [47.57536996623514, 8.261718750000002],
      zoom: 3,
      zoomControl: false,
      maxZoom: 3,
      minZoom: 3,
      scrollWheelZoom: false,
      dragging: false
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

  </script>


  <script>
    $(document).ready(function () {
      var selectedIndex = -1;
      var suggestions = [];

      $('#catalog-search-box').on('input', function () {
        var query = $(this).val();
        if (query.length >= 2) {
          $.ajax({
            url: `{{url_for('pub_blueprint.autocomplete_datasets', limit=10, query='')}}` + encodeURIComponent(query),
            method: 'POST',
            dataType: 'json',
            success: function (response) {
              if (response.success) {
                suggestions = response.result;
                var html = "";
                suggestions.forEach(function (item, index) {
                  html += '<li class="list-group-item suggestion-item" data-name="' + item.name + '" style="cursor:pointer;">' +
                    '<strong>' + item.title + '</strong> - <small><code>' + item.name + '</code></small>' +
                    '</li>';
                });
                $('#suggestions-list').html(html).show();
                selectedIndex = -1;
              }
            }
          });
        } else {
          $('#suggestions-list').hide();
        }
      });

      $('#catalog-search-box').on('keydown', function (e) {
        var items = $('#suggestions-list li');
        if (items.length === 0) return;
        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedIndex = (selectedIndex + 1) % items.length;
          items.removeClass('active');
          $(items[selectedIndex]).addClass('active');
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedIndex = (selectedIndex - 1 + items.length) % items.length;
          items.removeClass('active');
          $(items[selectedIndex]).addClass('active');
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (selectedIndex > -1) {
            var selectedItem = $(items[selectedIndex]);
            var name = selectedItem.data('name');
            window.location.href = `{{url_for('dashboard_blueprint.dataset_detail', dataset_id='')}}` + encodeURIComponent(name);
          }
        }
      });

      // Click selection of suggestion
      $(document).on('click', '.suggestion-item', function () {
        var name = $(this).data('name');
        window.location.href = `{{url_for('dashboard_blueprint.dataset_detail', dataset_id='')}}` + encodeURIComponent(name);
      });

      // Hide suggestions on blur after slight delay
      $('#catalog-search-box').on('blur', function () {
        setTimeout(function () {
          $('#suggestions-list').hide();
        }, 100);
      });
    });
  </script>

  <!-- Datepickers -->
  <script>
    var startDate = new Date(document.getElementById('start-datetime').value).getTime();
    var endDate = new Date(document.getElementById('end-datetime').value).getTime();

    var options = {
      series: [{
        data: [{
          x: 'Date Range',
          y: [startDate, endDate]
        }]
      }],
      chart: {
        height: 100,
        type: 'rangeBar',
        zoom: {
          enabled: true
        }
      },
      colors: ['#3f1757'],
      plotOptions: {
        bar: {
          horizontal: true
        }
      },
      xaxis: {
        type: 'datetime'
      },
      grid: {
        xaxis: {
          lines: {
            show: true
          }
        },
        yaxis: {
          lines: {
            show: false
          }
        }
      }
    };

    var chart = new ApexCharts(document.querySelector("#temporal-chart"), options);
    chart.render();

    function updateChart() {
      startDate = new Date(document.getElementById('start-datetime').value).getTime();
      endDate = new Date(document.getElementById('end-datetime').value).getTime();
      chart.updateSeries([{
        data: [{
          x: 'Date Range',
          y: [startDate, endDate]
        }]
      }]);
    }
  </script>


  <!-- Search Script -->
  <script>
    query = {
      "q": "",
      "sort": "{{ search_q.sort }}",
      "fl": [
        "id",
        "title",
        "notes",
        "author",
        "organization",
        "tags",
        "metadata_modified",
        "capacity",
        "type"
      ],
      "fq": [{% for filter in search_q.fq %}"{{ filter }}"{% if not loop.last %}, {% endif %}{% endfor %}],
      "limit": 10,
      "offset": 0,
      "facet": {
        "fields": [
          "tags",
          "author",
          "organization",
          "res_format",
        ]
      }
    };

    function performSearch(query, rebuildFacets = true) {
      lockQueryParams();
      $.ajax({
        url: "{{url_for('catalog_blueprint.api_search_datasets')}}",
        type: "POST",
        data: JSON.stringify(query),
        contentType: "application/json",
        success: function (response) {
          unlockQueryParams();
          if (response.success) {
            if (response.result.facets) {
              if (rebuildFacets) {
                $('#facet-tags').empty();
                $('#facet-author').empty();
                $('#facet-organization').empty();
                $('#facet-format').empty();
                if (!window.facets || window.facets.length === 0) {
                    buildFacets(response.result.facets);               
                }
              }
              buildPackageCards(response.result.results); // pass orgData if needed
              attachComparatorButtonListeners();
              renderSelectedComparators();
            }
            if (response.result.count !== undefined) {
              buildPagination(response.result.count);
            }
          } else {
            console.error("Search failed:", response.message);
          }
        },
        error: function (xhr, status, error) {
          unlockQueryParams();
          console.error("AJAX request failed:", error);
        }
      });
    }

    function buildPagination(total) {
      var currentPage = Math.floor(query.offset / query.limit) + 1;
      var totalPages = Math.ceil(total / query.limit);
      var paginationHtml = '';

      // Previous button
      if (currentPage > 1) {
        paginationHtml += '<li class="page-item"><a class="page-link pagination-link" href="#" data-page="' + (currentPage - 1) + '"> prev </a></li>';
      } else {
        paginationHtml += '<li class="page-item disabled"><span class="page-link"> prev </span></li>';
      }

      // Page numbers
      for (var i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
          paginationHtml += '<li class="page-item active"><span class="page-link">' + i + '</span></li>';
        } else {
          paginationHtml += '<li class="page-item"><a class="page-link pagination-link" href="#" data-page="' + i + '">' + i + '</a></li>';
        }
      }

      // Next button
      if (currentPage < totalPages) {
        paginationHtml += '<li class="page-item"><a class="page-link pagination-link" href="#" data-page="' + (currentPage + 1) + '"> next </a></li>';
      } else {
        paginationHtml += '<li class="page-item disabled"><span class="page-link"> next </span></li>';
      }

      $('#pagination-control').html('<ul class="pagination mb-0">' + paginationHtml + '</ul>');

      // Update pagination info e.g., "Showing 1 to 10 of 53 results"
      var startResult = query.offset + 1;
      var endResult = Math.min(query.offset + query.limit, total);
      $('#pagination-info').html('<span class="h3">Showing ' + startResult + ' to ' + endResult + ' of ' + total + ' results</span>');

      // Add click listeners for pagination links
      $('.pagination-link').off('click').on('click', function (e) {

        var page = parseInt($(this).data('page'));
        query.offset = (page - 1) * query.limit;
        maskWithPlaceholders();
        performSearch(query, false);
      });
    }

    function lockQueryParams() {
      $('.query-param').prop('disabled', true);
    }

    function unlockQueryParams() {
      $('.query-param').prop('disabled', false);
    }

    function buildPlaceholder() {
      return `<div class="card card-link m-0 placeholder-glow cursor-pointer disabled mb-3">
                  <div class="row g-0">
                    <div class="col-auto">
                      <div class="card-body">
                        <div class="placeholder avatar avatar-md">

                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card-body ps-0">
                        <div class="row">
                          <div class="col-md-11">
                            <h3 class="mb-0">
                              <div class="placeholder col-4"></div>
                              <span class="placeholder col-2 ms-2"></span>
                            </h3>
                            <p class="text-secondary placeholder placeholder-xs col-9 mt-3"></p>
                          </div>
                          <div class="col-md-1 d-flex justify-content-end">
                            <button
                              class="btn placeholder btn-pill btn-outline-success m-3 me-1 p-1 text-center align-self-center"
                              data-dataset-id="" title="Add to comparison">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round"
                                class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-git-compare">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M6 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M11 6h5a2 2 0 0 1 2 2v8"></path>
                                <path d="M14 9l-3 -3l3 -3"></path>
                                <path d="M13 18h-5a2 2 0 0 1 -2 -2v-8"></path>
                                <path d="M10 15l3 3l-3 3"></path>
                              </svg>
                            </button>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md">
                            <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                              <div class="list-inline-item placeholder col-2">

                              </div>
                              <div class="list-inline-item placeholder col-3">
                              </div>
                              <div class="list-inline-item placeholder col-2">
                              </div>
                            </div>
                          </div>
                          <div class="col-md-auto">
                            <div class="mt-3 badges">
                              <span class="tag m-1 mb-0 placeholder">
                                STELAR
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>`;
    }


    function removeFilterFromLocation(type, filter) {
      var url = new URL(window.location);
      var param;
      if (type === "tags") {
        param = "tags";
      } else if (type === "res_format") {
        param = "res_format";
      } else if (type === "organization") {
        param = "org";
      } else if (type === "author") {
        param = "author";
      } else {
        param = type;
      }

      var current = url.searchParams.get(param);
      if (current) {
        var filters = current.split(",");
        var index = filters.indexOf(filter);
        if (index !== -1) {
          filters.splice(index, 1);
          if (filters.length) {
            url.searchParams.set(param, filters.join(","));
          } else {
            url.searchParams.delete(param);
          }
        }
      }
      window.history.pushState({}, "", url.toString());
    }

    function removeAllFiltersFromLocation() {
      var url = new URL(window.location);
      // Remove all related filters
      url.searchParams.delete("tags");
      url.searchParams.delete("res_format");
      url.searchParams.delete("org"); // organization
      url.searchParams.delete("author");
      window.history.pushState({}, "", url.toString());
      $('#filter-list').empty();
    }

    function appendFilterToLocation(type, filter) {
      var url = new URL(window.location);
      var param;
      if (type === "tags") {
        param = "tags";
      } else if (type === "res_format") {
        param = "res_format";
      } else if (type === "organization") {
        param = "org";
      } else if (type === "author") {
        param = "author";
      } else {
        param = type;
      }
      var current = url.searchParams.get(param);
      if (current) {
        var filters = current.split(",");
        if (filters.indexOf(filter) === -1) {
          filters.push(filter);
          url.searchParams.set(param, filters.join(","));
        }
      } else {
        url.searchParams.set(param, filter);
      }
      window.history.pushState({}, "", url.toString());
    }

    function appendFilterBadge(type, filter) {

      var filterHtml = `<span class="badge bg-secondary text-white me-1" id="filter-${type}-${filter}">
        ${filter}
        <button type="button" class="btn-close btn-close-white btn-close-sm" aria-label="Close"></button>
      </span>`;
      $('#filter-list').append(filterHtml);
    }

    function removeFilterBadge(type, filter) {
      $(`#filter-${type}-${filter}`).remove();
    }

    function maskWithPlaceholders() {
      var packageList = $('#package-list');
      packageList.empty();
      for (var i = 0; i < 9; i++) {
        packageList.append(buildPlaceholder());
      }
    }

    function resortResults() {
      var sortValue = $('#result-sort').val();
      var url = new URL(window.location);
      url.searchParams.set("sort", sortValue);
      window.history.pushState({}, '', url.toString());
      maskWithPlaceholders();
      query.sort = sortValue;
      performSearch(query, false);
    }

    $('#result-sort').on('change', function () {
      resortResults();
    });

    function buildPackageCard(pkg) {
      return `<div class="card card-link m-0 disabled mb-3">
        <div class="row g-0">
          <div class="col-auto">
            <div class="card-body">
              <div class="avatar avatar-md bg-white mt-1">
                ${orgs[pkg.organization] && orgs[pkg.organization].image_url && orgs[pkg.organization].image_url !== ''
          ? `<img src="${orgs[pkg.organization].image_url}" />`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                           fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                           stroke-linejoin="round"
                           class="text-secondary icon icon-tabler icons-tabler-outline icon-tabler-building-bank">
                           <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                           <path d="M3 21l18 0" />
                           <path d="M3 10l18 0" />
                           <path d="M5 6l7 -3l7 3" />
                           <path d="M4 10l0 11" />
                           <path d="M20 10l0 11" />
                           <path d="M8 14l0 3" />
                           <path d="M12 14l0 3" />
                           <path d="M16 14l0 3" />
                         </svg>`}
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card-body ps-0">
              <div class="row">
                <div class="col-md-11">
                  <h3 class="mb-0">
                    <a href="{{url_for('dashboard_blueprint.dataset_detail', dataset_id='')}}${pkg.id}">${pkg.title || 'Untitled Package'}</a>
                    ${pkg.type === 'workflow'
          ? '<span class="badge bg-purple-lt ms-2">WORKFLOW</span>'
          : pkg.type === 'dataset'
            ? '<span class="badge bg-blue-lt ms-2">DATASET</span>'
            : pkg.type === 'process'
              ? '<span class="badge bg-yellow-lt ms-2">PROCESS</span>'
              : ''}
                    <span class = "text-secondary h4 ms-2">
                       ${pkg.capacity ? pkg.capacity.charAt(0).toUpperCase() + pkg.capacity.slice(1) : ''}
                    </span>
                  </h3>
                  <p class="text-secondary mt-1">${pkg.notes || 'No description specified'}</p>
                </div>
                <div class="col-md-1 d-flex justify-content-end">
                  <button class="btn btn-pill btn-outline-success m-3 me-1 p-1 text-center comparator-btn align-self-center"
                          data-dataset-id="${pkg.id}" title="Add to comparison">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round"
                         class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-git-compare">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M6 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                      <path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                      <path d="M11 6h5a2 2 0 0 1 2 2v8" />
                      <path d="M14 9l-3 -3l3 -3" />
                      <path d="M13 18h-5a2 2 0 0 1 -2 -2v-8" />
                      <path d="M10 15l3 3l-3 3" />
                    </svg>
                  </button>
                </div>
              </div>
              <div class="row">
                <div class="col-md">
                  <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                    <div class="list-inline-item">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           class="icon icon-tabler icon-tabler-building-bank" width="44" height="44"
                           viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                           stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M3 21l18 0" />
                        <path d="M3 10l18 0" />
                        <path d="M5 6l7 -3l7 3" />
                        <path d="M4 10l0 11" />
                        <path d="M20 10l0 11" />
                        <path d="M8 14l0 3" />
                        <path d="M12 14l0 3" />
                        <path d="M16 14l0 3" />
                      </svg>
                      <a class="text-secondary" target="_blank" href="{{ url_for('dashboard_blueprint.organization', organization_id='') }}${orgs[pkg.organization] ? orgs[pkg.organization].id : ''}">
                        ${orgs[pkg.organization] ? orgs[pkg.organization].title : ''}
                      </a>
                    </div>
                    <div class="list-inline-item">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-bolt">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M13.5 21h-7.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5" />
                        <path d="M16 3v4" />
                        <path d="M8 3v4" />
                        <path d="M4 11h16" />
                        <path d="M19 16l-2 3h4l-2 3" />
                      </svg>
                      ${formatIsoDate(pkg.metadata_modified)}
                    </div>
                    <div class="list-inline-item">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                           fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                           stroke-linejoin="round"
                           class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                        <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                      </svg>
                      ${pkg.author || 'Not specified'}
                    </div>
                  </div>
                </div>
                <div class="col-md-auto">
                  <div class="mt-3 badges">
                    ${pkg.tags && pkg.tags.length ? pkg.tags.map(tag => `<a class="card-link text-black tag m-1 mb-0" href="{{ url_for('dashboard_blueprint.catalog') }}?sort=metadata_modified+desc&tags=${encodeURIComponent(tag)}">${tag}</a>`).join('') : ''}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>`;
    }

    function buildPackageCards(packages) {
      if (packages) {
        $("#package-list").html("");
        packages.forEach(pkg => {
          $("#package-list").append(buildPackageCard(pkg));
        });
      }
    }

    function buildFacet(facet, count, value, display) {
      if (facet) {
        if (display) {
          return `<label class="form-check tag-item">
              <input type="checkbox" class="form-check-input query-param" name="form-type[]" value="${facet}">
              <div class="d-flex">
                <span class="form-check-label">${facet}</span>
                <span class="badge ms-auto text-light-fg ms-2">${count}</span>
              </div>
            </label>`;
        } else {
          return `<label class="form-check tag-item more-tag query-param" style="display: none;">
              <input type="checkbox" class="form-check-input" name="form-type[]" value="${facet}">
              <div class="d-flex">
                <span class="form-check-label">${facet}</span>
                <span class="badge ms-auto text-light-fg ms-2">${count}</span>
              </div>
            </label>`;
        }
      }
    }

    function createShowAllFacetButton(facet, facetContainerId) {
      return `<a class="toggle-facet-btn me-1 mb-1 cursor-pointer" data-expanded="false" onclick="
          var container = document.getElementById('${facetContainerId}');
          var moreTags = container.querySelectorAll('.more-tag');
          var btn = this;
          if (btn.getAttribute('data-expanded') === 'true') {
            moreTags.forEach(el => el.style.display = 'none');
            btn.innerHTML = 'Show All <svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;24&quot; height=&quot;24&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; class=&quot;me-2 icon icon-tabler icons-tabler-outline icon-tabler-chevron-down&quot;><path stroke=&quot;none&quot; d=&quot;M0 0h24v24H0z&quot; fill=&quot;none&quot;/><path d=&quot;M6 9l6 6l6 -6&quot; /></svg>';
            btn.setAttribute('data-expanded','false');
          } else {
            moreTags.forEach(el => el.style.display = 'block');
            btn.innerHTML = 'Show Less <svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;24&quot; height=&quot;24&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; class=&quot;me-2 icon icon-tabler icons-tabler-outline icon-tabler-chevron-up&quot;><path stroke=&quot;none&quot; d=&quot;M0 0h24v24H0z&quot; fill=&quot;none&quot;/><path d=&quot;M6 15l6 -6l6 6&quot; /></svg>';
            btn.setAttribute('data-expanded','true');
          }
        ">
        Show All
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-chevron-down">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M6 9l6 6l6 -6" />
        </svg>
        </a>`;
    }

    function resetCheckedFilters() {
      $('#facet-tags input[type="checkbox"]').prop('checked', false);
      $('#facet-author input[type="checkbox"]').prop('checked', false);
      $('#facet-organization input[type="checkbox"]').prop('checked', false);
      $('#facet-format input[type="checkbox"]').prop('checked', false);
      removeAllFiltersFromLocation();
    }

    function buildFacets(facets) {
      if (facets) {
        // The facets are stored in the global variable
        // so that way even if the query limits the number of results
        // the entirety of facets are still available for the user to filter
        window.facets = facets;
        for (const [key, value] of Object.entries(facets)) {
          if (key == "tags") {
            const entries = Object.entries(value);
            $("#facet-tags").html("");
            let i = 0;
            for (const [tag, count] of entries) {
              var facetElement = $(buildFacet(tag, count, key, i < 8));
              facetElement.find('input').on('change', function () {
                var val = $(this).val();
                if ($(this).is(':checked')) {
                  console.log("tick: " + val);
                  appendFilterBadge(key, val);
                  appendFilterToLocation(key, val);
                } else {
                  console.log("untick: " + val);
                  removeFilterBadge(key, val);
                  removeFilterFromLocation(key, val);
                }
              });
              $("#facet-tags").append(facetElement);
              i++;
            }
            if (entries.length > 8) {
              $("#facet-tags").after(createShowAllFacetButton(key, "facet-tags"));
            }
          } else if (key == "author") {
            const entries = Object.entries(value);
            $("#facet-author").html("");
            let i = 0;
            for (const [author, count] of entries) {
              var facetElement = $(buildFacet(author, count, key, i < 8));
              facetElement.find('input').on('change', function () {
                var val = $(this).val();
                if ($(this).is(':checked')) {
                  console.log("tick: " + val);
                  appendFilterBadge(key, val);
                  appendFilterToLocation(key, val);
                } else {
                  console.log("untick: " + val);
                  removeFilterBadge(key, val);
                  removeFilterFromLocation(key, val);
                }
              });
              $("#facet-author").append(facetElement);
              i++;
            }
            if (entries.length > 8) {
              $("#facet-author").after(createShowAllFacetButton(key, "facet-author"));
            }
          } else if (key == "organization") {
            const entries = Object.entries(value);
            $("#facet-organization").html("");
            let i = 0;
            for (const [organization, count] of entries) {
              var facetElement = $(buildFacet(organization, count, key, i < 8));
              facetElement.find('input').on('change', function () {
                var val = $(this).val();
                if ($(this).is(':checked')) {
                  console.log("tick: " + val);
                  appendFilterBadge(key, val);
                  appendFilterToLocation(key, val);
                } else {
                  console.log("untick: " + val);
                  removeFilterBadge(key, val);
                  removeFilterFromLocation(key, val);
                }
              });
              $("#facet-organization").append(facetElement);
              i++;
            }
            if (entries.length > 8) {
              $("#facet-organization").after(createShowAllFacetButton(key, "facet-organization"));
            }
          } else if (key == "res_format") {
            const entries = Object.entries(value);
            $("#facet-format").html("");
            let i = 0;
            for (const [format, count] of entries) {
              var facetElement = $(buildFacet(format, count, key, i < 8));
              facetElement.find('input').on('change', function () {
                var val = $(this).val();
                if ($(this).is(':checked')) {
                  console.log("tick: " + val);
                  appendFilterBadge(key, val);
                  appendFilterToLocation(key, val);
                } else {
                  console.log("untick: " + val);
                  removeFilterBadge(key, val);
                  removeFilterFromLocation(key, val);
                }
              });
              $("#facet-format").append(facetElement);
              i++;
            }
            if (entries.length > 8) {
              $("#facet-format").after(createShowAllFacetButton(key, "facet-format"));
            }
          }
        }
      }
    }
    $(document).ready(function () {
      // Call fetchOrganizations and run performSearch only after its completion.
      fetchOrganizations(function () {
        performSearch(query);
      });
    });

  </script>


  <!-- Spatial Modal Map -->
  <script>
    // Initialize the map
    var searchMap = L.map('search-map', {
      center: [38.6137, 24.6116],
      zoom: 3,
    });

    // Base layers
    var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });

    var topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    });

    // Add the default layer to the map
    streetLayer.addTo(searchMap);

    // Layer control
    var baseLayers = {
      "Street Map": streetLayer,
      "Topographical Map": topoLayer
    };

    L.control.layers(baseLayers).addTo(searchMap);

    // Feature Group to store the single drawn polygon
    var drawnPolygon = null;

    // Add drawing controls
    var drawControl = new L.Control.Draw({
      edit: false, // Disable bulk editing
      draw: {

        polygon: false,
        polyline: false,
        rectangle: true,
        circle: false,
        marker: false,
        circlemarker: false
      }
    });

    searchMap.addControl(drawControl);

    let savedPolygons = [];

    // Function to generate a preview of a polygon
    function generatePreview(polygon) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 100;
      canvas.height = 100;

      const bounds = polygon.getBounds();
      const latLngs = polygon.getLatLngs()[0];

      const scaleX = canvas.width / (bounds.getEast() - bounds.getWest());
      const scaleY = canvas.height / (bounds.getNorth() - bounds.getSouth());

      ctx.fillStyle = 'rgba(210, 171, 203, 0.3)';
      ctx.beginPath();

      latLngs.forEach((latLng, index) => {
        const x = (latLng.lng - bounds.getWest()) * scaleX;
        const y = (bounds.getNorth() - latLng.lat) * scaleY;
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.closePath();
      ctx.fill();

      return canvas.toDataURL();
    }

    // Function to render saved polygons in the list
    function renderSavedPolygons() {
      const polygonList = document.getElementById("savedPolygonList");
      polygonList.innerHTML = "";

      savedPolygons.forEach((polygon, index) => {
        const listItem = document.createElement("li");
        listItem.classList.add("list-group-item", "d-flex", "align-items-center");
        listItem.style.cursor = "pointer";

        const previewImg = document.createElement("img");
        previewImg.src = polygon.preview;
        previewImg.style.width = "50px";
        previewImg.style.height = "50px";
        previewImg.style.marginRight = "10px";
        previewImg.alt = "Polygon Preview";

        const polygonName = document.createElement("span");
        polygonName.textContent = polygon.name;

        listItem.appendChild(previewImg);
        listItem.appendChild(polygonName);

        // Click event to load the polygon onto the map
        listItem.addEventListener("click", () => loadPolygon(index));

        polygonList.appendChild(listItem);
      });
    }

    // Function to save a polygon
    function savePolygon(name, polygon) {
      const polygonData = {
        name: name,
        coordinates: polygon.getLatLngs(),
        preview: generatePreview(polygon)
      };
      savedPolygons.push(polygonData);
      renderSavedPolygons();
    }



    // Function to load a saved polygon onto the map
    function loadPolygon(index) {
      const polygonData = savedPolygons[index];

      if (drawnPolygon) {
        searchMap.removeLayer(drawnPolygon);
      }

      drawnPolygon = L.polygon(polygonData.coordinates, {
        color: 'purple',
        fillOpacity: 0.3
      }).addTo(searchMap);

      drawnPolygon.on('click', function () {
        new L.EditToolbar.Edit(searchMap, {
          featureGroup: L.featureGroup([drawnPolygon]),
        }).enable();
      });

      searchMap.fitBounds(drawnPolygon.getBounds());
    }

    // Add a custom "Save Polygon" button
    L.Control.SavePolygon = L.Control.extend({
      onAdd: function () {
        var btn = L.DomUtil.create('button', 'save-polygon-button');
        btn.innerHTML = 'Save Polygon';
        btn.classList.add('btn', 'btn-primary', 'p-2');

        L.DomEvent.on(btn, 'click', function () {
          if (drawnPolygon) {
            const polygonName = prompt("Enter a name for this polygon:");
            if (polygonName) {
              savePolygon(polygonName, drawnPolygon);
              alert('Polygon saved successfully!');
            }
          } else {
            alert('No polygon to save! Please draw a polygon first.');
          }
        });

        return btn;
      },
      onRemove: function () {
        // No cleanup needed
      }
    });

    L.control.savePolygon = function (opts) {
      return new L.Control.SavePolygon(opts);
    };

    // Add the "Save Polygon" button to the map
    L.control.savePolygon({ position: 'topleft' }).addTo(searchMap);


    // Handle the creation of new shapes
    searchMap.on('draw:created', function (e) {
      var layer = e.layer;

      // Remove the previous polygon, if any
      if (drawnPolygon) {
        searchMap.removeLayer(drawnPolygon);
      }

      drawnPolygon = layer;
      drawnPolygon.addTo(searchMap);

      drawnPolygon.on('click', function () {
        new L.EditToolbar.Edit(searchMap, {
          featureGroup: L.featureGroup([drawnPolygon]),
        }).enable();
      });

      console.log("Drawn polygon coordinates:", drawnPolygon.toGeoJSON());
    });

    const spatialModal = document.getElementById('spatial-search-modal');
    spatialModal.addEventListener('shown.bs.modal', function () {
      searchMap.invalidateSize();
    });
  </script>


  <script>
    function setCookie(name, value, minutes) {
      var expires = "";
      if (minutes) {
        var date = new Date();
        date.setTime(date.getTime() + (minutes * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function appendClearAllOption() {
      if ($('#clear-all-datasets').length === 0) {
        $('#compare-dataset-options').append(`
        <div class="dropdown-item cursor-pointer text-center text-danger" id="clear-all-datasets" data-dataset-id="__clearall__" onclick="clearAllCompareDatasets()">
        Clear All
        </div>
      `);
      }
    }

    function appendDatasetCompareOption(datasetName, id) {
      $('#compare-dataset-options').append(`
        <div class="dropdown-item d-flex justify-content-between align-items-center" id="compare-dataset-option-${id}">
          ${datasetName} 
          <span class="ms-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger cursor-pointer icon icon-tabler icons-tabler-outline icon-tabler-trash remove-dataset" data-dataset-id="${id}">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M4 7l16 0" />
          <path d="M10 11l0 6" />
          <path d="M14 11l0 6" />
          <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
            </svg>
          </span>
        </div>
          `);
    }

    function refreshDatasetCompareOption(selectedIds) {
      // Remove any options not in selectedIds
      $('#compare-dataset-options .dropdown-item').each(function () {
        var datasetId = $(this).find('.remove-dataset').data('dataset-id');
        if (datasetId && datasetId.toString() === '__clearall__') {
          return;
        }
        if (datasetId && !selectedIds.includes(datasetId.toString())) {
          $(this).remove();
        }
      });

      // Add options for selectedIds
      selectedIds.forEach(function (id) {
        if ($(`#compare-dataset-option-${id}`).length === 0) {
          $.get(`{{url_for('catalog_blueprint.api_get_dataset', entity_id='')}}${id}`, function (data) {
            appendDatasetCompareOption(data.result.title, id);
          });
        }
      });

      $('#dataset-compare-number').text(`(${selectedIds.length})`);
      appendClearAllOption();
    }

    function clearAllCompareDatasets() {
      setCookie('compare_datasets', '', -1);
      $('#compare-dataset-options').empty();
      $('.comparator-btn').removeClass('btn-success').addClass('btn-outline-success');
      $('#dataset-compare-number').text(`(0)`);
      appendClearAllOption();
    }

    function attachComparatorButtonListeners() {
      $('.comparator-btn').off('click');
      $('.comparator-btn').on('click', function () {
        var datasetId = $(this).data('dataset-id');
        if (!datasetId) {
          console.error("Dataset ID not found!");
          return;
        }

        var cookieValue = getCookie('compare_datasets');
        var selectedIds = cookieValue ? cookieValue.split(',') : [];

        // If this dataset is already selected, remove it
        if (selectedIds.indexOf(datasetId.toString()) !== -1) {
          selectedIds = selectedIds.filter(id => id !== datasetId.toString());
          setCookie('compare_datasets', selectedIds.join(','), 30); // Cookie valid for 30 minutes
          $(this).removeClass('btn-success').addClass('btn-outline-success');
          refreshDatasetCompareOption(selectedIds);
        } else {
          // If this dataset isn't already selected, add it
          if (selectedIds.length < 5) {
            selectedIds.push(datasetId);
            setCookie('compare_datasets', selectedIds.join(','), 30);
            $(this).removeClass('btn-outline-success').addClass('btn-success');
            refreshDatasetCompareOption(selectedIds);
            if (selectedIds.length == 2) {
              $('#toast-message-info').removeClass('hide').addClass('show').addClass('fade');
              $('#toast-info-body').html("Looks like you have selected packages for comparison. Compare them <a href='{{url_for('dashboard_blueprint.dataset_compare')}}'>here</a>");
            }
          } else {
            $('#toast-message-alert').removeClass('hide').addClass('show').addClass('fade');
            $('#toast-message-body').text("Max 5 datasets can be compared at a time");
          }
        }
      });
    }

    function renderSelectedComparators() {
      var cookieValue = getCookie('compare_datasets');
      var selectedIds = cookieValue ? cookieValue.split(',') : [];

      selectedIds.forEach(function (id) {
        $('.comparator-btn[data-dataset-id="' + id + '"]').removeClass('btn-outline-success').addClass('btn-success');
      });

      refreshDatasetCompareOption(selectedIds);

      // Handle removal of datasets from the dropdown and cookie
      $(document).on('click', '.remove-dataset', function () {
        var datasetId = $(this).data('dataset-id');
        var cookieValue = getCookie('compare_datasets');
        var selectedIds = cookieValue ? cookieValue.split(',') : [];

        // Remove the dataset ID from the selected IDs
        selectedIds = selectedIds.filter(id => id !== datasetId.toString());
        setCookie('compare_datasets', selectedIds.join(','), 30);
        refreshDatasetCompareOption(selectedIds);
        $(`#compare-dataset-option-${datasetId}`).remove();
        $(`.comparator-btn[data-dataset-id="${datasetId}"]`).removeClass('btn-success').addClass('btn-outline-success');
      });
    }

  </script>



  <script>

    function publishDataset() {

      const title = $('input[name="package-name-input"]').val().trim();
      const notes = $('textarea[name="packageDescription"]').val().trim();
      const tags = $('#hiddenTagsInput').val().split(',').filter(tag => tag.trim() !== '');
      const ownerOrg = $('#owner-org').val();
      const private = $('input[name="package-visibility"]:checked').val() === 'private'

      $('#new-dataset-modal-footer .stelar-loader').remove();
      $('#new-dataset-modal-footer .alert').remove();

      if (!title || !notes || tags.length === 0) {
        $('#new-dataset-modal-footer').prepend(createAlertElement('danger', 'Please fill in all fields.'));
        return;
      }

      const payload = {
        name: slugifyTitle(title),
        title: title,
        notes: notes,
        tags: tags,
        'owner_org': ownerOrg,
        private: private
      };

      $("#new-dataset-modal-footer").prepend(createLoaderElement(false, false));

      $.ajax({
        url: `{{ url_for('catalog_blueprint.api_create_dataset') }} `,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function (response) {
          $('#new-dataset-modal-footer .stelar-loader').remove();
          $('#new-dataset-modal-footer').prepend(createAlertElement('success', 'Dataset Published Successfully'));
          setTimeout(function () {
            $('#new-dataset-modal-footer .alert').fadeOut(500, function () {
              $(this).remove();
            });
          }, 3000);
        },
        error: function (xhr) {
          $('#new-dataset-modal-footer .stelar-loader').remove();
          $('#new-dataset-modal-footer').prepend(createAlertElement('danger', 'Error publishing dataset.'));
          setTimeout(function () {
            $('#new-dataset-modal-footer .alert').fadeOut(500, function () {
              $(this).remove();
            });
          }, 3000);
        }
      });
      
    }

    $(document).ready(function () {
      const titleInput = $('input[name="package-name-input"]');
        titleInput.on('input', function () {
        titleInput.removeClass('is-valid is-invalid');
      });
    });

    function fetchOrganizations(callback) {
      $.ajax({
        url: '{{ url_for("catalog_blueprint.api_fetch_organizations") }}',
        method: 'GET',
        dataType: 'json',
        success: function (data) {
          // Clear the owner organization dropdown
          $('#owner-org').empty();
          window.orgs = window.orgs || {};
          if (data.result.length > 0) {
            for (var i = 0; i < data.result.length; i++) {
              var org = data.result[i];
              // Append the option element
              $('#owner-org').append(`<option value="${org.name}">${org.title}  |  ${org.name}</option>`);
              // Set organization keyed by its name
              window.orgs[org.name] = org;
            }
          }
          if (callback && typeof callback === 'function') {
            callback();
          }
        },
        error: function (xhr, status, error) {
          if (xhr.status === 401) {
            window.location.href = '/';
          }
        }
      });
    }

    function slugifyTitle(title) {
      return title
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s]/g, '') // Remove any character that is not a letter, number, or space
        .replace(/\s+/g, '-'); // Replace spaces with underscores
    }

    function checkNameAvailability() {
      const titleInput = $('input[name="package-name-input"]');
      const title = titleInput.val().trim();

      if (title === '') {
        return;
      }

      titleInput.removeClass('is-valid is-invalid');
      $("#availability-div").prepend(createLoaderElement(true, true));

      $.ajax({
        url: `{{ url_for('catalog_blueprint.api_get_dataset', entity_id = '') }}${slugifyTitle(title)}`,
        method: 'GET',
        success: function (response) {
          // If the response is 200, a dataset already exists
          $('#availability-div .spinner-border').remove()
          titleInput.addClass('is-invalid');
        },
        error: function (xhr) {
          if (xhr.status === 404) {
            // If the response is 404, a dataset doesn't exist
            $('#availability-div .spinner-border').remove()
            titleInput.addClass('is-valid');
          } else {
            $('#availability-div .spinner-border').remove()
          }
        }
      });
    }
  </script>


  <script>
    const tagInput = document.getElementById('tagInput');
    const tagsContainer = document.getElementById('tagsContainer');
    const hiddenTagsInput = document.getElementById('hiddenTagsInput');

    let tags = [];

    function renderTags() {
      tagsContainer.innerHTML = '';

      // Add each tag as a span with a close button
      tags.forEach((tag, index) => {
        const tagElement = document.createElement('span');
        tagElement.classList.add('tag', 'me-2', 'mb-2');

        tagElement.innerHTML = `
            ${tag}
    <a href="#" class="btn-close ms-1" data-index="${index}"></a>
          `;

        // Append the tag element to the container
        tagsContainer.appendChild(tagElement);
      });

      // Add event listeners to each close button
      const closeButtons = document.querySelectorAll('.btn-close');
      closeButtons.forEach(button => {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          const index = button.getAttribute('data-index');
          removeTag(index);
        });
      });

      // Update the hidden input with the current tags as a comma-separated string
      hiddenTagsInput.value = tags.join(',');
    }

    // Function to remove a tag by index
    function removeTag(index) {
      tags.splice(index, 1);
      renderTags();
    }

    // Function to handle input and add tag
    tagInput.addEventListener('keydown', function (event) {
      // If Enter is pressed, add the tag
      if (event.key === 'Enter') {
        event.preventDefault();
        const newTag = tagInput.value.trim();

        if (newTag !== '' && !tags.includes(newTag)) {
          tags.push(newTag);
          tagInput.value = ''; // Clear the input after adding the tag
          renderTags();
        }
      }

      // If backspace is pressed and input is empty, remove the last tag
      if (event.key === 'Backspace' && tagInput.value === '') {
        tags.pop();
        renderTags();
      }
    });
  </script>
</body>

</html>