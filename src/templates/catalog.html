<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>STELAR | Data Catalog</title>
  {% include 'tabler.html' %}
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet PM CSS (for polygon editing) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.css" />

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="{{ url_for('static', filename='images.js') }}"></script>
  <script src="{{ url_for('static', filename='utils.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='stelar.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png">
</head>

<body>
  <div class="page">
    <!-- Navbar -->
    {% include 'header.html' %}
    <div class="page-wrapper">
      <!-- Page header -->
      <div class="page-header d-print-none">
        <div class="container-xl">
          <div class="row g-2 align-items-center">
            <div class="col">
              <!-- Page pre-title -->
              <div class="page-pretitle">
                Data Catalog
              </div>
              <h2 class="page-title">
                Browse & Manage Packages
              </h2>
            </div>
            <div class="col-auto me-2 d-print-none">
              <div class="input-group">

                <button type="button" class="btn" id="compare-datasets-button"
                  onclick="window.location.href='{{url_for('dashboard_blueprint.dataset_compare')}}'">Compare Selected
                  <span class="ms-1" id="dataset-compare-number">(0)</span></button>

                <button data-bs-toggle="dropdown" role="button" class="btn dropdown-toggle"
                  datas-bs-auto-close="outside"></button>
                <div class="dropdown-menu dropdown-menu-end" id="compare-dataset-options">

                </div>
              </div>
            </div>
            <div class="col-auto ms-auto d-print-none">
              <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-new-dataset">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M12 5l0 14" />
                  <path d="M5 12l14 0" />
                </svg>
                Publish
              </a>
            </div>
          </div>
        </div>
      </div>
      <!-- Page body -->
      <div class="page-body">
        <div class="container-xl">
          <div class="mt-2" style="position: relative;">
            <div class="input-icon">
              <span class="input-icon-addon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path>
                  <path d="M21 21l-6 -6"></path>
                </svg>
              </span>
              <div class="input-group">
                <input type="text" value="{{ search_q.keywords if search_q.keywords else '' }}"
                  class="form-control query-param mb-0 h3" placeholder="Search for a keyword" id="catalog-search-box"
                  aria-label="Catalog Search" style="height:3.5rem;" autocomplete="off">
                <button class="btn query-param" type="button" onclick="performKeywordSearch()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="me-1 icon icon-tabler icons-tabler-outline icon-tabler-search">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                    <path d="M21 21l-6 -6" />
                  </svg>
                  Search</button>
              </div>
            </div>
            <ul id="suggestions-list" class="bg-white list-group"
              style="position:absolute; top:100%; left:0; z-index:1001; display:none; width:100%;">
            </ul>
          </div>
          <div class="badges-list mt-3 mb-0" id="filter-list">



          </div>

          <div class="row g-6 mt-3">
            <div class="col-md-3">

              <div class="form-label h3">Spatial Coverage</div>
              <a data-bs-toggle="modal" data-bs-target="#spatial-search-modal" href="#" class="mb-4 card card-link m"
                style="height: 16rem;" id="map">

              </a>
              <div class="form-label h3">Temporal Coverage</div>
              <div class="mb-0 p-1" style="max-height: 16.5rem; overflow: auto;" id="facet-temporal">
                <div>
                  <div class="mb-1">
                    <label for="start-datetime" class="form-label">Start Time</label>
                    <input type="datetime-local" id="start-datetime" class="form-control query-param"
                      onchange="updateChart()">
                  </div>
                  <div>
                    <label for="end-datetime" class="form-label">End Time</label>
                    <input type="datetime-local" id="end-datetime" class="form-control query-param"
                      onchange="updateChart()">
                  </div>
                  <div class="mt-2" id="temporal-chart"></div>
                </div>
              </div>
              <hr class="mt-0">
              <div class="form-label h3">Tags</div>
              <div class="mb-1 p-1" style="max-height: 16.5rem; overflow: auto;" id="facet-tags">

                <div class="placeholder-glow">
                  {% for i in range(0, 7) %}
                  <label class="form-check tag-item">
                    <div class="placeholder placeholder-xs col-3 m-0"></div>
                  </label>
                  {% endfor %}
                </div>
              </div>
              <hr>
              <div class="form-label h3">Resource Format</div>
              <div class="mb-1 p-1" style="max-height: 16.5rem; overflow: auto;" id="facet-format">
                <div class="placeholder-glow">
                  {% for i in range(0, 7) %}
                  <label class="form-check tag-item">
                    <div class="placeholder placeholder-xs col-3 m-0"></div>
                  </label>
                  {% endfor %}
                </div>
              </div>
              <hr>
              <div class="form-label h3">Creator</div>
              <div class="mb-1 p-1" style="max-height: 16.5rem; overflow: auto;" id="facet-author">
                <div class="placeholder-glow">
                  {% for i in range(0, 7) %}
                  <label class="form-check tag-item">
                    <div class="placeholder placeholder-xs col-3 m-0"></div>
                  </label>
                  {% endfor %}
                </div>
              </div>
              <hr>
              <div class="form-label h3">Owner Organization</div>
              <div class="mb-1 p-1" style="max-height: 18rem; overflow: auto;" id="facet-organization">
                <div class="placeholder-glow">
                  {% for i in range(0, 7) %}
                  <label class="form-check tag-item">
                    <div class="placeholder placeholder-xs col-3 m-0"></div>
                  </label>
                  {% endfor %}
                </div>
              </div>
              <div class="mt-5">
                <button class="btn btn-primary w-100 query-param" onclick="performFrontendSearch()">
                  Apply filters
                </button>
                <a class="btn btn-link w-100 query-param" onclick="resetCheckedFilters()">
                  Reset to defaults
                </a>
              </div>
            </div>
            <div class="col-md-9 mt-3">

              <ul class="pagination d-flex justify-content-end mb-5">
                <span class="m-1 ms-auto me-2 h3">Sort By:</span>
                <select name="result-sort" class="form-select w-25 h-25 query-param" id="result-sort">
                  <option value="metadata_modified desc" {% if search_q.get('sort', 'metadata_modified desc'
                    )=='metadata_modified desc' %}selected="selected" {% endif %}>Latest</option>
                  <option value="metadata_modified asc" {% if search_q.get('sort')=='metadata_modified asc'
                    %}selected="selected" {% endif %}>Oldest</option>
                  <option value="score desc" {% if search_q.get('sort')=='score desc' %}selected="selected" {% endif %}>
                    Most Relevant</option>
                  <option value="name asc" {% if search_q.get('sort')=='name asc' %}selected="selected" {% endif %}>Name
                    A-Z</option>
                </select>
              </ul>

              <div class="row row-cards" id="package-list">

                {% for i in range(0, 9) %}
                <div class="card card-link m-0 placeholder-glow cursor-pointer disabled mb-3">
                  <div class="row g-0">
                    <div class="col-auto">
                      <div class="card-body">
                        <div class="placeholder avatar avatar-md">

                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card-body ps-0">
                        <div class="row">
                          <div class="col-md-11">
                            <h3 class="mb-0">
                              <div class="placeholder col-4"></div>
                              <span class="placeholder col-2 ms-2"></span>
                            </h3>
                            <p class="text-secondary placeholder placeholder-xs col-9 mt-3"></p>
                          </div>
                          <div class="col-md-1 d-flex justify-content-end">
                            <button
                              class="btn placeholder btn-pill btn-outline-success m-3 me-1 p-1 text-center comparator-btn align-self-center"
                              data-dataset-id="" title="Add to comparison">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round"
                                class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-git-compare">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M6 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M11 6h5a2 2 0 0 1 2 2v8"></path>
                                <path d="M14 9l-3 -3l3 -3"></path>
                                <path d="M13 18h-5a2 2 0 0 1 -2 -2v-8"></path>
                                <path d="M10 15l3 3l-3 3"></path>
                              </svg>
                            </button>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md">
                            <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                              <div class="list-inline-item placeholder col-2">

                              </div>
                              <div class="list-inline-item placeholder col-3">
                              </div>
                              <div class="list-inline-item placeholder col-2">
                              </div>
                            </div>
                          </div>
                          <div class="col-md-auto">
                            <div class="mt-3 badges">
                              <span class="tag m-1 mb-0 placeholder">
                                STELAR
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              <ul class="pagination d-flex justify-content-end mb-5">
                <div class="text-secondary" id="pagination-info">
                </div>
                <div class="ms-auto" id="pagination-control">

                </div>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal modal-blur fade" id="spatial-search-modal" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog me-6 ms-6 mt-2 modal-full-width modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Spatial Search </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-lg-12">
                    <div class="h3 ms-4">Interactive Map</div>
                    <p class="ms-4 text-sm text-secondary">Use the drawing toolbox below to define an area on the map.
                      A
                      search will be performed on the available datasets to find results lying within the marked area.
                    </p>
                    <div id="search-map" class="m-4 card card-link m" style="height: 60vh">



                    </div>
                    <p class="ms-4 text-sm text-secondary">Only one polygon can be used in a search query. Make sure
                      your polygon is convex for optimal results.</p>
                  </div>
                </div>

              </div>
              <div class="modal-footer" id="spatial-search-modal-footer">
                <a class="btn btn-outline-primary ms-auto disabled" onclick="addSpatialFilter()"
                  id="add-spatial-filter-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-tabler icons-tabler-outline icon-tabler-plus">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M12 5l0 14" />
                    <path d="M5 12l14 0" />
                  </svg>
                  Add as Filter to Search
                </a>
                <a class="btn btn-primary ms-2" onclick="performSpatialSearch()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-search">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                    <path d="M21 21l-6 -6" />
                  </svg>
                  Search
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div class="toast fade hide" role="alert" id="toast-message-alert" aria-live="assertive" aria-atomic="true"
            data-bs-autohide="false">
            <div class="toast-header">
              <strong class="me-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                  class="me-2 text-primary icon icon-tabler icons-tabler-filled icon-tabler-alert-square-rounded">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M12 2l.642 .005l.616 .017l.299 .013l.579 .034l.553 .046c4.687 .455 6.65 2.333 7.166 6.906l.03 .29l.046 .553l.041 .727l.006 .15l.017 .617l.005 .642l-.005 .642l-.017 .616l-.013 .299l-.034 .579l-.046 .553c-.455 4.687 -2.333 6.65 -6.906 7.166l-.29 .03l-.553 .046l-.727 .041l-.15 .006l-.617 .017l-.642 .005l-.642 -.005l-.616 -.017l-.299 -.013l-.579 -.034l-.553 -.046c-4.687 -.455 -6.65 -2.333 -7.166 -6.906l-.03 -.29l-.046 -.553l-.041 -.727l-.006 -.15l-.017 -.617l-.004 -.318v-.648l.004 -.318l.017 -.616l.013 -.299l.034 -.579l.046 -.553c.455 -4.687 2.333 -6.65 6.906 -7.166l.29 -.03l.553 -.046l.727 -.041l.15 -.006l.617 -.017c.21 -.003 .424 -.005 .642 -.005zm.01 13l-.127 .007a1 1 0 0 0 0 1.986l.117 .007l.127 -.007a1 1 0 0 0 0 -1.986l-.117 -.007zm-.01 -8a1 1 0 0 0 -.993 .883l-.007 .117v4l.007 .117a1 1 0 0 0 1.986 0l.007 -.117v-4l-.007 -.117a1 1 0 0 0 -.993 -.883z" />
                </svg>System Alert</strong>
              <small>Just now</small>
              <button type="button" class="ms-2 btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message-body">
              Message not available
            </div>
          </div>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div class="toast fade hide" role="alert" id="toast-message-info" aria-live="assertive" aria-atomic="true"
            data-bs-autohide="false">
            <div class="toast-header">
              <strong class="me-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                  class="me-2 text-primary icon icon-tabler icons-tabler-filled icon-tabler-bulb">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M4 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z" />
                  <path
                    d="M12 2a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z" />
                  <path d="M21 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z" />
                  <path
                    d="M4.893 4.893a1 1 0 0 1 1.32 -.083l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 0 -1.414z" />
                  <path
                    d="M17.693 4.893a1 1 0 0 1 1.497 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7z" />
                  <path d="M14 18a1 1 0 0 1 1 1a3 3 0 0 1 -6 0a1 1 0 0 1 .883 -.993l.117 -.007h4z" />
                  <path
                    d="M12 6a6 6 0 0 1 3.6 10.8a1 1 0 0 1 -.471 .192l-.129 .008h-6a1 1 0 0 1 -.6 -.2a6 6 0 0 1 3.6 -10.8z" />
                </svg>System Info</strong>
              <small>Just now</small>
              <button type="button" class="ms-2 btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-info-body">
              Message not available
            </div>
          </div>
        </div>
        <div class="modal modal-blur fade" id="modal-new-dataset" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
              <form>
                <div class="modal-header">
                  <h5 class="modal-title">New Dataset</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="mb-0">
                      <label class="form-label">Title</label>
                      <div class="row g-2">
                        <div class="col">
                          <input type="text" class="form-control" name="package-name-input" placeholder="Dataset Title"
                            required>
                        </div>
                        <small class="form-hint">
                          <p>
                            A name in the format <code>the-new-dataset</code> (hyphens
                            instead of spaces) will be generated for the dataset. The name of
                            the dataset is one the identifiers of it, therefore it must be unique.
                          </p>
                        </small>
                      </div>
                    </div>
                    <div class="d-flex">
                      <div class="text-secondary ms-auto justify-content-right" id="availability-div">
                        <a onclick="checkNameAvailability()" class="text-sm p-2 cursor-pointer link-secondary"
                          title="Check Title Availability" data-bs-toggle="tooltip" tabindex="-1">
                          Check title availability
                        </a>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-lg-6">
                        <label class="form-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"
                            class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-building-bank">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M3 21l18 0" />
                            <path d="M3 10l18 0" />
                            <path d="M5 6l7 -3l7 3" />
                            <path d="M4 10l0 11" />
                            <path d="M20 10l0 11" />
                            <path d="M8 14l0 3" />
                            <path d="M12 14l0 3" />
                            <path d="M16 14l0 3" />
                          </svg>Owner Organization</label>
                        <select class="form-select" id="owner-org" name="owner_org">

                        </select>
                        <small class="form-hint">
                          <p>
                            Creating a new dataset in an organization requires you to have
                            the permission to do so assigned by an administrator.
                          </p>
                        </small>
                      </div>
                      <div class="col-lg-6">
                        <label class="form-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"
                            class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-license">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path
                              d="M15 21h-9a3 3 0 0 1 -3 -3v-1h10v2a2 2 0 0 0 4 0v-14a2 2 0 1 1 2 2h-2m2 -4h-11a3 3 0 0 0 -3 3v11" />
                            <path d="M9 7l4 0" />
                            <path d="M9 11l4 0" />
                          </svg>License</label>
                        <select class="form-select" id="license-id" name="license_id">
                        </select>
                        <small class="form-hint">
                          <p>
                            Selecting the appropriate license for your dataset is important
                            to ensure that users understand how they can use the data.
                          </p>
                        </small>
                      </div>
                    </div>
                    <div class="mt-0">
                      <label class="form-label">Visibility</label>
                      <div class="form-selectgroup-boxes row mb-1">
                        <div class="col-lg-6 text-success">
                          <label class="form-selectgroup-item">
                            <input type="radio" name="package-visibility" value="public" class="form-selectgroup-input"
                              checked="">
                            <span class="form-selectgroup-label d-flex align-items-center p-3">
                              <span class="me-3">
                                <span class="form-selectgroup-check"></span>
                              </span>
                              <span class="form-selectgroup-label-content">
                                <span class="form-selectgroup-title strong mb-1">Public</span>
                                <span class="d-block text-secondary">Accessible to all users
                                  registered in the KLMS</span>
                              </span>
                            </span>
                          </label>
                        </div>
                        <div class="col-lg-6 text-danger">
                          <label class="form-selectgroup-item">
                            <input type="radio" name="package-visibility" value="private"
                              class="form-selectgroup-input">
                            <span class="form-selectgroup-label d-flex align-items-center p-3">
                              <span class="me-3">
                                <span class="form-selectgroup-check"></span>
                              </span>
                              <span class="form-selectgroup-label-content">
                                <span class="form-selectgroup-title strong mb-1">Private</span>
                                <span class="d-block text-secondary">Accessible only to members
                                  of the organization that
                                  owns the package</span>
                              </span>
                            </span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="packageDescription" class="form-control" rows="3" required
                          placeholder="A nice informative description"></textarea>
                      </div>
                    </div>
                    <small class="form-hint">
                      <p>
                        After the dataset is published, you will be able to add resources and
                        manage every additional attribute of it (Spatial Coverage, Temporal Coverage, Extra Metadata,
                        etc.)
                      </p>
                    </small>
                    <input type="hidden" name="packageTags" id="hiddenTagsInput" name="tags" />
                    <div class="col-lg-12">
                      <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" id="tagInput" class="form-control" placeholder="Type a tag and press enter"
                          required>
                        <div class="col tags-list mt-3" id="tagsContainer">
                          <!-- Tags will be dynamically added here -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer" id="new-dataset-modal-footer">
                  <a class="cursor-pointer btn btn-primary ms-auto" id="publish-dataset-btn" onclick="publishDataset()"
                    disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M12 5l0 14" />
                      <path d="M5 12l14 0" />
                    </svg>
                    Publish Dataset
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% include 'footer.html'%}
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <script>
    var map = L.map('map', {
      center: [47.57536996623514, 8.261718750000002],
      zoom: 3,
      zoomControl: false,
      maxZoom: 3,
      minZoom: 3,
      scrollWheelZoom: false,
      dragging: false
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

  </script>


  <script>
    $(document).ready(function () {
      var selectedIndex = -1;
      var suggestions = [];

      $('#catalog-search-box').on('input', function () {
        var query = $(this).val();
        if (query.length >= 2) {
          $.ajax({
            url: `{{url_for('pub_blueprint.autocomplete_datasets', limit=10, query='')}}` + encodeURIComponent(query),
            method: 'POST',
            dataType: 'json',
            success: function (response) {
              if (response.success) {
                suggestions = response.result;
                var html = "";
                suggestions.forEach(function (item, index) {
                  html += '<li class="list-group-item suggestion-item" data-name="' + item.name + '" style="cursor:pointer;">' +
                    '<strong>' + item.title + '</strong> - <small><code>' + item.name + '</code></small>' +
                    '</li>';
                });
                $('#suggestions-list').html(html).show();
                selectedIndex = -1;
              }
            }
          });
        } else {
          $('#suggestions-list').hide();
        }
      });

      $('#catalog-search-box').on('keydown', function (e) {
        // Handle Enter key regardless of suggestions
        if (e.key === "Enter") {
          e.preventDefault();
          var items = $('#suggestions-list li');
          if (items.length > 0 && selectedIndex > -1) {
            var selectedItem = $(items[selectedIndex]);
            var name = selectedItem.data('name');
            window.location.href = `{{url_for('dashboard_blueprint.dataset_detail', dataset_id='')}}` + encodeURIComponent(name);
          } else {
            // If no suggestion is selected or no suggestions available, perform a search
            performKeywordSearch();
          }
          return;
        }
        
        // Handle arrow navigation only if we have suggestions
        var items = $('#suggestions-list li');
        if (items.length === 0) return;
        
        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedIndex = (selectedIndex + 1) % items.length;
          items.removeClass('active');
          $(items[selectedIndex]).addClass('active');
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedIndex = (selectedIndex - 1 + items.length) % items.length;
          items.removeClass('active');
          $(items[selectedIndex]).addClass('active');
        }
      });

      // Click selection of suggestion
      $(document).on('click', '.suggestion-item', function () {
        var name = $(this).data('name');
        window.location.href = `{{url_for('dashboard_blueprint.dataset_detail', dataset_id='')}}` + encodeURIComponent(name);
      });

      // Hide suggestions on blur after slight delay
      $('#catalog-search-box').on('blur', function () {
        setTimeout(function () {
          $('#suggestions-list').hide();
        }, 100);
      });
    });
  </script>

  <!-- Datepickers -->
  <script>
    var startDate = new Date(document.getElementById('start-datetime').value).getTime();
    var endDate = new Date(document.getElementById('end-datetime').value).getTime();

    var options = {
      series: [{
        data: [{
          x: 'Date Range',
          y: [startDate, endDate]
        }]
      }],
      chart: {
        height: 100,
        type: 'rangeBar',
        zoom: {
          enabled: true
        }
      },
      colors: ['#3f1757'],
      plotOptions: {
        bar: {
          horizontal: true
        }
      },
      xaxis: {
        type: 'datetime'
      },
      grid: {
        xaxis: {
          lines: {
            show: true
          }
        },
        yaxis: {
          lines: {
            show: false
          }
        }
      }
    };

    var chart = new ApexCharts(document.querySelector("#temporal-chart"), options);
    chart.render();

    function updateChart() {
      startDate = new Date(document.getElementById('start-datetime').value).getTime();
      endDate = new Date(document.getElementById('end-datetime').value).getTime();
      chart.updateSeries([{
        data: [{
          x: 'Date Range',
          y: [startDate, endDate]
        }]
      }]);
    }
  </script>


  <!-- Search Script -->
  <script>
    query = {
      "q": "{{ search_q.keywords if search_q.keywords else '' }}",
      "sort": "{{ search_q.sort }}",
      "fl": [
        "id",
        "title",
        "notes",
        "author",
        "organization",
        "tags",
        "metadata_modified",
        "capacity",
        "type",
        "license_id",
      ],
      "fq": [{% for filter in search_q.fq %}"{{ filter }}"{% if not loop.last %}, {% endif %} {% endfor %}],
      "limit": 10,
        "offset": 0,
          {% if search_q.bbox %}
      "bbox": {{ search_q.bbox }},
      {% endif %}
      "facet": {
        "fields": [
          "tags",
          "author",
          "organization",
          "res_format",
          "capacity",
          "license_id"
        ]
      }
    };

    // The updateQueryFilters() function replicates the backend logic.
    // It fetches filter values from the URL and reconstructs the fq array.
    function updateQueryFilters() {
      var urlParams = new URLSearchParams(window.location.search);
      var filters = [];
      ["tags", "res_format", "org", "author"].forEach(function (field) {
        var param = urlParams.get(field);
        if (param) {
          var values = param.split(",").map(function (v) { return v.trim(); }).filter(function (v) { return v !== ""; });
          if (values.length > 0) {
            var actualField = (field === "org") ? "organization" : field;
            var filterStr = (actualField === "tags")
              ? actualField + ':("' + values.join('" OR "') + '")'
              : actualField + ":(" + values.join(" OR ") + ")";
            filters.push(filterStr);
          }
        }
      });
      var bboxParam = urlParams.get("bbox");
      if (bboxParam) {
        query.bbox = bboxParam.split(",").map(function (coord) {
          return parseFloat(coord.trim());
        });
      } else {
        delete query.bbox; // Remove bbox if not present
      }
      var keywordParam = urlParams.get("keywords");
      query.q = keywordParam ? keywordParam : "";
      query.fq = filters;
      maskWithPlaceholders();
      performSearch(query, false);
    }


    function performFrontendSearch() {
      maskWithPlaceholders();
      updateQueryFilters();
    }

    function performKeywordSearch() {
      appendFilterToLocation("keywords", $("#catalog-search-box").val());
      updateQueryFilters();
    }


    function renderFilterBadges() {
      // We need the backend rendered filters here to append filter badges 
      filters = {{ search_q | tojson }};
    

      var filterContainer = $('#filter-badges');
      filterContainer.empty();

      ["author", "tags", "res_format", "organization", "bbox"].forEach(function (type) {
        if (filters[type]) {
          if (type === "bbox") {
            // If bbox is an array, join its elements; otherwise, use the string as is.
            var bboxValue = Array.isArray(filters[type]) ? filters[type].join(",") : filters[type];
            appendFilterBadge(type, bboxValue);
          } else {
            filters[type].split(',').forEach(function (value) {
              var trimmed = value.trim();
              if (trimmed) {
                appendFilterBadge(type, trimmed);
              }
            });
          }
        }
      });
    }

    function performSearch(query, rebuildFacets = true) {
      lockQueryParams();
      $.ajax({
        url: "{{url_for('catalog_blueprint.api_search_datasets')}}",
        type: "POST",
        data: JSON.stringify(query),
        contentType: "application/json",
        success: function (response) {
          unlockQueryParams();
          if (response.success) {
            if (response.result.facets) {
              if (rebuildFacets) {
                $('#facet-tags').empty();
                $('#facet-author').empty();
                $('#facet-organization').empty();
                $('#facet-format').empty();
              }
              buildPackageCards(response.result.results); // pass orgData if needed
              attachComparatorButtonListeners();
              renderSelectedComparators();
            }
            if (response.result.count !== undefined) {
              buildPagination(response.result.count);
            }
          } else {
            console.error("Search failed:", response.message);
          }
        },
        error: function (xhr, status, error) {
          appendErrorMessage();
          unlockQueryParams();
          console.error("AJAX request failed:", error);
        }
      });
    }


    function fetchDefaultFacets() {
      fquery = {
        "q": "",
        "sort": "{{ search_q.sort }}",
        "fl": [
          "id"
        ],
        "facet": {
          "fields": [
            "tags",
            "author",
            "organization",
            "res_format"
          ]
        }
      };
      $.ajax({
        url: "{{url_for('catalog_blueprint.api_search_datasets')}}",
        type: "POST",
        data: JSON.stringify(fquery),
        contentType: "application/json",
        success: function (response) {
          if (response.success) {
            if (response.result.facets) {
              buildFacets(response.result.facets);
            }
          } else {
            console.error("Fetching default facets failed:", response.message);
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX request for default facets failed:", error);
        }
      });
    }

    function appendErrorMessage() {
      $("#package-list").html("");
      $('#pagination-control').html("");
      const searchError = `<div class="col-lg-12 my-6">
          <div class="text-center h1 text-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 150px;" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler h-100 icons-tabler-outline icon-tabler-bug"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 9v-1a3 3 0 0 1 6 0v1"></path><path d="M8 9h8a6 6 0 0 1 1 3v3a5 5 0 0 1 -10 0v-3a6 6 0 0 1 1 -3"></path><path d="M3 13l4 0"></path><path d="M17 13l4 0"></path><path d="M12 20l0 -6"></path><path d="M4 19l3.35 -2"></path><path d="M20 19l-3.35 -2"></path><path d="M4 7l3.75 2.4"></path><path d="M20 7l-3.75 2.4"></path></svg>          
          </div>
          <div class="h2 text-center text-secondary">
              <span class="text-secondary h2">An error occurred while looking for results. Please try refreshing the page. </span>
          </div>
      </div>`;
      $('#package-list').append(searchError);
    }

    function buildPagination(total) {
      var currentPage = Math.floor(query.offset / query.limit) + 1;
      var totalPages = Math.ceil(total / query.limit);
      var paginationHtml = '';

      // Previous button
      if (currentPage > 1) {
        paginationHtml += '<li class="page-item"><a class="page-link pagination-link" href="#" data-page="' + (currentPage - 1) + '"> prev </a></li>';
      } else {
        paginationHtml += '<li class="page-item disabled"><span class="page-link"> prev </span></li>';
      }

      // Calculate start and end page numbers to display
      var startPage = Math.max(1, currentPage - 5);
      var endPage = Math.min(totalPages, currentPage + 5);
      
      // Adjust start/end to always show 10 pages if possible
      if (endPage - startPage < 10 && totalPages > 10) {
        if (currentPage < totalPages / 2) {
          // If closer to start, show more pages to the right
          endPage = Math.min(totalPages, startPage + 9);
        } else {
          // If closer to end, show more pages to the left
          startPage = Math.max(1, endPage - 9);
        }
      }

      // First page + ellipsis
      if (startPage > 1) {
        paginationHtml += '<li class="page-item"><a class="page-link pagination-link" href="#" data-page="1">1</a></li>';
        if (startPage > 2) {
          paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
      }

      // Page numbers
      for (var i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
          paginationHtml += '<li class="page-item active"><span class="page-link">' + i + '</span></li>';
        } else {
          paginationHtml += '<li class="page-item"><a class="page-link pagination-link" href="#" data-page="' + i + '">' + i + '</a></li>';
        }
      }

      // Ellipsis + last page
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        paginationHtml += '<li class="page-item"><a class="page-link pagination-link" href="#" data-page="' + totalPages + '">' + totalPages + '</a></li>';
      }

      // Next button
      if (currentPage < totalPages) {
        paginationHtml += '<li class="page-item"><a class="page-link pagination-link" href="#" data-page="' + (currentPage + 1) + '"> next </a></li>';
      } else {
        paginationHtml += '<li class="page-item disabled"><span class="page-link"> next </span></li>';
      }

      $('#pagination-control').html('<ul class="pagination mb-0">' + paginationHtml + '</ul>');

      // Add Go To input field
      var goToHtml = '<div class="ms-3 mt-4 d-flex align-items-center">' +
                     '<span class="me-2 ms-auto">Go To:</span>' +
                     '<input type="number" min="1" max="' + totalPages + '" class="form-control form-control-sm page-goto-input" style="width: 70px; height:30px;">' +
                     '</div>';
      
      $('#pagination-control').append(goToHtml);

      // Update pagination info e.g., "Showing 1 to 10 of 53 results"
      var startResult = query.offset + 1;
      var endResult = Math.min(query.offset + query.limit, total);
      $('#pagination-info').html('<span class="h3">Showing ' + startResult + ' to ' + endResult + ' of ' + total + ' results</span>');

      // Add click listeners for pagination links
      $('.pagination-link').off('click').on('click', function (e) {
        e.preventDefault();
        var page = parseInt($(this).data('page'));
        query.offset = (page - 1) * query.limit;
        maskWithPlaceholders();
        performSearch(query, false);
      });

      // Add event listener for Go To input
      $('.page-goto-input').off('keypress').on('keypress', function (e) {
        if (e.which === 13) { // Enter key
          e.preventDefault();
          var page = parseInt($(this).val());
          if (isNaN(page) || page < 1 || page > totalPages) {
            page = 1; // Default to first page if invalid
          }
          query.offset = (page - 1) * query.limit;
          maskWithPlaceholders();
          performSearch(query, false);
        }
      });
    }

    function lockQueryParams() {
      $('.query-param').prop('disabled', true);
    }

    function unlockQueryParams() {
      $('.query-param').prop('disabled', false);
    }

    function buildPlaceholder() {
      return `<div class="card card-link m-0 placeholder-glow cursor-pointer disabled mb-3">
                  <div class="row g-0">
                    <div class="col-auto">
                      <div class="card-body">
                        <div class="placeholder avatar avatar-md">

                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card-body ps-0">
                        <div class="row">
                          <div class="col-md-11">
                            <h3 class="mb-0">
                              <div class="placeholder col-4"></div>
                              <span class="placeholder col-2 ms-2"></span>
                            </h3>
                            <p class="text-secondary placeholder placeholder-xs col-9 mt-3"></p>
                          </div>
                          <div class="col-md-1 d-flex justify-content-end">
                            <button
                              class="btn placeholder btn-pill btn-outline-success m-3 me-1 p-1 text-center align-self-center"
                              data-dataset-id="" title="Add to comparison">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round"
                                class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-git-compare">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M6 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M11 6h5a2 2 0 0 1 2 2v8"></path>
                                <path d="M14 9l-3 -3l3 -3"></path>
                                <path d="M13 18h-5a2 2 0 0 1 -2 -2v-8"></path>
                                <path d="M10 15l3 3l-3 3"></path>
                              </svg>
                            </button>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md">
                            <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                              <div class="list-inline-item placeholder col-2">

                              </div>
                              <div class="list-inline-item placeholder col-3">
                              </div>
                              <div class="list-inline-item placeholder col-2">
                              </div>
                            </div>
                          </div>
                          <div class="col-md-auto">
                            <div class="mt-3 badges">
                              <span class="tag m-1 mb-0 placeholder">
                                STELAR
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>`;
    }


    function removeFilterFromLocation(type, filter) {
      var url = new URL(window.location);
      var param;
      if (type === "tags") {
      param = "tags";
      } else if (type === "res_format") {
      param = "res_format";
      } else if (type === "organization") {
      param = "org";
      } else if (type === "author") {
      param = "author";
      } else if (type === "bbox") {
      // For bbox, remove the entire param
      url.searchParams.delete("bbox");
      window.history.pushState({}, "", url.toString());
      return;
      } else {
      param = type;
      }

      var current = url.searchParams.get(param);
      if (current) {
      var filters = current.split(",");
      var index = filters.indexOf(String(filter)); // Ensure filter is converted to string before comparison
      if (index !== -1) {
        filters.splice(index, 1);
        if (filters.length) {
        url.searchParams.set(param, filters.join(","));
        } else {
        url.searchParams.delete(param);
        }
      }
      }
      window.history.pushState({}, "", url.toString());
      updateQueryFilters();
    }

    function removeAllFiltersFromLocation() {
      var url = new URL(window.location);
      // Remove all related filters
      url.searchParams.delete("tags");
      url.searchParams.delete("res_format");
      url.searchParams.delete("org"); // organization
      url.searchParams.delete("author");
      url.searchParams.delete("bbox");
      url.searchParams.delete("keywords");
      window.history.pushState({}, "", url.toString());
      $('#filter-list').empty();
      updateQueryFilters();
    }

    function appendFilterToLocation(type, filter) {
      var url = new URL(window.location);
      var param;
      if (type === "tags") {
        param = "tags";
      } else if (type === "res_format") {
        param = "res_format";
      } else if (type === "organization") {
        param = "org";
      } else if (type === "author") {
        param = "author";
      } else if (type === "keywords") {
        param = "keywords";
        url.searchParams.set(type, filter);
        window.history.pushState({}, "", url.toString());
        updateQueryFilters();
        return;
      } else {
        param = type;
      }
      var current = url.searchParams.get(param);
      if (current) {
        var filters = current.split(",");
        if (filters.indexOf(filter) === -1) {
          filters.push(filter);
          url.searchParams.set(param, filters.join(","));
        }
      } else {
        url.searchParams.set(param, filter);
      }
      window.history.pushState({}, "", url.toString());
      updateQueryFilters();
    }

    function appendFilterBadge(type, filter) {
      var badgeClass;
      var displayText;
      if (type === "bbox") {
        badgeClass = "bg-success-lt";
        displayText = "Spatial Polygon";
      } else if (type === "res_format") {
        badgeClass = "bg-indigo-lt";
        displayText = "Format: " + filter;
      } else if (type === "organization") {
        badgeClass = "bg-blue-lt";
        displayText = "Organization: " + filter;
      } else if (type === "author") {
        badgeClass = "bg-orange-lt";
        displayText = "Author: " + filter;
      } else if (type === "tags") {
        badgeClass = "bg-purple-lt";
        displayText = "Tag: " + filter;
      } else if (type === "keywords") {
        badgeClass = "bg-yellow-lt";
        displayText = "Keyword: " + filter;
      } else {
        badgeClass = "bg-secondary-lt";
        displayText = type.charAt(0).toUpperCase() + type.slice(1) + ": " + filter;
      }
      var idValue = (type === "bbox") ? "filter-bbox" : "filter-" + type + "-" + filter;
      var filterHtml = `<span class="badge badge-lg ${badgeClass} me-1" data-category=${type} data-value=${filter} id="${sanitizeFilter(idValue)}">
      ${displayText}
      <button type="button" class="btn-close btn-close-sm remove-filter" data-type="${type}" data-filter="${filter}" aria-label="Close"></button>
      </span>`;
      $('#filter-list').append(filterHtml);
    }

    // Event delegation for dynamically added close buttons
    $(document).on('click', '.remove-filter', function () {
      var type = $(this).data('type');
      var filter = $(this).data('filter');
      // Uncheck the corresponding checkbox if type is not 'bbox'
      if (type !== 'bbox') {
        $(`input[type="checkbox"][value="${filter}"]`).prop('checked', false);
      }

      removeFilterBadge(type, filter);
      removeFilterFromLocation(type, filter);
      performFrontendSearch();
    });

    function removeFilterBadge(type, filter) {
      if (type === 'bbox') {
        $('#filter-bbox').remove();
      } else {
        $(`#filter-${type}-${sanitizeFilter(filter)}`).remove();
      }
    }

    function maskWithPlaceholders() {
      var packageList = $('#package-list');
      packageList.empty();
      for (var i = 0; i < 9; i++) {
        packageList.append(buildPlaceholder());
      }
    }

    function resortResults() {
      var sortValue = $('#result-sort').val();
      var url = new URL(window.location);
      url.searchParams.set("sort", sortValue);
      window.history.pushState({}, '', url.toString());
      maskWithPlaceholders();
      query.sort = sortValue;
      performSearch(query, false);
    }

    $('#result-sort').on('change', function () {
      resortResults();
    });

    function buildPackageCard(pkg) {
      return `<div class="card card-link m-0 disabled mb-3">
        <div class="row g-0 mt-1">
          <div class="col-auto">
            <div class="card-body">
              <div class="avatar avatar-md bg-white mt-1">
                ${orgs[pkg.organization] && orgs[pkg.organization].image_url && orgs[pkg.organization].image_url !== ''
          ? `<img src="${orgs[pkg.organization].image_url}" />`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                           fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                           stroke-linejoin="round"
                           class="text-secondary icon icon-tabler icons-tabler-outline icon-tabler-building-bank">
                           <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                           <path d="M3 21l18 0" />
                           <path d="M3 10l18 0" />
                           <path d="M5 6l7 -3l7 3" />
                           <path d="M4 10l0 11" />
                           <path d="M20 10l0 11" />
                           <path d="M8 14l0 3" />
                           <path d="M12 14l0 3" />
                           <path d="M16 14l0 3" />
                         </svg>`}
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card-body ps-0">
              <div class="row">
                <div class="col-md-11">
                  <h3 class="mb-0">
                    <a class="me-3" href="{{url_for('dashboard_blueprint.dataset_detail', dataset_id='')}}${pkg.id}">${pkg.title || 'Untitled Package'}</a>
                    ${pkg.type === 'workflow'
          ? '<span class="badge bg-purple-lt ms-2">WORKFLOW</span>'
          : pkg.type === 'dataset'
            ? '<span class="badge bg-blue-lt ms-2">DATASET</span>'
            : pkg.type === 'process'
              ? '<span class="badge bg-yellow-lt ms-2">PROCESS</span>'
              : ''}
                    <span class = "text-secondary h4">
                       ${pkg.capacity ? pkg.capacity.charAt(0).toUpperCase() + pkg.capacity.slice(1) : ''}
                    </span>
                  </h3>
                    <p class="text-secondary mt-1">${pkg.notes ? (pkg.notes.length > 250 ? pkg.notes.substring(0, 250) + '...' : pkg.notes) : 'No description specified'}</p>
                </div>
                <div class="col-md-1 d-flex justify-content-end">
                  <button class="btn btn-pill btn-outline-success m-3 me-1 p-1 text-center comparator-btn align-self-center"
                          data-dataset-id="${pkg.id}" title="Add to comparison">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round"
                         class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-git-compare">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M6 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                      <path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                      <path d="M11 6h5a2 2 0 0 1 2 2v8" />
                      <path d="M14 9l-3 -3l3 -3" />
                      <path d="M13 18h-5a2 2 0 0 1 -2 -2v-8" />
                      <path d="M10 15l3 3l-3 3" />
                    </svg>
                  </button>
                </div>
              </div>
              <div class="row">
                <div class="col-md">
                  <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                    <div class="list-inline-item">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           class="icon icon-tabler icon-tabler-building-bank" width="44" height="44"
                           viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                           stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M3 21l18 0" />
                        <path d="M3 10l18 0" />
                        <path d="M5 6l7 -3l7 3" />
                        <path d="M4 10l0 11" />
                        <path d="M20 10l0 11" />
                        <path d="M8 14l0 3" />
                        <path d="M12 14l0 3" />
                        <path d="M16 14l0 3" />
                      </svg>
                      <a class="text-secondary" target="_blank" href="{{ url_for('dashboard_blueprint.organization', organization_id='') }}${orgs[pkg.organization] ? orgs[pkg.organization].id : ''}">
                        ${orgs[pkg.organization] ? orgs[pkg.organization].title : ''}
                      </a>
                    </div>
                    <div class="list-inline-item">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-bolt">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M13.5 21h-7.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5" />
                        <path d="M16 3v4" />
                        <path d="M8 3v4" />
                        <path d="M4 11h16" />
                        <path d="M19 16l-2 3h4l-2 3" />
                      </svg>
                      ${formatIsoDate(pkg.metadata_modified)}
                    </div>
                    <div class="list-inline-item">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                           fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                           stroke-linejoin="round"
                           class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                        <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                      </svg>
                      ${pkg.author || 'Not specified'}
                    </div>

                    ${pkg.license_id ? `
                    <div class="list-inline-item">
                      <span class="text-secondary h4 ms-2" title="Licensed under: ${window.availableLicenses && window.availableLicenses.find(license => license.key === pkg.license_id)
                        ? window.availableLicenses.find(license => license.key === pkg.license_id).title
                        : ''}">
                      ${window.availableLicenses && window.availableLicenses.find(license => license.key === pkg.license_id)
                        ? `<a href="${window.availableLicenses.find(license => license.key === pkg.license_id).url || '#'}" target="_blank">
                          ${window.availableLicenses.find(license => license.key === pkg.license_id).image_url
                        ? `<img src="${window.availableLicenses.find(license => license.key === pkg.license_id).image_url}" style="max-height: 25px;" alt="${window.availableLicenses.find(license => license.key === pkg.license_id).title}" />`
                        : window.availableLicenses.find(license => license.key === pkg.license_id).title}
                          </a>`
                        : ''}
                      </span>
                    </div>` : ''}
                  </div>
                </div>
              </div>
              <div class="row d-flex mt-2">
                <div class="col-md-auto ms-auto">
                  <div class="badges">
                    ${pkg.tags && pkg.tags.length ? 
                      (pkg.tags.length > 5 ? 
                        pkg.tags.slice(0, 5).map(tag => `<a class="card-link text-black tag m-1 mb-0" href="{{ url_for('dashboard_blueprint.catalog') }}?sort=metadata_modified+desc&tags=${encodeURIComponent(tag)}">${tag}</a>`).join('') + 
                        `<p class="text-secondary d-inline-block m-1 mb-0" title="${pkg.tags.slice(5).join(', ')}">+ ${pkg.tags.length - 5} more...</p>` 
                        : 
                        pkg.tags.map(tag => `<a class="card-link text-black tag m-1 mb-0" href="{{ url_for('dashboard_blueprint.catalog') }}?sort=metadata_modified+desc&tags=${encodeURIComponent(tag)}">${tag}</a>`).join('')
                      ) 
                      : ''}
                  </div>
                </div>                 
              </div>
            </div>
          </div>
        </div>`;
    }

    function buildPackageCards(packages) {
      if (packages) {
        $("#package-list").html("");
        packages.forEach(pkg => {
          $("#package-list").append(buildPackageCard(pkg));
        });
      }
    }

    function buildFacet(facet, count, value, display, checked = false) {
      if (facet) {
        if (display) {
          return `<label class="form-check tag-item">
            <input type="checkbox" class="form-check-input query-param" name="form-type[]" value="${facet}" ${checked ? 'checked' : ''}>
            <div class="d-flex">
            <span class="form-check-label">${facet}</span>
            <span class="badge ms-auto text-light-fg ms-2">${count}</span>
            </div>
          </label>`;
        } else {
          return `<label class="form-check tag-item more-tag" style="display: none;">
            <input type="checkbox" class="form-check-input query-param" name="form-type[]" value="${facet}" ${checked ? 'checked' : ''}>
            <div class="d-flex">
            <span class="form-check-label">${facet}</span>
            <span class="badge ms-auto text-light-fg ms-2">${count}</span>
            </div>
          </label>`;
        }
      }
    }

    function createShowAllFacetButton(facet, facetContainerId) {
      return `<a class="toggle-facet-btn me-1 mb-1 cursor-pointer" data-expanded="false" onclick="
          var container = document.getElementById('${facetContainerId}');
          var moreTags = container.querySelectorAll('.more-tag');
          var btn = this;
          if (btn.getAttribute('data-expanded') === 'true') {
            moreTags.forEach(el => el.style.display = 'none');
            btn.innerHTML = 'Show All <svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;24&quot; height=&quot;24&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; class=&quot;me-2 icon icon-tabler icons-tabler-outline icon-tabler-chevron-down&quot;><path stroke=&quot;none&quot; d=&quot;M0 0h24v24H0z&quot; fill=&quot;none&quot;/><path d=&quot;M6 9l6 6l6 -6&quot; /></svg>';
            btn.setAttribute('data-expanded','false');
          } else {
            moreTags.forEach(el => el.style.display = 'block');
            btn.innerHTML = 'Show Less <svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;24&quot; height=&quot;24&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; class=&quot;me-2 icon icon-tabler icons-tabler-outline icon-tabler-chevron-up&quot;><path stroke=&quot;none&quot; d=&quot;M0 0h24v24H0z&quot; fill=&quot;none&quot;/><path d=&quot;M6 15l6 -6l6 6&quot; /></svg>';
            btn.setAttribute('data-expanded','true');
          }
        ">
        Show All
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-chevron-down">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M6 9l6 6l6 -6" />
        </svg>
        </a>`;
    }

    function resetCheckedFilters() {
      $('#facet-tags input[type="checkbox"]').prop('checked', false);
      $('#facet-author input[type="checkbox"]').prop('checked', false);
      $('#facet-organization input[type="checkbox"]').prop('checked', false);
      $('#facet-format input[type="checkbox"]').prop('checked', false);
      removeAllFiltersFromLocation();
    }

    function sanitizeFilter(filter) {
      // Convert filter to String and remove any special characters except hyphens to create a valid HTML ID
      return String(filter).replace(/[^a-zA-Z0-9-]/g, '_');
    }

    function buildFacets(facets) {
      if (facets) {
        // The facets are stored in the global variable
        // so that way even if the query limits the number of results
        // the entirety of facets are still available for the user to filter
        for (const [key, value] of Object.entries(facets)) {
          if (key == "tags") {
            const entries = Object.entries(value);
            $("#facet-tags").html("");
            let i = 0;
            for (let [tag, count] of entries) {
              // If the current tag is included in badges-list then create it as checked
              // Remove any / from the tag to avoid issues with HTML IDs
              if ($('#filter-tags-' + sanitizeFilter(tag)).length > 0) {
                var checked = true;
              } else {
                var checked = false;
              }
              var facetElement = $(buildFacet(tag, count, key, i < 8, checked));
              facetElement.find('input').on('change', function () {
                var val = $(this).val();
                if ($(this).is(':checked')) {
                  appendFilterBadge(key, val);
                  appendFilterToLocation(key, val);
                } else {
                  removeFilterBadge(key, val);
                  removeFilterFromLocation(key, val);
                }
              });
              $("#facet-tags").append(facetElement);
              i++;
            }
            if (entries.length > 8) {
              $("#facet-tags").after(createShowAllFacetButton(key, "facet-tags"));
            }
          } else if (key == "author") {
            const entries = Object.entries(value);
            $("#facet-author").html("");
            let i = 0;
            for (const [author, count] of entries) {
              // If the current author is included in badges-list then create it as checked
              if ($('#filter-author-' + author).length > 0) {
                var checked = true;
              } else {
                var checked = false;
              }
              var facetElement = $(buildFacet(author, count, key, i < 8, checked));
              facetElement.find('input').on('change', function () {
                var val = $(this).val();
                if ($(this).is(':checked')) {
                  appendFilterBadge(key, val);
                  appendFilterToLocation(key, val);
                } else {
                  removeFilterBadge(key, val);
                  removeFilterFromLocation(key, val);
                }
              });
              $("#facet-author").append(facetElement);
              i++;
            }
            if (entries.length > 8) {
              $("#facet-author").after(createShowAllFacetButton(key, "facet-author"));
            }
          } else if (key == "organization") {
            const entries = Object.entries(value);
            $("#facet-organization").html("");
            let i = 0;
            for (const [organization, count] of entries) {
              // If the current organization is included in badges-list then create it as checked
              if ($('#filter-organization-' + organization).length > 0) {
                var checked = true;
              } else {
                var checked = false;
              }
              var facetElement = $(buildFacet(organization, count, key, i < 8, checked));
              facetElement.find('input').on('change', function () {
                var val = $(this).val();
                if ($(this).is(':checked')) {
                  appendFilterBadge(key, val);
                  appendFilterToLocation(key, val);
                } else {
                  removeFilterBadge(key, val);
                  removeFilterFromLocation(key, val);
                }
              });
              $("#facet-organization").append(facetElement);
              i++;
            }
            if (entries.length > 8) {
              $("#facet-organization").after(createShowAllFacetButton(key, "facet-organization"));
            }
          } else if (key == "res_format") {
            const entries = Object.entries(value);
            $("#facet-format").html("");
            let i = 0;
            for (let [format, count] of entries) {
              // If the current format is included in badges-list then create it as checked
              format_curated = format.replace(/[^a-zA-Z0-9]/g, '_');
              if ($('#filter-res_format-' + format_curated).length > 0) {
                var checked = true;
              } else {
                var checked = false;
              }
              var facetElement = $(buildFacet(format, count, key, i < 8, checked));
              facetElement.find('input').on('change', function () {
                var val = $(this).val();
                if ($(this).is(':checked')) {
                  appendFilterBadge(key, val);
                  appendFilterToLocation(key, val);
                } else {
                  removeFilterBadge(key, val);
                  removeFilterFromLocation(key, val);
                }
              });
              $("#facet-format").append(facetElement);
              i++;
            }
            if (entries.length > 8) {
              $("#facet-format").after(createShowAllFacetButton(key, "facet-format"));
            }
          }
        }
      }
    }


    function addSpatialFilter() {
      if (drawnPolygon) {
        // Extract bounds (minX, minY, maxX, maxY) in WGS 84 (EPSG:4326)
        var bounds = drawnPolygon.getBounds();
        var minX = bounds.getWest();
        var minY = bounds.getSouth();
        var maxX = bounds.getEast();
        var maxY = bounds.getNorth();
        spatialCoverage = [minX, minY, maxX, maxY];
        // Remove any existing spatial filter
        removeFilterFromLocation("bbox", null);
        removeFilterBadge("bbox", null);

        // Add the new spatial filter to the URL
        appendFilterToLocation("bbox", spatialCoverage ? spatialCoverage.join(",") : "");
        appendFilterBadge("bbox", spatialCoverage ? spatialCoverage.join(",") : "No spatial coverage defined");
        $('#spatial-search-modal').modal('hide');
      } else {
        // Remove any existing spatial filter
        removeFilterFromLocation("bbox", null);
        removeFilterBadge("bbox", null);
        spatialCoverage = null;
      }
    }

    function showResultPolygon(dataset) {
      var bounds = [
        [dataset.miny, dataset.minx],
        [dataset.miny, dataset.maxx],
        [dataset.maxy, dataset.maxx],
        [dataset.maxy, dataset.minx]
      ];

      var randomColor = '#' + Math.floor(Math.random() * 16777215)
        .toString(16).padStart(6, '0');

      // Annotate the polygon with isResultPolygon set to true.
      var polygon = L.polygon(bounds, {
        color: randomColor,
        weight: 2,
        fillOpacity: 0.2,
        isResultPolygon: true
      }).addTo(searchMap);

      polygon.bindPopup(
        `<strong>${dataset.title}</strong><br>
        Organization: ${dataset.organization}<br>
        Creator: ${dataset.author || 'N/A'}<br>
        Tags: ${dataset.tags.join(', ')}<br>
        <a href="{{url_for('dashboard_blueprint.dataset_detail', dataset_id='')}}${encodeURIComponent(dataset.id)}" target="_blank">View Details</a>`
      );

      // Open popup on click so that links remain clickable
      polygon.on('click', function (e) {
        this.openPopup(e.latlng);
      });

      // Remove the polygon on right-click (contextmenu)
      polygon.on('contextmenu', function (e) {
        searchMap.removeLayer(polygon);
      });
    }

    function clearAllResultPolygons() {
      // Remove all polygons that were added as result polygons
      for (const key in searchMap._layers) {
        const layer = searchMap._layers[key];
        if (layer instanceof L.Polygon && layer.options.isResultPolygon) {
          searchMap.removeLayer(layer);
        }
      }
    }


    function fetchAvailableLicenses(callback) {
      $.ajax({
        url: "{{url_for('catalog_blueprint.api_fetch_licenses')}}",
        method: "GET",
        success: function (response) {
          if (response.success) {
            window.availableLicenses = response.result;
            // Populate the license dropdown in the publishing modal
            var licenseSelect = $('#license-id');
            licenseSelect.empty();

            licenseSelect.append($('<option></option>').attr('value', '').text('Select License'));

            window.availableLicenses.forEach(function (license) {
              var option = $('<option></option>')
                .attr('value', license.key)
                .text(license.title + ' - (' + license.key + ')');
              if (license.image_url) {
                option.attr('data-image', license.image_url);
              }
              licenseSelect.append(option);
            });

          } else {
            console.error("Failed to fetch available licenses:", response.message);
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX request for available licenses failed:", error);
        }
      });
      if (typeof callback === "function") {
        callback();
      }
    }

    function performSpatialSearch() {
      fl = [
        "id",
        "title",
        "notes",
        "author",
        "organization",
        "tags",
        "metadata_modified",
        "capacity",
        "minx",
        "miny",
        "maxx",
        "maxy",
        "type"
      ];

      //Remove any result polygons from previous searches
      clearAllResultPolygons();

      if (drawnPolygon) {
        // Extract bounds (minX, minY, maxX, maxY) in WGS 84 (EPSG:4326)
        var bounds = drawnPolygon.getBounds();
        var minX = bounds.getWest();
        var minY = bounds.getSouth();
        var maxX = bounds.getEast();
        var maxY = bounds.getNorth();
        spatialCoverage = [minX, minY, maxX, maxY];
      } else {
        spatialCoverage = null;
      }

      $('#spatial-search-modal-footer .alert').remove()
      $('#spatial-search-modal-footer .stelar-loader').remove()
      $('#spatial-search-modal-footer').prepend(createLoaderElement(false, true))

      if (spatialCoverage) {
        $.ajax({
          url: "{{url_for('catalog_blueprint.api_search_datasets')}}",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ fl: fl, bbox: spatialCoverage }),
          success: function (response) {
            if (response.success) {
              $('#spatial-search-modal-footer .stelar-loader').remove();
              $('#spatial-search-modal-footer .alert').remove();
              $('#spatial-search-modal-footer').prepend(createAlertElement("success", "Spatial search completed successfully"));
              setTimeout(function () {
                $('#spatial-search-modal-footer .alert').fadeOut(500, function () {
                  $(this).remove();
                });
              }, 3000);

              // Remove the polygon used for the search from the map, if it exists
              if (drawnPolygon) {
                // Instead of removing the drawnPolygon, update its style to a dashed gray border with a light gray fill
                drawnPolygon.setStyle({
                  color: 'gray',
                  dashArray: '5,5',
                  fillColor: 'lightgray',
                  fillOpacity: 0.5
                });
              }
              // Remove all previously added result polygons (assuming they were marked with isResultPolygon:true)
              for (const key in searchMap._layers) {
                const layer = searchMap._layers[key];
                if (layer !== drawnPolygon && layer.options && layer.options.isResultPolygon) {
                  searchMap.removeLayer(layer);
                }
              }

              response.result.results.forEach(function (dataset) {
                showResultPolygon(dataset);
              });

            } else {
              $('#spatial-search-modal-footer .stelar-loader').remove()
              $('#spatial-search-modal-footer .alert').remove()
              $('#spatial-search-modal-footer').prepend(createAlertElement("danger", "Spatial search failed: " + response.message));
              console.error("Spatial search failed:", response.message);
            }
          },
          error: function (xhr, status, error) {
            console.error("AJAX spatial search request failed:", error);
          }
        });
      }
      else {
        $('#spatial-search-modal-footer .stelar-loader').remove()
        console.warn("No spatial coverage defined. Please draw a rectangle on the map.");
      }
    }

    // Render the filter badges based on the current query parameters
    // Disable the query params to prevent them from being modified by the user while the search is performed
    renderFilterBadges();
    lockQueryParams();

    $(document).ready(function () {
      // Fetch available licenses and run performSearch only after its completion.
      fetchAvailableLicenses(function () {
        // Call fetchOrganizations and run performSearch only after its completion.
        fetchOrganizations(function () {
          performSearch(query, false);
          fetchDefaultFacets();
        });
      });
    });

  </script>

  <!-- Spatial Modal Map -->
  <script>
    // Initialize the map
    var searchMap = L.map('search-map', {
      center: [38.6137, 24.6116],
      zoom: 3,
    });

    // Base layers
    var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });

    var topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    });

    // Add the default layer to the map
    streetLayer.addTo(searchMap);

    // Layer control
    var baseLayers = {
      "Street Map": streetLayer,
      "Topographical Map": topoLayer
    };

    L.control.layers(baseLayers).addTo(searchMap);

    // Feature Group to store the single drawn polygon
    var drawnPolygon = null;

    // Add drawing controls
    var drawControl = new L.Control.Draw({
      edit: false, // Disable bulk editing
      draw: {
        polygon: false,
        polyline: false,
        rectangle: true,
        circle: false,
        marker: false,
        circlemarker: false
      }
    });

    const resetControl = L.Control.extend({
      options: { position: 'topleft' },

      onAdd: function (map) {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        container.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><line x1="4" y1="7" x2="20" y2="7"></line><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path></svg>';
        container.style.cursor = 'pointer';
        container.style.backgroundColor = 'white';
        container.style.padding = '5px';

        container.onclick = function () {
          if (confirm("Remove all shapes from the map?")) {
            if (drawnPolygon) {
              searchMap.removeLayer(drawnPolygon);
              searchMap.eachLayer(function (layer) {
                if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                  searchMap.removeLayer(layer);
                }
              });

              drawnPolygon = null;
              $('#add-spatial-filter-btn').addClass('disabled');
            }
          }
        };

        return container;
      }
    });

    searchMap.addControl(new resetControl());
    searchMap.addControl(drawControl);

    // Handle the creation of new shapes
    searchMap.on('draw:created', function (e) {
      var layer = e.layer;

      // Remove the previous polygon, if any
      if (drawnPolygon) {
        searchMap.removeLayer(drawnPolygon);
      }

      drawnPolygon = layer;
      drawnPolygon.addTo(searchMap);

      // Enable the add-spatial-filter-btn
      $('#add-spatial-filter-btn').removeClass('disabled');

      drawnPolygon.on('click', function () {
        var editToolbar = new L.EditToolbar.Edit(searchMap, {
          featureGroup: L.featureGroup([drawnPolygon]),
        });
        editToolbar.enable();

        // Add a cancel button to the map
        var cancelButton = L.control({ position: 'topright' });
        cancelButton.onAdd = function () {
          var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
          div.innerHTML = '<button class="btn btn-danger">Cancel</button>';
          div.style.cursor = 'pointer';
          div.style.backgroundColor = 'white';
          div.style.padding = '5px';
          div.onclick = function () {
            editToolbar.disable(); // Disable editing
            searchMap.removeControl(cancelButton); // Remove the cancel button
          };
          return div;
        };
        cancelButton.addTo(searchMap);
      });

    });

    const spatialModal = document.getElementById('spatial-search-modal');
    spatialModal.addEventListener('shown.bs.modal', function () {
      searchMap.invalidateSize();
    });
  </script>

  <script>
    function setCookie(name, value, minutes) {
      var expires = "";
      if (minutes) {
        var date = new Date();
        date.setTime(date.getTime() + (minutes * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function appendClearAllOption() {
      if ($('#clear-all-datasets').length === 0) {
        $('#compare-dataset-options').append(`
        <div class="dropdown-item cursor-pointer text-center text-danger" id="clear-all-datasets" data-dataset-id="__clearall__" onclick="clearAllCompareDatasets()">
        Clear All
        </div>
      `);
      }
    }

    function appendDatasetCompareOption(datasetName, id) {
      $('#compare-dataset-options').append(`
        <div class="dropdown-item d-flex justify-content-between align-items-center" id="compare-dataset-option-${id}">
          ${datasetName} 
          <span class="ms-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger cursor-pointer icon icon-tabler icons-tabler-outline icon-tabler-trash remove-dataset" data-dataset-id="${id}">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M4 7l16 0" />
          <path d="M10 11l0 6" />
          <path d="M14 11l0 6" />
          <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
            </svg>
          </span>
        </div>
          `);
    }

    function refreshDatasetCompareOption(selectedIds) {
      // Remove any options not in selectedIds
      $('#compare-dataset-options .dropdown-item').each(function () {
        var datasetId = $(this).find('.remove-dataset').data('dataset-id');
        if (datasetId && datasetId.toString() === '__clearall__') {
          return;
        }
        if (datasetId && !selectedIds.includes(datasetId.toString())) {
          $(this).remove();
        }
      });

      // Add options for selectedIds
      selectedIds.forEach(function (id) {
        if ($(`#compare-dataset-option-${id}`).length === 0) {
          $.get(`{{url_for('catalog_blueprint.api_get_dataset', entity_id='')}}${id}`, function (data) {
            appendDatasetCompareOption(data.result.title, id);
          });
        }
      });

      $('#dataset-compare-number').text(`(${selectedIds.length})`);
      appendClearAllOption();
    }

    function clearAllCompareDatasets() {
      setCookie('compare_datasets', '', -1);
      $('#compare-dataset-options').empty();
      $('.comparator-btn').removeClass('btn-success').addClass('btn-outline-success');
      $('#dataset-compare-number').text(`(0)`);
      appendClearAllOption();
    }

    function attachComparatorButtonListeners() {
      $('.comparator-btn').off('click');
      $('.comparator-btn').on('click', function () {
        var datasetId = $(this).data('dataset-id');
        if (!datasetId) {
          console.error("Dataset ID not found!");
          return;
        }

        var cookieValue = getCookie('compare_datasets');
        var selectedIds = cookieValue ? cookieValue.split(',') : [];

        // If this dataset is already selected, remove it
        if (selectedIds.indexOf(datasetId.toString()) !== -1) {
          selectedIds = selectedIds.filter(id => id !== datasetId.toString());
          setCookie('compare_datasets', selectedIds.join(','), 30); // Cookie valid for 30 minutes
          $(this).removeClass('btn-success').addClass('btn-outline-success');
          refreshDatasetCompareOption(selectedIds);
        } else {
          // If this dataset isn't already selected, add it
          if (selectedIds.length < 5) {
            selectedIds.push(datasetId);
            setCookie('compare_datasets', selectedIds.join(','), 30);
            $(this).removeClass('btn-outline-success').addClass('btn-success');
            refreshDatasetCompareOption(selectedIds);
            if (selectedIds.length == 2) {
              $('#toast-message-info').removeClass('hide').addClass('show').addClass('fade');
              $('#toast-info-body').html("Looks like you have selected packages for comparison. Compare them <a href='{{url_for('dashboard_blueprint.dataset_compare')}}'>here</a>");
            }
          } else {
            $('#toast-message-alert').removeClass('hide').addClass('show').addClass('fade');
            $('#toast-message-body').text("Max 5 datasets can be compared at a time");
          }
        }
      });
    }

    function renderSelectedComparators() {
      var cookieValue = getCookie('compare_datasets');
      var selectedIds = cookieValue ? cookieValue.split(',') : [];

      selectedIds.forEach(function (id) {
        $('.comparator-btn[data-dataset-id="' + id + '"]').removeClass('btn-outline-success').addClass('btn-success');
      });

      refreshDatasetCompareOption(selectedIds);

      // Handle removal of datasets from the dropdown and cookie
      $(document).on('click', '.remove-dataset', function () {
        var datasetId = $(this).data('dataset-id');
        var cookieValue = getCookie('compare_datasets');
        var selectedIds = cookieValue ? cookieValue.split(',') : [];

        // Remove the dataset ID from the selected IDs
        selectedIds = selectedIds.filter(id => id !== datasetId.toString());
        setCookie('compare_datasets', selectedIds.join(','), 30);
        refreshDatasetCompareOption(selectedIds);
        $(`#compare-dataset-option-${datasetId}`).remove();
        $(`.comparator-btn[data-dataset-id="${datasetId}"]`).removeClass('btn-success').addClass('btn-outline-success');
      });
    }

  </script>



  <script>

    function publishDataset() {

      const title = $('input[name="package-name-input"]').val().trim();
      const notes = $('textarea[name="packageDescription"]').val().trim();
      const tags = $('#hiddenTagsInput').val().split(',').filter(tag => tag.trim() !== '');
      const ownerOrg = $('#owner-org').val();
      const private = $('input[name="package-visibility"]:checked').val() === 'private'
      const licenseId = $('#license-id').val();

      $('#new-dataset-modal-footer .stelar-loader').remove();
      $('#new-dataset-modal-footer .alert').remove();

      if (!title || !notes || tags.length === 0) {
        $('#new-dataset-modal-footer').prepend(createAlertElement('danger', 'Please fill in all fields.'));
        return;
      }

      const payload = {
        name: slugifyTitle(title),
        title: title,
        notes: notes,
        tags: tags,
        'owner_org': ownerOrg,
        private: private,
      };

      if (licenseId) {
        payload.license_id = licenseId;
      }

      $("#new-dataset-modal-footer").prepend(createLoaderElement(false, false));

      $.ajax({
        url: `{{ url_for('catalog_blueprint.api_create_dataset') }} `,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function (response) {
          $('#new-dataset-modal-footer .stelar-loader').remove();
          $('#new-dataset-modal-footer').prepend(createAlertElement('success', 'Dataset Published Successfully'));
          setTimeout(function () {
            $('#new-dataset-modal-footer .alert').fadeOut(500, function () {
              $(this).remove();
            });
          }, 3000);
        },
        error: function (xhr) {
          $('#new-dataset-modal-footer .stelar-loader').remove();
          $('#new-dataset-modal-footer').prepend(createAlertElement('danger', 'Error publishing dataset.'));
          setTimeout(function () {
            $('#new-dataset-modal-footer .alert').fadeOut(500, function () {
              $(this).remove();
            });
          }, 3000);
        }
      });

    }

    $(document).ready(function () {
      const titleInput = $('input[name="package-name-input"]');
      titleInput.on('input', function () {
        titleInput.removeClass('is-valid is-invalid');
      });
    });

    function fetchOrganizations(callback) {
      $.ajax({
        url: '{{ url_for("catalog_blueprint.api_fetch_organizations") }}',
        method: 'GET',
        dataType: 'json',
        success: function (data) {
          // Clear the owner organization dropdown
          $('#owner-org').empty();
          window.orgs = window.orgs || {};
          if (data.result.length > 0) {
            for (var i = 0; i < data.result.length; i++) {
              var org = data.result[i];
              // Append the option element
              $('#owner-org').append(`<option value="${org.name}">${org.title}  |  ${org.name}</option>`);
              // Set organization keyed by its name
              window.orgs[org.name] = org;
            }
          }
          if (callback && typeof callback === 'function') {
            callback();
          }
        },
        error: function (xhr, status, error) {
          if (xhr.status === 401) {
            window.location.href = '/';
          }
        }
      });
    }

    function slugifyTitle(title) {
      return title
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s]/g, '') // Remove any character that is not a letter, number, or space
        .replace(/\s+/g, '-'); // Replace spaces with underscores
    }

    function checkNameAvailability() {
      const titleInput = $('input[name="package-name-input"]');
      const title = titleInput.val().trim();

      if (title === '') {
        return;
      }

      titleInput.removeClass('is-valid is-invalid');
      $("#availability-div").prepend(createLoaderElement(true, true));

      $.ajax({
        url: `{{ url_for('catalog_blueprint.api_get_dataset', entity_id = '') }}${slugifyTitle(title)}`,
        method: 'GET',
        success: function (response) {
          // If the response is 200, a dataset already exists
          $('#availability-div .spinner-border').remove()
          titleInput.addClass('is-invalid');
        },
        error: function (xhr) {
          if (xhr.status === 404) {
            // If the response is 404, a dataset doesn't exist
            $('#availability-div .spinner-border').remove()
            titleInput.addClass('is-valid');
          } else {
            $('#availability-div .spinner-border').remove()
          }
        }
      });
    }
  </script>


  <script>
    const tagInput = document.getElementById('tagInput');
    const tagsContainer = document.getElementById('tagsContainer');
    const hiddenTagsInput = document.getElementById('hiddenTagsInput');

    let tags = [];

    function renderTags() {
      tagsContainer.innerHTML = '';

      // Add each tag as a span with a close button
      tags.forEach((tag, index) => {
        const tagElement = document.createElement('span');
        tagElement.classList.add('tag', 'me-2', 'mb-2');

        tagElement.innerHTML = `
            ${tag}
    <a href="#" class="btn-close ms-1" data-index="${index}"></a>
          `;

        // Append the tag element to the container
        tagsContainer.appendChild(tagElement);
      });

      // Add event listeners to each close button
      const closeButtons = document.querySelectorAll('.btn-close');
      closeButtons.forEach(button => {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          const index = button.getAttribute('data-index');
          removeTag(index);
        });
      });

      // Update the hidden input with the current tags as a comma-separated string
      hiddenTagsInput.value = tags.join(',');
    }

    // Function to remove a tag by index
    function removeTag(index) {
      tags.splice(index, 1);
      renderTags();
    }

    // Function to handle input and add tag
    tagInput.addEventListener('keydown', function (event) {
      // If Enter is pressed, add the tag
      if (event.key === 'Enter') {
        event.preventDefault();
        const newTag = tagInput.value.trim();

        if (newTag !== '' && !tags.includes(newTag)) {
          tags.push(newTag);
          tagInput.value = ''; // Clear the input after adding the tag
          renderTags();
        }
      }

      // If backspace is pressed and input is empty, remove the last tag
      if (event.key === 'Backspace' && tagInput.value === '') {
        tags.pop();
        renderTags();
      }
    });
  </script>
</body>

</html>