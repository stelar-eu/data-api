<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>STELAR | Datasets</title>
    <!-- CSS files -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">    
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Leaflet PM CSS (for polygon editing) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.css" />

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="{{ url_for('static', filename='images.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='stelar.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png">
  </head>
  <body >
    <div class="page">
      <!-- Navbar -->
      {%  include 'header.html' %}
      <div class="page-wrapper">
        <!-- Page header -->
         <!-- Page header -->
        <div class="page-header d-print-none">
            <div class="container-xl">
              <div class="row g-2 align-items-center">
                <div class="col">
                  <!-- Page pre-title -->
                  <div class="page-pretitle">
                    Datasets
                  </div>
                  <h2 class="page-title">
                    Browse & Manage Datasets
                  </h2>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-new-dataset">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
                      Publish New Dataset
                    </a>
                </div>
              </div>
            </div>
          </div>
        <!-- Page body -->
        <div class="page-body">
          <div class="container-xl">
            <div class="row g-4">
              <div class="col-md-3">

                  <div class="form-label">Spatial Queries</div>
                  <a data-bs-toggle="modal" data-bs-target="#spatial-search-modal" href="#" class="mb-4 card card-link m" style="height: 15%;" id="map">

                  </a>
                 
                  <div class="form-label">Tags</div>
                  <div class="mb-4">
                    <label class="form-check">
                      <input type="checkbox" class="form-check-input" name="form-type[]" value="1" checked>
                      <span class="form-check-label">Geo-Spatial Data</span>
                    </label>
                    <label class="form-check">
                      <input type="checkbox" class="form-check-input" name="form-type[]" value="2" checked>
                      <span class="form-check-label">Greek Farms</span>
                    </label>
                    <label class="form-check">
                      <input type="checkbox" class="form-check-input" name="form-type[]" value="3">
                      <span class="form-check-label">NL Weather Data</span>
                    </label>
                  </div>
                  <div class="form-label">Resource Formats</div>
                  <div class="mb-4">
                    <label class="form-check">
                      <input type="checkbox" class="form-check-input" name="form-type[]" value="1" checked>
                      <span class="form-check-label">JSON</span>
                    </label>
                    <label class="form-check">
                      <input type="checkbox" class="form-check-input" name="form-type[]" value="2" checked>
                      <span class="form-check-label">XML</span>
                    </label>
                    <label class="form-check">
                      <input type="checkbox" class="form-check-input" name="form-type[]" value="3">
                      <span class="form-check-label">CSV</span>
                    </label>
                  </div>

                  <div class="mt-5">
                    <button class="btn btn-primary w-100">
                      Apply filters
                    </button>
                    <a href="#" class="btn btn-link w-100">
                      Reset to defaults
                    </a>
                  </div>
              </div>
              <div class="col-md-9">
                <div class="mb-4">
                  <div class="input-icon">
                      <span class="input-icon-addon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
                      </span>
                      <input type="text" value="" class="form-control" placeholder="Search Datasets (ID, Tags, Keywords, etc.)" id="workflow-search-box" aria-label="Workflow Filtered Search">
                  </div>
                </div>
                <ul class="pagination d-flex justify-content-end">
                  {% if page_number > 1 %}
                      <!-- Previous Button -->
                      <li class="page-item">
                          <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=page_number - 1) }}" aria-label="Previous">
                              <span aria-hidden="true">&laquo; prev</span>
                          </a>
                      </li>
                  {% endif %}
                  
                  <!-- First Page Button -->
                  {% if total_pages > 1 %}
                      <li class="page-item {% if page_number == 1 %}active{% endif %}">
                          <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=1) }}">1</a>
                      </li>
                  {% endif %}
                  
                  <!-- Handle Middle Pages -->
                  {% if total_pages > 8 %}
                      {% if page_number > 4 %}
                          <li class="page-item disabled"><span class="page-link">...</span></li>
                      {% endif %}
                      
                      {% for page in range(page_number - 2, page_number + 3) %}
                          {% if page > 1 and page < total_pages %}
                              <li class="page-item {% if page == page_number %}active{% endif %}">
                                  <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=page) }}">{{ page }}</a>
                              </li>
                          {% endif %}
                      {% endfor %}
                      
                      {% if page_number < total_pages - 3 %}
                          <li class="page-item disabled"><span class="page-link">...</span></li>
                      {% endif %}
                  {% else %}
                      {% for page in range(2, total_pages) %}
                          <li class="page-item {% if page == page_number %}active{% endif %}">
                              <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=page) }}">{{ page }}</a>
                          </li>
                      {% endfor %}
                  {% endif %}
                  
                  <!-- Last Page Button -->
                  {% if total_pages > 1 %}
                      <li class="page-item {% if page_number == total_pages %}active{% endif %}">
                          <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=total_pages) }}">{{ total_pages }}</a>
                      </li>
                  {% endif %}
                  
                  {% if page_number < total_pages %}
                      <!-- Next Button -->
                      <li class="page-item">
                          <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=page_number + 1) }}" aria-label="Next">
                              <span aria-hidden="true">next &raquo;</span>
                          </a>
                      </li>
                  {% endif %}
              </ul>
                <div class="row row-cards">
                  <div class="space-y" id='dataset-container'>
                    {% if datasets %}
                    {% for dataset in datasets %}
                    <div class="card mb-3">
                      <div class="row g-0">
                        <div class="col-auto">
                          <div class="card-body">
                            <div class="avatar avatar-md" style="background-image: url({{ PARTNER_IMAGE_SRC }})"></div>
                          </div>
                        </div>
                        <div class="col">
                          <div class="card-body ps-0">
                            <div class="row">
                              <div class="col">
                                <h3 class="mb-0">
                                  <a href="{{url_for('dashboard_blueprint.datasets')}}/{{ dataset.get('id') }}">{{ dataset.get('title', 'Untitled Dataset') }}</a>
                                  {% if 'Workflow' in dataset.get('tags') %}
                                    <span class="badge bg-purple-lt ms-2">WORKFLOW</span>
                                  {% else %}
                                    <span class="badge bg-blue-lt ms-2">DATASET</span>
                                  {% endif %}
                                </h3>
                                <p class="text-secondary mt-1">{{ dataset.get('notes', 'No description specified') }}</p>
                              </div>
                            </div>
                            <div class="row">
                              <div class="col-md">
                                <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                                  <div class="list-inline-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-building-bank" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                      <path d="M3 21l18 0" />
                                      <path d="M3 10l18 0" />
                                      <path d="M5 6l7 -3l7 3" />
                                      <path d="M4 10l0 11" />
                                      <path d="M20 10l0 11" />
                                      <path d="M8 14l0 3" />
                                      <path d="M12 14l0 3" />
                                      <path d="M16 14l0 3" />
                                    </svg>
                                    {{ dataset.get('organization') }}
                                  </div>
                                  <div class="list-inline-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-month" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                      <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z" />
                                      <path d="M16 3v4" />
                                      <path d="M8 3v4" />
                                      <path d="M4 11h16" />
                                      <path d="M7 14h.013" />
                                      <path d="M10.01 14h.005" />
                                      <path d="M13.01 14h.005" />
                                      <path d="M16.015 14h.005" />
                                      <path d="M13.015 17h.005" />
                                      <path d="M7.01 17h.005" />
                                      <path d="M10.01 17h.005" />
                                    </svg>
                                    {{ dataset.get('metadata_modified') | format_datetime or dataset.get('metadata_created') | format_datetime }}
                                  </div>
                                  <div class="list-inline-item">
                                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="#2c3e50"  stroke-width="1.5"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-user"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /></svg>
                                    {{ dataset.get('author', 'Not specfied')}}
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-auto">
                                <div class="mt-3 badges">
                                  {% for tag in dataset.get('tags') %}
                                    <span class="tag m-1 mb-0">{{ tag }}</span>
                                  {% endfor %}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}               
                  {% else %}
                    <h3>No Datasets Found</h3>
                  {% endif %}
                  </div>
                </div>
                <ul class="pagination d-flex justify-content-end">
                  {% if page_number > 1 %}
                      <!-- Previous Button -->
                      <li class="page-item">
                          <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=page_number - 1) }}" aria-label="Previous">
                              <span aria-hidden="true">&laquo; prev</span>
                          </a>
                      </li>
                  {% endif %}
                  
                  <!-- First Page Button -->
                  {% if total_pages > 1 %}
                      <li class="page-item {% if page_number == 1 %}active{% endif %}">
                          <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=1) }}">1</a>
                      </li>
                  {% endif %}
                  
                  <!-- Handle Middle Pages -->
                  {% if total_pages > 8 %}
                      {% if page_number > 4 %}
                          <li class="page-item disabled"><span class="page-link">...</span></li>
                      {% endif %}
                      
                      {% for page in range(page_number - 2, page_number + 3) %}
                          {% if page > 1 and page < total_pages %}
                              <li class="page-item {% if page == page_number %}active{% endif %}">
                                  <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=page) }}">{{ page }}</a>
                              </li>
                          {% endif %}
                      {% endfor %}
                      
                      {% if page_number < total_pages - 3 %}
                          <li class="page-item disabled"><span class="page-link">...</span></li>
                      {% endif %}
                  {% else %}
                      {% for page in range(2, total_pages) %}
                          <li class="page-item {% if page == page_number %}active{% endif %}">
                              <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=page) }}">{{ page }}</a>
                          </li>
                      {% endfor %}
                  {% endif %}
                  
                  <!-- Last Page Button -->
                  {% if total_pages > 1 %}
                      <li class="page-item {% if page_number == total_pages %}active{% endif %}">
                          <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=total_pages) }}">{{ total_pages }}</a>
                      </li>
                  {% endif %}
                  
                  {% if page_number < total_pages %}
                      <!-- Next Button -->
                      <li class="page-item">
                          <a class="page-link" href="{{ url_for('dashboard_blueprint.datasets', page_number=page_number + 1) }}" aria-label="Next">
                              <span aria-hidden="true"> next &raquo;</span>
                          </a>
                      </li>
                  {% endif %}
              </ul>
              </div>
            </div>
          </div>
          <div class="modal modal-blur fade" id="spatial-search-modal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog me-6 ms-6 mt-2 modal-full-width modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Spatial Search </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                
                  <div class="row">
                    <div class="col-lg-2">
                      <div class="h3">Saved Polygons</div>
                      <p class="text-secondary text-sm ">Here you may find any saved polygons in the STELAR KLMS, used in previous searches.</p>
                      <ul id="savedPolygonList" class="list-group">
                          
                      </ul>
                  </div>
                    <div class="col-lg-10">
                      <div class="h3 ms-4">Interactive Map</div>
                      <p class="ms-4 text-sm text-secondary">Use the drawing toolbox below to define an area on the map. A search will be performed on the available datasets to find results lying within the marked area. </p>
                      <div id="search-map" class="m-4 card card-link m" style="height: 60vh">



                      </div>
                      <p class="ms-4 text-sm text-secondary">Only one polygon can be used in a search query. Make sure your polygon is convex for optimal results.</p>
                    </div>
                  </div>
                
                </div>
                <div class="modal-footer" id="spatial-search-modal-footer">
                  <a href="#" class="btn btn-primary ms-auto" data-bs-dismiss="modal">
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="me-2 icon icon-tabler icons-tabler-outline icon-tabler-search"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
                    Search
                  </a>
                </div>
              </div>
            </div>
          </div>
          <div class="modal modal-blur fade" id="modal-new-dataset" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
              <div class="modal-content">
                <form>
                <div class="modal-header">
                  <h5 class="modal-title">New Dataset</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-lg-12">

                      <div class="mb-3">
                        <label class="form-label">Title</label>
                        <div class="row g-2">
                          <div class="col">
                            <input type="text" class="form-control" name="package-name-input" placeholder="Dataset Title" required>
                          </div>
                          <div class="col-auto align-self-center">
                            <span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-content="The dataset title <strong>must be unique</strong>. It serves as one of the unique identifiers of the dataset." data-bs-html="true">?</span>
                          </div>
                        </div>
                      </div>
                      <div class="d-flex">
                        <div class="text-secondary text-start justify-content-left" id="availability-div">
                          <a onclick="checkNameAvailability()" class="text-sm p-2 cursor-pointer link-secondary" title="Check Title Availability" data-bs-toggle="tooltip" tabindex="-1">
                              Check title availability
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="packageDescription" class="form-control" rows="3" required placeholder="A nice informative description"></textarea>
                      </div>
                    </div>
                    <input type="hidden" name="packageTags" id="hiddenTagsInput" name="tags"/>
                    <div class="col-lg-12">
                      <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" id="tagInput" class="form-control" placeholder="Type a tag and press enter" required>
                        <div class="col tags-list mt-3" id="tagsContainer">
                            <!-- Tags will be dynamically added here -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer" id="new-dataset-modal-footer">
                  <a class="cursor-pointer btn btn-primary ms-auto" id="publish-dataset-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
                    Publish Dataset
                  </a>
                </div>
              </form>
              </div>
            </div>
          </div>
        </div>
        {% include 'footer.html'%}
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Preview Map -->
    <script>
        var map = L.map('map', {
            center: [47.57536996623514, 8.261718750000002],
            zoom: 3,
            zoomControl: false,
            maxZoom: 3,
            minZoom: 3,
            scrollWheelZoom: false,
            dragging	: false
        });
    
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
    
    </script>

    <!-- Spatial Modal Map -->
    <script>
      // Initialize the map
      var searchMap = L.map('search-map', {
          center: [38.6137, 24.6116],
          zoom: 3,
      });
    
      // Base layers
      var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      });
    
      var topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
          maxZoom: 17,
          attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      });
    
      // Add the default layer to the map
      streetLayer.addTo(searchMap);
    
      // Layer control
      var baseLayers = {
          "Street Map": streetLayer,
          "Topographical Map": topoLayer
      };
    
      L.control.layers(baseLayers).addTo(searchMap);
    
      // Feature Group to store the single drawn polygon
      var drawnPolygon = null;
    
      // Add drawing controls
      var drawControl = new L.Control.Draw({
          edit: false, // Disable bulk editing
          draw: {
            
              polygon: {
                  allowIntersection: false,
                  showArea: true,
                  remove: true
              },
              polyline: false,
              rectangle: true,
              circle: false,
              marker: false,
              circlemarker: false
          }
      });
    
      searchMap.addControl(drawControl);
      
      let savedPolygons = [];
      
      // Function to generate a preview of a polygon
      function generatePreview(polygon) {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 100;
          canvas.height = 100;

          const bounds = polygon.getBounds();
          const latLngs = polygon.getLatLngs()[0];

          const scaleX = canvas.width / (bounds.getEast() - bounds.getWest());
          const scaleY = canvas.height / (bounds.getNorth() - bounds.getSouth());

          ctx.fillStyle = 'rgba(210, 171, 203, 0.3)';
          ctx.beginPath();

          latLngs.forEach((latLng, index) => {
              const x = (latLng.lng - bounds.getWest()) * scaleX;
              const y = (bounds.getNorth() - latLng.lat) * scaleY;
              if (index === 0) {
                  ctx.moveTo(x, y);
              } else {
                  ctx.lineTo(x, y);
              }
          });
          ctx.closePath();
          ctx.fill();

          return canvas.toDataURL();
      }
      
      // Function to render saved polygons in the list
      function renderSavedPolygons() {
          const polygonList = document.getElementById("savedPolygonList");
          polygonList.innerHTML = "";

          savedPolygons.forEach((polygon, index) => {
              const listItem = document.createElement("li");
              listItem.classList.add("list-group-item", "d-flex", "align-items-center");
              listItem.style.cursor = "pointer";

              const previewImg = document.createElement("img");
              previewImg.src = polygon.preview;
              previewImg.style.width = "50px";
              previewImg.style.height = "50px";
              previewImg.style.marginRight = "10px";
              previewImg.alt = "Polygon Preview";

              const polygonName = document.createElement("span");
              polygonName.textContent = polygon.name;

              listItem.appendChild(previewImg);
              listItem.appendChild(polygonName);

              // Click event to load the polygon onto the map
              listItem.addEventListener("click", () => loadPolygon(index));

              polygonList.appendChild(listItem);
          });
      }

      // Function to save a polygon
      function savePolygon(name, polygon) {
          const polygonData = {
              name: name,
              coordinates: polygon.getLatLngs(),
              preview: generatePreview(polygon)
          };
          savedPolygons.push(polygonData);
          renderSavedPolygons();
      }



      // Function to load a saved polygon onto the map
      function loadPolygon(index) {
          const polygonData = savedPolygons[index];

          if (drawnPolygon) {
              searchMap.removeLayer(drawnPolygon);
          }

          drawnPolygon = L.polygon(polygonData.coordinates, {
              color: 'purple',
              fillOpacity: 0.3
          }).addTo(searchMap);

          drawnPolygon.on('click', function () {
              new L.EditToolbar.Edit(searchMap, {
                  featureGroup: L.featureGroup([drawnPolygon]),
              }).enable();
          });

          searchMap.fitBounds(drawnPolygon.getBounds());
      }

      // Add a custom "Save Polygon" button
      L.Control.SavePolygon = L.Control.extend({
          onAdd: function () {
              var btn = L.DomUtil.create('button', 'save-polygon-button');
              btn.innerHTML = 'Save Polygon';
              btn.classList.add('btn', 'btn-primary', 'p-2');

              L.DomEvent.on(btn, 'click', function () {
                  if (drawnPolygon) {
                      const polygonName = prompt("Enter a name for this polygon:");
                      if (polygonName) {
                          savePolygon(polygonName, drawnPolygon);
                          alert('Polygon saved successfully!');
                      }
                  } else {
                      alert('No polygon to save! Please draw a polygon first.');
                  }
              });

              return btn;
          },
          onRemove: function () {
              // No cleanup needed
          }
      });

      L.control.savePolygon = function (opts) {
          return new L.Control.SavePolygon(opts);
      };

      // Add the "Save Polygon" button to the map
      L.control.savePolygon({ position: 'topleft' }).addTo(searchMap);


      // Handle the creation of new shapes
      searchMap.on('draw:created', function (e) {
          var layer = e.layer;
    
          // Remove the previous polygon, if any
          if (drawnPolygon) {
              searchMap.removeLayer(drawnPolygon);
          }
    
          drawnPolygon = layer;
          drawnPolygon.addTo(searchMap);
    
          drawnPolygon.on('click', function () {
              new L.EditToolbar.Edit(searchMap, {
                  featureGroup: L.featureGroup([drawnPolygon]),
              }).enable();
          });
    
          console.log("Drawn polygon coordinates:", drawnPolygon.toGeoJSON());
      });
    
      const spatialModal = document.getElementById('spatial-search-modal');
      spatialModal.addEventListener('shown.bs.modal', function () {
          searchMap.invalidateSize();
      });
    </script>


  

    <script>
      $(document).ready(function () {
          const titleInput = $('input[name="package-name-input"]');

          titleInput.on('input', function () {
              titleInput.removeClass('is-valid is-invalid');
          });

          $('#publish-dataset-btn').on('click', function (event) {
              event.preventDefault(); 

              const title = $('input[name="package-name-input"]').val().trim();
              const notes = $('textarea[name="packageDescription"]').val().trim();
              const tags = $('#hiddenTagsInput').val().split(',').filter(tag => tag.trim() !== '');

              if (!title || !notes || tags.length === 0) {
                  $('#new-dataset-modal-footer').prepend('<div class="alert alert-danger p-2 me-auto">Please fill in all fields</div>');
                  return;
              }

              const payload = {
                  basic_metadata: {
                      title: title,
                      notes: notes,
                      tags: tags
                  }
              };

              $('#new-dataset-modal-footer .alert').remove()
              const loader = '<div class="spinner-border me-auto p-2 spinner-border-sm text-secondary" role="status"></div>'
              $("#new-dataset-modal-footer").prepend(loader)

              $.ajax({
                  url: `{{ url_for('rest_catalog_blueprint.api_rest_create_dataset') }}`,
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(payload),
                  success: function (response) {
                    $('#new-dataset-modal-footer .spinner-border').remove()
                    $('#new-dataset-modal-footer').prepend('<div class="alert alert-success p-2 me-auto">Dataset Published</div>');
                    setTimeout(function() {
                      $('#new-dataset-modal-footer .alert').fadeOut(500, function() {
                          $(this).remove();
                      });
                     }, 3000);
                  },
                  error: function (xhr) {
                    $('#new-dataset-modal-footer .spinner-border').remove()
                    $('#new-dataset-modal-footer').prepend('<div class="alert alert-danger p-2 me-auto">Dataset Failed to Publish</div>');
                    setTimeout(function() {
                      $('#new-dataset-modal-footer .alert').fadeOut(500, function() {
                          $(this).remove();
                      });
                     }, 3000);
                  }
              });
          });

      });

      function slugifyTitle(title) {
          return title
              .toLowerCase() 
              .trim()
              .replace(/[^a-z0-9\s]/g, '') // Remove any character that is not a letter, number, or space
              .replace(/\s+/g, '_'); // Replace spaces with underscores
      }

      function checkNameAvailability() {
        const titleInput = $('input[name="package-name-input"]');
        const title = titleInput.val().trim();

        if (title === '') {
            return;
        }

        titleInput.removeClass('is-valid is-invalid');

        const loader = '<div class="spinner-border me-auto p-2 spinner-border-sm text-secondary" role="status"></div>'
        $("#availability-div").append(loader)

        $.ajax({
            url: `{{url_for('rest_catalog_blueprint.api_rest_get_dataset', dataset_id='')}}${slugifyTitle(title)}`,
            method: 'GET',
            success: function (response) {
                // If the response is 200, a dataset already exists
                $('#availability-div .spinner-border').remove()
                titleInput.addClass('is-invalid');
            },
            error: function (xhr) {
                if (xhr.status === 404) {
                    // If the response is 404, a dataset doesn't exist
                    $('#availability-div .spinner-border').remove()
                    titleInput.addClass('is-valid');
                } else {
                }
            }
        });
    }
    </script>


    <script>
      const tagInput = document.getElementById('tagInput');
      const tagsContainer = document.getElementById('tagsContainer');
      const hiddenTagsInput = document.getElementById('hiddenTagsInput');

      let tags = [];

      function renderTags() {
        tagsContainer.innerHTML = '';

        // Add each tag as a span with a close button
        tags.forEach((tag, index) => {
          const tagElement = document.createElement('span');
          tagElement.classList.add('tag', 'me-2', 'mb-2');

          tagElement.innerHTML = `
            ${tag}
            <a href="#" class="btn-close ms-1" data-index="${index}"></a>
          `;

          // Append the tag element to the container
          tagsContainer.appendChild(tagElement);
        });

        // Add event listeners to each close button
        const closeButtons = document.querySelectorAll('.btn-close');
        closeButtons.forEach(button => {
          button.addEventListener('click', function (event) {
            event.preventDefault();
            const index = button.getAttribute('data-index');
            removeTag(index);
          });
        });

        // Update the hidden input with the current tags as a comma-separated string
        hiddenTagsInput.value = tags.join(',');
      }

      // Function to remove a tag by index
      function removeTag(index) {
        tags.splice(index, 1);
        renderTags();
      }

      // Function to handle input and add tag
      tagInput.addEventListener('keydown', function (event) {
        // If Enter is pressed, add the tag
        if (event.key === 'Enter') {
          event.preventDefault();
          const newTag = tagInput.value.trim();
          
          if (newTag !== '' && !tags.includes(newTag)) {
            tags.push(newTag);
            tagInput.value = ''; // Clear the input after adding the tag
            renderTags();
          }
        }

        // If backspace is pressed and input is empty, remove the last tag
        if (event.key === 'Backspace' && tagInput.value === '') {
          tags.pop();
          renderTags();
        }
      });
    </script>
  </body>
</html>