<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>STELAR | Process Overview</title>
    <!-- CSS files -->
    {% include 'tabler.html' %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="{{ url_for('static', filename='images.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='stelar.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/litegraph.css') }}">
    <script type="text/javascript" src="{{ url_for('static', filename='lib/litegraph.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='utils.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='steps.css') }}">

</head>

<body>
    <div class="page">
        <!-- Navbar -->
        {% include 'header.html' %}
        <div class="page-wrapper">
            <!-- Page header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col-lg">
                            <div class="page-pretitle">
                                PROCESSES
                            </div>
                            <h3 class="page-title">
                                <ol class="breadcrumb breadcrumb-arrows">
                                    <li class="breadcrumb-item"><a class="text-secondary"
                                            href="{{ url_for('dashboard_blueprint.processes')}}">
                                            Workflow Processes
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item active"><a href="#"><span class="text-strong">{{
                                                process.title }}</span></a></li>
                                    <span class="ms-2">
                                        {% if process.get('private') %}
                                        <span class="badge bg-danger-lt" title="Private to organization users"><svg
                                            xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                            class="icon icon-tabler icons-tabler-outline icon-tabler-lock">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z" />
                                            <path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0" />
                                            <path d="M8 11v-4a4 4 0 1 1 8 0v4" />
                                            </svg>
                                            PRIVATE
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success-lt" title="Public to all users">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                            class="icon icon-tabler icons-tabler-outline icon-tabler-lock-open-2">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M3 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z" />
                                            <path d="M9 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0" />
                                            <path d="M13 11v-4a4 4 0 1 1 8 0v4" />
                                            </svg>
                                            PUBLIC
                                        </span>
                                        {% endif %}
                                        </span>
                                </ol>
                            </h3>
                        </div>
                        <div class="col-auto ms-auto d-print-none">

                            <div class="d-flex align-items-center">
                                <div id="state-updater-status">
                                </div>
                                <div class="ms-2">
                                    <div class="input-group">
                                        <input type="text" class="form-control text-center" id="state-input" readonly>
                                        <button data-bs-toggle="dropdown" type="button"
                                            class="btn dropdown-toggle dropdown-toggle-split"></button>
                                        <div class="dropdown-menu dropdown-menu-start">
                                            <a class="dropdown-item" href="#" onclick="updateInput('Running')">
                                                <span class="badge me-1 bg-warning"></span> Running
                                            </a>
                                            <a class="dropdown-item" href="#" onclick="updateInput('Succeeded')">
                                                <span class="badge me-1 bg-success"></span> Succeeded
                                            </a>
                                            <a class="dropdown-item" href="#" onclick="updateInput('Failed')">
                                                <span class="badge me-1 bg-danger"></span> Failed
                                            </a>
                                        </div>
                                        <button type="button" class="btn btn-primary" id="update-state-button" disabled
                                            onclick="patchProcessState()">Update State</button>
                                    </div>
                                </div>

                                <div class="ms-2">
                                    <a class="btn btn-outline-primary" onclick="toggleGraph()" id="job-graph-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="currentColor"
                                            class="me-2 icon icon-tabler icons-tabler-filled icon-tabler-chart-dots-3">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path
                                                d="M18 2a4 4 0 1 1 -3.843 5.114l-6.295 .786a3 3 0 0 1 -.094 .257l6.446 4.431a3 3 0 1 1 -.695 4.099l-3.527 1.058q .008 .127 .008 .255a4 4 0 1 1 -8 0l.005 -.2a4 4 0 0 1 7.366 -1.954l3.64 -1.094l.01 -.102q .023 -.204 .074 -.4l-6.688 -4.6a3 3 0 0 1 -4.407 -2.65l.005 -.176a3 3 0 0 1 5.784 -.931l6.312 -.79a4 4 0 0 1 3.899 -3.103" />
                                        </svg>
                                        Show Process Graph
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="text-secondary text-sm h4 m-0">
                              <div class="mt-1 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                                <a href="{{url_for('dashboard_blueprint.organization', organization_id=process.organization.id)}}"
                                  target="_blank" class="text-blue card-link list-inline-item" title="Belongs to">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-building-bank"
                                    width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path d="M3 21l18 0" />
                                    <path d="M3 10l18 0" />
                                    <path d="M5 6l7 -3l7 3" />
                                    <path d="M4 10l0 11" />
                                    <path d="M20 10l0 11" />
                                    <path d="M8 14l0 3" />
                                    <path d="M12 14l0 3" />
                                    <path d="M16 14l0 3" />
                                  </svg>
                                  {{ process.organization.title }}
                                </a>
                                <div class="list-inline-item" title="Created by">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                                    class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                                    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                                  </svg>
                                  {{ process.creator }}
                                </div>
                              </div>
                            </div>
                          </div>              
                    </div>
                </div>
            </div>
            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-alert-container">

                        <!-- Toast alert. Alerts that have no parent location will be appended here -->

                    </div>
                    <div class="row row-cards">

                        <canvas id='lineage-canvas' style='border-radius: 8px' width='1500' height='600' class='col-lg-12 card px-0 d-none'>
                        </canvas>

                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="card-title">Basic Information</div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="icon me-2 text-secondary icon-tabler icons-tabler-outline icon-tabler-e-passport">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path
                                                d="M2 5m0 2a2 2 0 0 1 2 -2h16a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-16a2 2 0 0 1 -2 -2z" />
                                            <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                                            <path d="M9 12h-7" />
                                            <path d="M15 12h7" />
                                        </svg>
                                        ID: <strong id="process-id">{{ process.id }}</strong>
                                        <button type="button"
                                            class="btn btn-pill ms-1 px-2 py-0 btn-sm btn-outline-secondary" onclick="
                                                navigator.clipboard.writeText(document.getElementById('process-id').innerText);
                                                var el = document.getElementById('process-id');
                                                el.classList.remove('glowing-text');
                                                void el.offsetWidth; // trigger reflow to restart animation
                                                el.classList.add('glowing-text');">COPY</button>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="icon me-2 text-secondary icon-tabler icons-tabler-outline icon-tabler-player-play">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M7 4v16l13 -8z" />
                                        </svg>
                                        Started at: <strong>{{ process.start_date.strftime('%d-%m-%Y
                                            %H:%M') }}</strong>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="icon me-2 text-secondary icon-tabler icons-tabler-outline icon-tabler-hand-stop">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M8 13v-7.5a1.5 1.5 0 0 1 3 0v6.5" />
                                            <path d="M11 5.5v-2a1.5 1.5 0 1 1 3 0v8.5" />
                                            <path d="M14 5.5a1.5 1.5 0 0 1 3 0v6.5" />
                                            <path
                                                d="M17 7.5a1.5 1.5 0 0 1 3 0v8.5a6 6 0 0 1 -6 6h-2h.208a6 6 0 0 1 -5.012 -2.7a69.74 69.74 0 0 1 -.196 -.3c-.312 -.479 -1.407 -2.388 -3.286 -5.728a1.5 1.5 0 0 1 .536 -2.022a1.867 1.867 0 0 1 2.28 .28l1.47 1.47" />
                                        </svg>
                                        Finished at: <span id="process-end-date">
                                            <strong>
                                                {% if process.get('end_date') %}
                                                {{ process.get('end_date').strftime('%d-%m-%Y %H:%M') }}
                                                {% else %}
                                                Not Finished
                                                {% endif %}
                                            </strong>
                                        </span>
                                    </div>
                                    <div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="icon me-2 text-secondary icon-tabler icons-tabler-outline icon-tabler-brand-redux">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path
                                                d="M16.54 7c-.805 -2.365 -2.536 -4 -4.54 -4c-2.774 0 -5.023 2.632 -5.023 6.496c0 1.956 1.582 4.727 2.512 6" />
                                            <path
                                                d="M4.711 11.979c-1.656 1.877 -2.214 4.185 -1.211 5.911c1.387 2.39 5.138 2.831 8.501 .9c1.703 -.979 2.875 -3.362 3.516 -4.798" />
                                            <path
                                                d="M15.014 19.99c2.511 0 4.523 -.438 5.487 -2.1c1.387 -2.39 -.215 -5.893 -3.579 -7.824c-1.702 -.979 -4.357 -1.235 -5.927 -1.07" />
                                            <path
                                                d="M10.493 9.862c.48 .276 1.095 .112 1.372 -.366a1 1 0 0 0 -.367 -1.365a1.007 1.007 0 0 0 -1.373 .366a1 1 0 0 0 .368 1.365z" />
                                            <path d="M9.5 15.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
                                            <path d="M15.5 14m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
                                        </svg>
                                        Execution State: <span id="process-state-badge"
                                            class="badge me-1 {% if process.exec_state == 'succeeded' %}bg-green{% elif process.exec_state == 'failed' %}bg-danger{% else %}bg-warning{% endif %}"></span>
                                        <span id="process-state-text">{{ process.exec_state | capitalize
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card mt-2">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h5 class="card-title">Metadata Information</h5>
                                        <a class="cursor-pointer btn mb-3" title="Edit in Catalog"
                                            href="{{ url_for('dashboard_blueprint.dataset_detail', dataset_id=process.id) }}"
                                            target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"
                                            id="update-tags-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                class="text-primary icon icon-tabler icons-tabler-outline icon-tabler-edit">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                                                <path
                                                    d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                                                <path d="M16 5l3 3" />
                                            </svg>
                                            <span class="text-primary">Edit in Catalog</span>
                                        </a>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-calendar-week">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path
                                                d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z" />
                                            <path d="M16 3v4" />
                                            <path d="M8 3v4" />
                                            <path d="M4 11h16" />
                                            <path d="M7 14h.013" />
                                            <path d="M10.01 14h.005" />
                                            <path d="M13.01 14h.005" />
                                            <path d="M16.015 14h.005" />
                                            <path d="M13.015 17h.005" />
                                            <path d="M7.01 17h.005" />
                                            <path d="M10.01 17h.005" />
                                        </svg>
                                        Latest Modified: <strong>{{ process.metadata_modified.strftime('%d-%m-%Y
                                            %H:%M')}}</strong>
                                    </div>
                                    <div class="mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-tags">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path
                                                d="M3 8v4.172a2 2 0 0 0 .586 1.414l5.71 5.71a2.41 2.41 0 0 0 3.408 0l3.592 -3.592a2.41 2.41 0 0 0 0 -3.408l-5.71 -5.71a2 2 0 0 0 -1.414 -.586h-4.172a2 2 0 0 0 -2 2z" />
                                            <path d="M18 19l1.592 -1.592a4.82 4.82 0 0 0 0 -6.816l-4.592 -4.592" />
                                            <path d="M7 10h-.01" />
                                        </svg>
                                        Tags:
                                        {% if process.tags %}
                                        {% for tag in process.get('tags') %}
                                        <span class="tag m-0 mb-0 me-1">{{ tag }}</span>
                                        {% endfor %}
                                        {% else %}
                                        <strong>No tags have been added yet.</strong>
                                        {% endif %}
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-body m-2">
                                    <div class="d-flex mb-3">
                                        <div>
                                        <h3 class="card-title mb-1">Process Tasks</h3>
                                        <p class="text-secondary">Tasks are the individual steps in the process. Click on a task to view its details.</p>
                                        </div>
                                        <div class="ms-auto ">
                                            <div class="input-group">
                              
                                              <button type="button" class="btn btn-outline-primary disabled" id="compare-tasks-button"
                                                onclick="window.location.href='{{url_for('dashboard_blueprint.dataset_compare')}}'">Compare Selected
                                                <span class="ms-1" id="tasks-compare-number">(0)</span></button>
                              
                                              <button data-bs-toggle="dropdown" role="button" class="btn btn-outline-primary dropdown-toggle disabled"
                                                datas-bs-auto-close="outside"></button>
                                              <div class="dropdown-menu dropdown-menu-end" id="compare-tasks-options">
                              
                                              </div>
                                            </div>
                                        </div>
                                    </div>
                                    <ul class="steps steps-vertical ">
                                        {% if proc_tasks %}
                                        {% for task in proc_tasks %}
                                        <li class="step-item">
                                            <a class="card card-link "
                                                href="{{url_for('dashboard_blueprint.task', process_id=process.id, task_id=task.get('id') )}}">
                                                {% if task.start_date and (now - task.start_date).total_seconds() <= 28800 %}
                                                    <div class="ribbon ribbon-top me-6 bg-primary">NEW</div>
                                                {% endif %}
                                                <div class="card-body p-3">
                                                    <div class="row">
                                                        <div class="col-md-1 d-flex justify-content-end">
                                                            <button class="btn btn-pill btn-outline-success m-1 me-1 p-1 text-center comparator-btn align-self-center" data-task-id="{{task.id}}" title="Add to comparison">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-git-compare">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                                                <path d="M6 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                                                <path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                                                <path d="M11 6h5a2 2 0 0 1 2 2v8"></path>
                                                                <path d="M14 9l-3 -3l3 -3"></path>
                                                                <path d="M13 18h-5a2 2 0 0 1 -2 -2v-8"></path>
                                                                <path d="M10 15l3 3l-3 3"></path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <div class="col">
                                                            <div class="list-inline list-inline-dots">
                                                                <span class="list-inline-item"><strong>{{
                                                                        loop.index}}. {{task.name}}</strong></span>
                                                                <span
                                                                    class="text-secondary list-inline-item">{{task.id}}</span>
                                                            </div>
                                                            <div style="display: none;" id="task-index-{{task.id}}">
                                                            </div>
                                                            <div class="text-secondary mt-1">
                                                                <div class="m-0 list-inline">
                                                                    <div class="list-inline-item">
                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                            width="24" height="24" viewBox="0 0 24 24"
                                                                            fill="none" stroke="currentColor"
                                                                            stroke-width="2" stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                                                                            <path stroke="none" d="M0 0h24v24H0z"
                                                                                fill="none" />
                                                                            <path
                                                                                d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                                                                            <path
                                                                                d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                                                                        </svg>
                                                                        {% if task.creator %}
                                                                        {{ task.creator}}
                                                                        {% else %}
                                                                        Not specified
                                                                        {% endif %}
                                                                    </div>
                                                                    <div class="list-inline-item">
                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                            width="24" height="24" viewBox="0 0 24 24"
                                                                            fill="none" stroke="currentColor"
                                                                            stroke-width="2" stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            class="icon icon-tabler icons-tabler-outline icon-tabler-brand-docker">
                                                                            <path stroke="none" d="M0 0h24v24H0z"
                                                                                fill="none" />
                                                                            <path
                                                                                d="M22 12.54c-1.804 -.345 -2.701 -1.08 -3.523 -2.94c-.487 .696 -1.102 1.568 -.92 2.4c.028 .238 -.32 1 -.557 1h-14c0 5.208 3.164 7 6.196 7c4.124 .022 7.828 -1.376 9.854 -5c1.146 -.101 2.296 -1.505 2.95 -2.46z" />
                                                                            <path d="M5 10h3v3h-3z" />
                                                                            <path d="M8 10h3v3h-3z" />
                                                                            <path d="M11 10h3v3h-3z" />
                                                                            <path d="M8 7h3v3h-3z" />
                                                                            <path d="M11 7h3v3h-3z" />
                                                                            <path d="M11 4h3v3h-3z" />
                                                                            <path
                                                                                d="M4.571 18c1.5 0 2.047 -.074 2.958 -.78" />
                                                                            <path d="M10 16l0 .01" />
                                                                        </svg>
                                                                        {% if task.image %}
                                                                        {{ task.image }}
                                                                        {% else %}
                                                                        Remote Task
                                                                        {% endif %}
                                                                    </div>
                                                                    <div class="list-inline-item">
                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                            width="24" height="24" viewBox="0 0 24 24"
                                                                            fill="none" stroke="currentColor"
                                                                            stroke-width="2" stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-event">
                                                                            <path stroke="none" d="M0 0h24v24H0z"
                                                                                fill="none" />
                                                                            <path
                                                                                d="M4 5m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" />
                                                                            <path d="M16 3l0 4" />
                                                                            <path d="M8 3l0 4" />
                                                                            <path d="M4 11l16 0" />
                                                                            <path d="M8 15h2v2h-2z" />
                                                                        </svg>
                                                                        <span>{{ task.start_date.strftime('%d-%m-%Y
                                                                            %H:%M:%S') }}</span>
                                                                    </div>
                                                                    <div class="list-inline-item">
                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                            width="24" height="24" viewBox="0 0 24 24"
                                                                            fill="none" stroke="currentColor"
                                                                            stroke-width="2" stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            class="icon icon-tabler icons-tabler-outline icon-tabler-brand-redux">
                                                                            <path stroke="none" d="M0 0h24v24H0z"
                                                                                fill="none" />
                                                                            <path
                                                                                d="M16.54 7c-.805 -2.365 -2.536 -4 -4.54 -4c-2.774 0 -5.023 2.632 -5.023 6.496c0 1.956 1.582 4.727 2.512 6" />
                                                                            <path
                                                                                d="M4.711 11.979c-1.656 1.877 -2.214 4.185 -1.211 5.911c1.387 2.39 5.138 2.831 8.501 .9c1.703 -.979 2.875 -3.362 3.516 -4.798" />
                                                                            <path
                                                                                d="M15.014 19.99c2.511 0 4.523 -.438 5.487 -2.1c1.387 -2.39 -.215 -5.893 -3.579 -7.824c-1.702 -.979 -4.357 -1.235 -5.927 -1.07" />
                                                                            <path
                                                                                d="M10.493 9.862c.48 .276 1.095 .112 1.372 -.366a1 1 0 0 0 -.367 -1.365a1.007 1.007 0 0 0 -1.373 .366a1 1 0 0 0 .368 1.365z" />
                                                                            <path
                                                                                d="M9.5 15.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
                                                                            <path
                                                                                d="M15.5 14m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
                                                                        </svg>
                                                                        <span id="task-status-{{ task.id }}">{{
                                                                            task.exec_state | capitalize }}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-auto">
                                                            <span id="task-indicator-{{ task.id }}"
                                                                class="status-indicator 
                                                                {% if task.exec_state == 'succeeded' %}status-green{% elif task.exec_state == 'failed' %}status-red{% elif task.exec_state == 'created' %}status-secondary{% elif task.exec_state == 'running' %}status-yellow status-indicator-animated{% endif %}">
                                                                <span class="status-indicator-circle"></span>
                                                                <span class="status-indicator-circle"></span>
                                                                <span class="status-indicator-circle"></span>
                                                            </span>
                                                        </div>
                                                    </div>

                                                </div>
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p id="no-tasks-message">No tasks have been submitted yet.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% include 'footer.html'%}
        </div>
    </div>
</body>
<script>
    function updateInput(state) {
        const stateInput = document.getElementById('state-input');
        const updateStateButton = document.getElementById('update-state-button');
        updateStateButton.disabled = false;
        stateInput.value = state;
    }

    function updateEndDateAndState() {
        $.ajax({
            url: `{{ url_for('rest_workflows_blueprint.api_get_process', entity_id=process.id) }}`,
            method: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.success) {
                    const process = response.result;
                    const endDateElement = document.getElementById('process-end-date');
                    const stateBadgeElement = document.getElementById('process-state-badge');
                    const stateTextElement = document.getElementById('process-state-text');

                    endDateElement.innerHTML = `<strong>${process.end_date.replace("T", " ")}</strong>`;
                    stateBadgeElement.className = `badge me-1 ${process.exec_state === 'succeeded' ? 'bg-green' : process.exec_state === 'failed' ? 'bg-danger' : 'bg-warning'}`;
                    stateTextElement.innerHTML = process.exec_state.charAt(0).toUpperCase() + process.exec_state.slice(1);
                }
            },
            error: function (xhr, status, error) {
                stateUpdaterStatus.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger m-2 icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>';
            }
        });
    }
    function patchProcessState() {
        const stateInput = document.getElementById('state-input');
        const selectedState = stateInput.value;
        const stateUpdaterStatus = document.getElementById('state-updater-status');
        stateUpdaterStatus.innerHTML = '<div class="spinner-border m-2 spinner-border-sm text-secondary" role="status"></div>';

        $.ajax({
            url: `{{ url_for('rest_workflows_blueprint.api_patch_process', entity_id=process.id) }}`,
            method: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({ exec_state: selectedState.toLowerCase() }),
            success: function (response) {
                stateUpdaterStatus.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-success m-2 icon icon-tabler icons-tabler-outline icon-tabler-check"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>';
                updateEndDateAndState();
            },
            error: function (xhr, status, error) {
                const errorMessage = xhr.responseJSON && xhr.responseJSON.error && xhr.responseJSON.error.message ? xhr.responseJSON.error.message : "An unexpected error occurred.";
                $('#toast-alert-container').append(createErrorToast(errorMessage));
                stateUpdaterStatus.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger m-2 icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>';
            }
        });
    }

    function createErrorToast(message) {
        return `<div class="toast fade show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
            <div class="toast-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2 text-danger icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>
                <strong class="me-auto text-danger">System Error</strong>
                <small>Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>`;
    }
</script>
<script>

    function updateTaskStatus(tasks) {
        const taskList = $('.steps');
        const noTasksMessage = $('#no-tasks-message');

        if (tasks.length == 0) {
            return;
        }

        if (noTasksMessage.length > 0) {
            noTasksMessage.remove();
        }

        let currentIndex = taskList.children().length + 1;

        tasks.forEach(task => {
            const existingTask = $('#task-status-' + task.id);

            if (existingTask.length > 0) {
                // Update status if the task already exists
                existingTask.text(task.exec_state.charAt(0).toUpperCase() + task.exec_state.slice(1));
                updateStatusIndicator(task.task_uuid, task.exec_state);
            } else {
                // Add a new task to the list
                const taskHTML = generateTaskHTML(task, currentIndex);
                taskList.append(taskHTML);
                currentIndex++;
            }
        });
    }


    function generateTaskHTML(task, index) {
        return `
            <li class="step-item">
                <a class="card card-link" href="{{ url_for('dashboard_blueprint.task', process_id=process.id, task_id='') }}${task.id}">
                    <div class="ribbon ribbon-top me-6 bg-primary">NEW</div>
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-md-1 d-flex justify-content-end">
                                    <button class="btn btn-pill btn-outline-success m-1 me-1 p-1 text-center comparator-btn align-self-center" data-task-id="${task.id}" title="Add to comparison">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="m-0 icon icon-tabler icons-tabler-outline icon-tabler-git-compare">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M6 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                        <path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                        <path d="M11 6h5a2 2 0 0 1 2 2v8"></path>
                                        <path d="M14 9l-3 -3l3 -3"></path>
                                        <path d="M13 18h-5a2 2 0 0 1 -2 -2v-8"></path>
                                        <path d="M10 15l3 3l-3 3"></path>
                                        </svg>
                                    </button>
                            </div>
                            <div class="col">
                                <div class="list-inline list-inline-dots">
                                    <span class="list-inline-item"><strong>${index}. ${task.name}</strong></span>
                                    <span class="text-secondary list-inline-item">${task.id}</span>
                                </div>
                                <div style="display: none;" id="task-index-${task.id}">${index}</div>
                                <div class="text-secondary mt-1">
                                    <div class="m-0 list-inline">
                                        <div class="list-inline-item">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                class="text-secondary icon icon-tabler icons-tabler-outline icon-tabler-user">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                                                <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                                            </svg>
                                            ${task.creator || 'Not specified'}
                                        </div>
                                        <div class="list-inline-item">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-docker">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                <path d="M22 12.54c-1.804 -.345 -2.701 -1.08 -3.523 -2.94c-.487 .696 -1.102 1.568 -.92 2.4c.028 .238 -.32 1 -.557 1h-14c0 5.208 3.164 7 6.196 7c4.124 .022 7.828 -1.376 9.854 -5c1.146 -.101 2.296 -1.505 2.95 -2.46z" />
                                                <path d="M5 10h3v3h-3z" />
                                                <path d="M8 10h3v3h-3z" />
                                                <path d="M11 10h3v3h-3z" />
                                                <path d="M8 7h3v3h-3z" />
                                                <path d="M11 7h3v3h-3z" />
                                                <path d="M11 4h3v3h-3z" />
                                                <path d="M4.571 18c1.5 0 2.047 -.074 2.958 -.78" />
                                                <path d="M10 16l0 .01" />
                                            </svg>
                                            ${task.image || 'Remote Task'}
                                        </div>
                                        <div class="list-inline-item">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-event">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M4 5m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"/>
                                                <path d="M16 3l0 4"/>
                                                <path d="M8 3l0 4"/>
                                                <path d="M4 11l16 0"/>
                                                <path d="M8 15h2v2h-2z"/>
                                            </svg>
                                            <span>${formatIsoDate(task.start_date)}</span>
                                        </div>
                                        <div class="list-inline-item">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-redux">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M16.54 7c-.805 -2.365 -2.536 -4 -4.54 -4c-2.774 0 -5.023 2.632 -5.023 6.496c0 1.956 1.582 4.727 2.512 6"/>
                                                <path d="M4.711 11.979c-1.656 1.877 -2.214 4.185 -1.211 5.911c1.387 2.39 5.138 2.831 8.501 .9c1.703 -.979 2.875 -3.362 3.516 -4.798"/>
                                                <path d="M15.014 19.99c2.511 0 4.523 -.438 5.487 -2.1c1.387 -2.39 -.215 -5.893 -3.579 -7.824c-1.702 -.979 -4.357 -1.235 -5.927 -1.07"/>
                                                <path d="M10.493 9.862c.48 .276 1.095 .112 1.372 -.366a1 1 0 0 0 -.367 -1.365a1.007 1.007 0 0 0 -1.373 .366a1 1 0 0 0 .368 1.365z"/>
                                                <path d="M9.5 15.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/>
                                                <path d="M15.5 14m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/>
                                            </svg>
                                            <span id="task-status-${task.id}">${task.exec_state.charAt(0).toUpperCase() + task.exec_state.slice(1)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <span id="task-indicator-${task.id}" class="status-indicator ${task.exec_state === 'succeeded' ? 'status-green' : task.exec_state === 'running' ? 'status-yellow status-indicator-animated' : task.exec_state === 'created' ? 'status-secondary' : 'status-red'}">
                                    <span class="status-indicator-circle"></span>
                                    <span class="status-indicator-circle"></span>
                                    <span class="status-indicator-circle"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </a>
            </li>
        `;
    }



    function updateStatusIndicator(taskUuid, state) {
        const indicator = $('#task-indicator-' + taskUuid);

        if (state === 'succeeded') {
            indicator.removeClass('status-red status-yellow').addClass('status-green');
        } else if (state === 'failed') {
            indicator.removeClass('status-green status-yellow').addClass('status-red');
        } else if (state === 'running') {
            indicator.removeClass('status-green status-red').addClass('status-yellow status-indicator-animated');
        }
    }

    function fetchTasks() {

        $.ajax({
            url: `{{url_for('rest_workflows_blueprint.api_get_process', entity_id = process.id)}}`,
            method: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.success) {
                    updateTaskStatus(response.result.tasks);
                    attachComparatorButtonListeners();
                }
            },
            error: function (xhr, status, error) {
                if (xhr.status === 401) {
                    window.location.href = "{{ url_for('dashboard_blueprint.dashboard_index') }}";
                }
                console.error('Error fetching tasks:', status, error);
            }
        });
    }

    // Call fetchTasks every 5 seconds
    setInterval(fetchTasks, 5000);

    fetchTasks();

</script>

<script>
    var graph = new LGraph();
    var canvas = new LGraphCanvas("#lineage-canvas", graph);
    canvas.read_only = true;

    function TaskNode(task) {
        this.addInput("Input");
        this.addInput("Parameters");
        this.addOutput("Output");
        this.addOutput("Metrics");
        this.addInput("Previous");
        this.addOutput("Next");
        this.setSize(300, 200);
        this.res
        this.creator = this.addWidget("text", "Creator", "", "creator");
        this.start_date = this.addWidget("text", "Start Date", "", "start_date");
        this.end_date = this.addWidget("text", "End Date", "", "end_date");
        this.image = this.addWidget("text", "Image", "", "image");
        this.properties = {
            creator: task.creator,
            start_date: task.start_date,
            end_date: task.end_date,
            image: task.image
        };
    }

    function KeyValueNode() {
        this.title = "Task Metrics";
    }

    LiteGraph.registerNodeType("basic/task", TaskNode);
    LiteGraph.registerNodeType("basic/kv", KeyValueNode);


    function toggleGraph(){
        const graphContainer = document.getElementById('lineage-canvas');
        if (graphContainer.classList.contains('d-none')) {
            graphContainer.classList.remove('d-none');
            document.getElementById('job-graph-btn').innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="currentColor"
                class="me-2 icon icon-tabler icons-tabler-filled icon-tabler-chart-dots-3">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                d="M18 2a4 4 0 1 1 -3.843 5.114l-6.295 .786a3 3 0 0 1 -.094 .257l6.446 4.431a3 3 0 1 1 -.695 4.099l-3.527 1.058q .008 .127 .008 .255a4 4 0 1 1 -8 0l.005 -.2a4 4 0 0 1 7.366 -1.954l3.64 -1.094l.01 -.102q .023 -.204 .074 -.4l-6.688 -4.6a3 3 0 0 1 -4.407 -2.65l.005 -.176a3 3 0 0 1 5.784 -.931l6.312 -.79a4 4 0 0 1 3.899 -3.103" />
            </svg>
            Hide Process Graph
            `;
            updateGraph();
        } else {
            graphContainer.classList.add('d-none');
            document.getElementById('job-graph-btn').innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="currentColor"
                class="me-2 icon icon-tabler icons-tabler-filled icon-tabler-chart-dots-3">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                d="M18 2a4 4 0 1 1 -3.843 5.114l-6.295 .786a3 3 0 0 1 -.094 .257l6.446 4.431a3 3 0 1 1 -.695 4.099l-3.527 1.058q .008 .127 .008 .255a4 4 0 1 1 -8 0l.005 -.2a4 4 0 0 1 7.366 -1.954l3.64 -1.094l.01 -.102q .023 -.204 .074 -.4l-6.688 -4.6a3 3 0 0 1 -4.407 -2.65l.005 -.176a3 3 0 0 1 5.784 -.931l6.312 -.79a4 4 0 0 1 3.899 -3.103" />
            </svg>
            Show Process Graph
            `;
        }
    }

    function updateGraph() {
        $.ajax({
            url: `{{ url_for('rest_workflows_blueprint.api_get_process', entity_id=process.id) }}`,
            method: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.success) {
                    const process = response.result;
                    const tasks = process.tasks;
                    graph.clear();
                    var prev = null;
                    var currx = 100;
                    tasks.forEach(task => {

                        const node = LiteGraph.createNode("basic/task");
                        node.title = task.name;
                        node.setProperty("creator", task.creator);
                        node.setProperty("start_date", formatIsoDate(task.start_date));
                        if (task.end_date) {
                            node.setProperty("end_date", formatIsoDate(task.end_date));
                        } else {
                            node.setProperty("end_date", "Not Finished");
                        }
                        node.setProperty("image", task.image ? task.image : "Remote Task");
                        node.pos = [currx, 100];
                        currx += 500;

                        if (prev) {
                            prev.connect(2, node, 2);
                        }
                        prev = node;
                        graph.add(node);
                        node.setSize(node.computeSize());
                        $.ajax({
                            url: `{{ url_for('rest_workflows_blueprint.api_get_task_metadata', entity_id='')}}${task.id}`,
                            method: 'GET',
                            dataType: 'json',
                            async: false, // Make the request synchronous
                            success: function (response) {
                                if (response.success) {

                                    if (response.result.parameters) {
                                        const params = LiteGraph.createNode("basic/kv");
                                        params.title = "Task Parameters";
                                        params.addOutput("Task");
                                        params.pos = [currx - 750, 350];
                                        for (const param in response.result.parameters) {
                                            params.addWidget("text", param, response.result.parameters[param], param);
                                        }
                                        graph.add(params);
                                        params.connect(0, node, 1);
                                        node.setSize(node.computeSize());

                                    }
                                    if (response.result.metrics) {
                                        const metrics = LiteGraph.createNode("basic/kv");
                                        metrics.title = "Task Metrics";
                                        metrics.addInput("Task");
                                        metrics.pos = [currx - 150, -180];
                                        for (const metric in response.result.metrics) {
                                            metrics.addWidget("text", metric, response.result.metrics[metric], metric);
                                        }
                                        node.connect(1, metrics, 0);
                                        graph.add(metrics);
                                        node.setSize(node.computeSize());
                                    }
                                }
                            }
                        });
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error('Error fetching tasks:', status, error);
            }
        });
    }

</script>


<script>

    function setCookie(name, value, minutes) {
        var expires = "";
        if (minutes) {
          var date = new Date();
          date.setTime(date.getTime() + (minutes * 60 * 1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
      }
  
    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function appendClearAllOption() {
        if ($('#clear-all-tasks').length === 0) {
            $('#compare-tasks-options').append(`
            <div class="dropdown-item cursor-pointer text-center text-danger" id="clear-all-tasks" data-task-id="__clearall__" onclick="clearAllCompareTasks()">
            Clear All
            </div>
        `);
        }
    }
  
    function appendTaskCompareOption(taskName, id) {
        $('#compare-tasks-options').append(`
            <div class="dropdown-item d-flex justify-content-between align-items-center" id="compare-tasks-option-${id}">
            ${taskName} 
            <span class="ms-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger cursor-pointer icon icon-tabler icons-tabler-outline icon-tabler-trash remove-task" data-task-id="${id}">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M4 7l16 0" />
            <path d="M10 11l0 6" />
            <path d="M14 11l0 6" />
            <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
            <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                </svg>
            </span>
            </div>
            `);
    }
  
    function refreshTaskCompareOption(selectedIds) {
        // Remove any options not in selectedIds
        $('#compare-tasks-options .dropdown-item').each(function () {
            var taskId = $(this).find('.remove-task').data('task-id');
            if (taskId && taskId.toString() === '__clearall__') {
                return;
            }
            if (taskId && !taskId.includes(taskId.toString())) {
                $(this).remove();
            }
        });

        // Add options for selectedIds
        selectedIds.forEach(function (id) {
            if ($(`#compare-tasks-option-${id}`).length === 0) {
                $.get(`{{url_for('rest_workflows_blueprint.api_get_task_metadata', entity_id='')}}${id}`, function (data) {
                    appendTaskCompareOption(data.result.name, id);
                });
            }
        });

        $('#tasks-compare-number').text(`(${selectedIds.length})`);
        appendClearAllOption();
    }
  
    function clearAllCompareTasks() {
        setCookie('compare_tasks', '', -1);
        $('#compare-tasks-options').empty();
        $('.comparator-btn').removeClass('btn-success').addClass('btn-outline-success');
        $('#tasks-compare-number').text(`(0)`);
        appendClearAllOption();
    }


    function attachComparatorButtonListeners() {
        $('.comparator-btn').off('click');
        $('.comparator-btn').on('click', function () {
            event.preventDefault(); // Prevent the default redirect behavior
            var taskId = $(this).data('task-id');
            if (!taskId) {
                console.error("Task ID not found!");
                return;
            }

            var cookieValue = getCookie('compare_tasks');
            var selectedIds = cookieValue ? cookieValue.split(',') : [];

            // If this task is already selected, remove it
            if (selectedIds.indexOf(taskId.toString()) !== -1) {
                selectedIds = selectedIds.filter(id => id !== taskId.toString());
                setCookie('compare_tasks', selectedIds.join(','), 30); // Cookie valid for 30 minutes
                $(this).removeClass('btn-success').addClass('btn-outline-success');
                refreshTaskCompareOption(selectedIds);
            } else {
                // If this task isn't already selected, add it
                if (selectedIds.length < 5) {
                    selectedIds.push(taskId);
                    setCookie('compare_tasks', selectedIds.join(','), 30);
                    $(this).removeClass('btn-outline-success').addClass('btn-success');
                    refreshTaskCompareOption(selectedIds);
                    //if (selectedIds.length == 2) {
                    //    $('#toast-message-info').removeClass('hide').addClass('show').addClass('fade');
                    //    $('#toast-info-body').html("Looks like you have selected packages for comparison. Compare them <a href='{{url_for('dashboard_blueprint.dataset_compare')}}'>here</a>");
                    //} 
                } else {
                    //$('#toast-message-alert').removeClass('hide').addClass('show').addClass('fade');
                    //$('#toast-message-body').text("Max 5 datasets can be compared at a time");
                }
            }
        });
    }


    function renderSelectedComparators() {
        var cookieValue = getCookie('compare_tasks');
        var selectedIds = cookieValue ? cookieValue.split(',') : [];
  
        selectedIds.forEach(function (id) {
          $('.comparator-btn[data-task-id="' + id + '"]').removeClass('btn-outline-success').addClass('btn-success');
        });
  
        refreshTaskCompareOption(selectedIds);
  
        // Handle removal of tasks from the dropdown and cookie
        $(document).on('click', '.remove-task', function () {
          var taskId = $(this).data('task-id');
          var cookieValue = getCookie('compare_tasks');
          var selectedIds = cookieValue ? cookieValue.split(',') : [];
  
          // Remove the task ID from the selected IDs
          selectedIds = selectedIds.filter(id => id !== taskId.toString());
          setCookie('compare_tasks', selectedIds.join(','), 30);
          refreshTaskCompareOption(selectedIds);
          $(`#compare-tasks-option-${taskId}`).remove();
          $(`.comparator-btn[data-task-id="${taskId}"]`).removeClass('btn-success').addClass('btn-outline-success');
        });
      }


    $(document).ready(function () {
        attachComparatorButtonListeners();
        renderSelectedComparators();
    });



</script>

</html>