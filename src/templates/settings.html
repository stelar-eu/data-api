<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>STELAR | Account Settings</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='stelar.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="page">
        {% include 'header.html' %}
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                Account Settings
                            </h2>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    <div class="card">
                        <div class="row g-0">
                            <div class="col-12 col-md-3 border-end">
                                <div class="card-body">
                                    <h4 class="subheader">Settings</h4>
                                    <div class="list-group list-group-transparent">
                                        <a href="{{ url_for('dashboard_blueprint.settings') }}"
                                            class="list-group-item list-group-item-action d-flex align-items-center {% if 'view' not in request.args %}active{% endif %}">
                                            My Account
                                        </a>
                                    </div>
                                    <h4 class="subheader mt-4">Experience</h4>
                                    <div class="list-group list-group-transparent">
                                        <a href="https://support.stelar.gr" target="_blank"
                                            class="list-group-item list-group-item-action">Give Feedback</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-9 d-flex flex-column">
                                <div class="card-body">
                                    <h2 class="mb-4">My Organizational Account</h2>
                                    <h1 class="card-title">
                                        {% if 'USER_NAME' in session %}
                                        {{ session['USER_NAME' ] }}
                                        {% endif %}
                                    </h1>

                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="avatar avatar-xl"
                                                style="background-image: url('{{ url_for('static', filename='avatar.png') }}')"></span>
                                        </div>
                                        <div class="col-auto"><a href="#" class="btn">
                                                Change avatar
                                            </a></div>
                                        <div class="col-auto"><a href="#" class="btn btn-ghost-danger">
                                                Delete avatar
                                            </a></div>
                                    </div>
                                    <h3 class="card-title mt-3">
                                        <div class="datagrid-item">
                                            <div class="datagrid-title">Account Status</div>
                                            <div class="datagrid-content">
                                                <span class="status status-green">
                                                    Active
                                                </span>
                                            </div>
                                        </div>
                                    </h3>
                                    <div class="row g-3">
                                        <div class="col-md">
                                            <div class="form-label">Organization Name</div>
                                            <input type="text" class="form-control" value="ATHENA Research Center"
                                                disabled="disabled">
                                        </div>
                                        <div class="col-md">
                                            <div class="form-label">Business ID</div>
                                            <input type="text" class="form-control" value="560afc32"
                                                disabled="disabled">
                                        </div>
                                        <div class="col-md">
                                            <div class="form-label">Location</div>
                                            <input type="text" class="form-control" value="Athens, Greece" ,
                                                disabled="disabled">
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-1">
                                        <div class="col-md">
                                            <div class="form-label">Organization Roles</div>
                                            {% set excluded_roles = ['default-roles-master', 'offline_access',
                                            'uma_authorization'] %}
                                            {% set displayed_roles = session.get('USER_ROLES', [])
                                            | reject("in", excluded_roles)
                                            | map("replace", '-', ' ')
                                            | map("replace", '_', ' ')
                                            | map("title")
                                            | join(', ')
                                            %}
                                            <input type="text" class="form-control" value="{{ displayed_roles }}"
                                                disabled="disabled">
                                        </div>
                                        <div class="col-md">
                                            <div class="form-label">Joined Organization</div>
                                            <input type="text" class="form-control"
                                                value="{{ session['USER_CREATION_DATE'] if 'USER_CREATION_DATE' in session else '' }}"
                                                disabled="disabled">
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md">
                                            <h3 class="card-title mt-4">Email</h3>
                                            <p class="card-subtitle">This contact will be shown to others publicly, so
                                                choose it carefully. You can change this information if you have an
                                                active account.</p>
                                            <div>
                                                <div class="row g-2">
                                                    <div class="col-auto input-icon" id="emailInputDiv">
                                                        <input type="text" id="emailInput"
                                                            style="width: 265px!important"
                                                            class="form-control w-auto input-icon"
                                                            value="{% if 'USER_EMAIL' in session %}{{ session['USER_EMAIL'] }}{% endif %}">
                                                    </div>
                                                    <div class="col-auto">
                                                        <a href="#" class="btn disabled" id="emailSubmitButton">Request
                                                            Change</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md">
                                            <h3 class="card-title mt-4">Username</h3>
                                            <p class="card-subtitle">This is the username the STELAR system has assigned
                                                to you. This username is unique and can not be changed.</p>
                                            <div>
                                                <div class="row g-2">
                                                    <div class="col-auto">
                                                        <input type="text" class="form-control w-auto"
                                                            value="{% if 'USER_USERNAME' in session %}{{ session['USER_USERNAME'] }}{% endif %}"
                                                            disabled="disabled">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md">
                                            <h3 class="card-title mt-4">Password</h3>
                                            <p class="card-subtitle">Set a new password for your account by clicking the
                                                button below.</p>
                                            <div>
                                                <a href="#" class="btn" data-bs-toggle="modal"
                                                    data-bs-target="#modal-report">
                                                    Set new password
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-md">
                                            <h3 class="card-title mt-4">Two-Factor Authentication (2FA)</h3>
                                            <p class="card-subtitle">Configure the 2FA for your account by clicking the
                                                button below.</p>
                                            <div>
                                                <a href="#" class="btn" data-bs-toggle="modal"
                                                    data-bs-target="#modal-2fa">
                                                    Manage 2FA
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md">
                                            <h3 class="card-title mt-4">Generate Application Credentials</h3>
                                            <p class="card-subtitle">Click the button below to generate STS MinIO
                                                credentials</p>
                                            <div>
                                                <a class="btn" target="_blank" rel="noreferrer" data-bs-toggle="modal"
                                                    data-bs-target="#modal-creds">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        class="me-2 text-secondary icon icon-tabler icons-tabler-outline icon-tabler-brand-metabrainz"
                                                        viewBox="0 0 162.612 24.465" xmlns:v="https://vecta.io/nano">
                                                        <path
                                                            d="M52.751.414h9.108v23.63h-9.108zM41.711.74l-18.488 9.92a.919.919 0 0 1-.856 0L3.879.74A2.808 2.808 0 0 0 2.558.414h-.023A2.4 2.4 0 0 0 0 2.641v21.376h9.1V13.842a.918.918 0 0 1 1.385-.682l10.361 5.568a3.634 3.634 0 0 0 3.336.028l10.933-5.634a.917.917 0 0 1 1.371.69v10.205h9.1V2.641A2.4 2.4 0 0 0 43.055.414h-.023a2.808 2.808 0 0 0-1.321.326zm65.564-.326h-9.237v10.755a.913.913 0 0 1-1.338.706L72.762.675a2.824 2.824 0 0 0-1.191-.261h-.016a2.4 2.4 0 0 0-2.535 2.227v21.377h9.163V13.275a.914.914 0 0 1 1.337-.707l24.032 11.2a2.813 2.813 0 0 0 1.188.26 2.4 2.4 0 0 0 2.535-2.227zm7.161 23.63V.414h4.191v23.63zm28.856.421c-11.274 0-19.272-4.7-19.272-12.232C124.02 4.741 132.066 0 143.292 0s19.32 4.7 19.32 12.233-7.902 12.232-19.32 12.232zm0-21.333c-8.383 0-14.84 3.217-14.84 9.1 0 5.926 6.457 9.1 14.84 9.1s14.887-3.174 14.887-9.1c0-5.883-6.504-9.1-14.887-9.1z"
                                                            fill="#c72c48" />
                                                    </svg>
                                                    STS Crendetials
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal modal-blur fade" id="modal-creds" tabindex="-1"
                                        style="display: none;" aria-modal="true">
                                        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">MinIO STS Credentials</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label class="form-label">MinIO Endpoint</label>
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" id="minio-endpoint"
                                                                name="example-text-input"
                                                                placeholder="Your report name">
                                                            <button class="btn btn-outline-secondary" type="button"
                                                                id="copy-endpoint">Copy</button>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Access Key</label>
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" id="access-key"
                                                                name="example-text-input" placeholder="">
                                                            <button class="btn btn-outline-secondary" type="button"
                                                                id="copy-access-key">Copy</button>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Secret Key</label>
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" id="secret-key"
                                                                name="example-text-input"
                                                                placeholder="Your report name">
                                                            <button class="btn btn-outline-secondary" type="button"
                                                                id="copy-secret-key">Copy</button>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Session Token</label>
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" id="session-token"
                                                                name="example-text-input"
                                                                placeholder="Your report name">
                                                            <button class="btn btn-outline-secondary" type="button"
                                                                id="copy-session-token">Copy</button>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <p class="text-secondary small">Credentials generated from this
                                                            point are valid for 24 hours</p>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn me-auto"
                                                        data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal modal-blur fade" id="modal-report" tabindex="-1" role="dialog"
                                        aria-hidden="true">
                                        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">New Password for your account</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <form method="POST" id="changePasswordForm" autocomplete="off"
                                                    novalidate>
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label class="form-label">Account ID</label>
                                                            <input type="text" class="form-control" disabled="disabled"
                                                                placeholder="{% if 'USER_USERNAME' in session and 'USER_EMAIL' in session %}{{ session['USER_USERNAME'] }} | {{ session['USER_EMAIL'] }}{% endif %}">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Old password</label>
                                                            <input type="password" class="form-control"
                                                                name="oldPassword" placeholder="Enter your old password"
                                                                autocomplete="off">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">New password</label>
                                                            <input type="password" class="form-control"
                                                                name="newPassword" placeholder="Enter your new password"
                                                                autocomplete="off">
                                                            <small class="form-text text-muted">Password must be at
                                                                least 8 characters long, with at least one uppercase
                                                                letter, one number, and one special character.</small>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Repeat New password</label>
                                                            <input type="password" class="form-control"
                                                                name="repeatNewPassword"
                                                                placeholder="Repeat your new password"
                                                                autocomplete="off">
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <a href="#" class="btn btn-link link-secondary"
                                                            data-bs-dismiss="modal" tabindex="-1">Cancel</a>
                                                        <button type="submit" class="btn btn-primary ms-auto"
                                                            disabled>Submit</button> <!-- Disabled by default -->
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal fade" id="otpModal" tabindex="-1" role="dialog"
                                        aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Verify OTP</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>We have sent an OTP to your new email. Please enter it below to
                                                        verify your email change.</p>
                                                    <small class="form-text text-muted">Please also check your SPAM
                                                        folder.</small>

                                                    <div class="mb-3">
                                                        <label for="otpInputModal" class="form-label">Enter OTP</label>
                                                        <input type="text" id="otpInputModal" class="form-control"
                                                            placeholder="Enter OTP" autocomplete="off">
                                                    </div>
                                                    <div id="otpError" class="text-danger" style="display: none;"></div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">Cancel</button>
                                                    <button type="button" id="otpSubmitButtonModal"
                                                        class="btn btn-primary disabled">Verify OTP</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="modal modal-blur fade" id="modal-2fa" tabindex="-1" role="dialog"
                                        aria-hidden="true">
                                        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">2FA Configuration</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        {% if TWO_FACTOR_AUTH['created_at'] %}
                                                        <div class="col-lg-12 text-center mb-4">
                                                            <div class="datagrid-item">
                                                                <div class="datagrid-title">Status</div>
                                                                <div class="datagrid-content">
                                                                    <span class="status status-green">
                                                                        Active
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-12 text-center">
                                                            <p>You have set up 2FA successfully at <strong> {{
                                                                    TWO_FACTOR_AUTH.get('created_at') }}</strong>.</p>
                                                        </div>
                                                        <div class="col-lg-12 text-center">
                                                            <button class="btn btn-danger mt-2" id='disable-2fa'>Disable
                                                                2FA</button>
                                                        </div>
                                                        <div class="col-8 ms-auto me-auto text-center mt-4">
                                                            <p class="text text-secondary"><strong>It is strongly
                                                                    suggested that you keep 2FA enabled at all times for
                                                                    security reasons.<strong></p>
                                                        </div>
                                                        {% else %}
                                                        <div class="col-lg-12 text-center mb-4">
                                                            <div class="datagrid-item">
                                                                <div class="datagrid-title">Status</div>
                                                                <div class="datagrid-content">
                                                                    <span class="status status-red">
                                                                        Inactive
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-12 text-center">
                                                            <p>2FA <strong>is not </strong> set up for your account.</p>
                                                        </div>
                                                        <div class="col-lg-12 text-center">
                                                            <button class="btn btn-primary mt-2" id='enable-2fa'>Enable
                                                                2FA</button>
                                                        </div>

                                                        <div class="col-lg-12 text-center" id="step-2fa">
                                                            <img id="qr-code" src="" class="w-50" alt="QR Code"
                                                                style="display: none; margin: 0 auto;">
                                                            <p id="qr-instructions" style="display: none;">Scan this QR
                                                                code with your authenticator app and click
                                                                <strong>Next</strong>.<br><span
                                                                    class="text-secondary"><strong>Make sure to add the
                                                                        2FA to your app. You will not be able to see
                                                                        this QR code again!</strong><span>
                                                            </p>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="modal-footer" id="footer-2fa">
                                                    <a href="#" class="btn btn-secondary ms-auto"
                                                        data-bs-dismiss="modal">
                                                        Close
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="modal modal-blur fade" id="modal-danger" tabindex="-1" role="dialog"
                                        aria-hidden="true" style="display: none;">
                                        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                                            <div class="modal-content">
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                                <div class="modal-status bg-danger"></div>
                                                <div class="modal-body text-center py-4">
                                                    <!-- Error icon -->
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                        class="icon mb-2 text-danger icon-lg" width="24" height="24"
                                                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
                                                        fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                        <path
                                                            d="M10.24 3.957l-8.422 14.06a1.989 1.989 0 0 0 1.7 2.983h16.845a1.989 1.989 0 0 0 1.7 -2.983l-8.423 -14.06a1.989 1.989 0 0 0 -3.4 0z" />
                                                        <path d="M12 9v4" />
                                                        <path d="M12 17h.01" />
                                                    </svg>
                                                    <h3>Error</h3>
                                                    <div id="errorModalBody" class="text-secondary">An error occurred.
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <div class="w-100">
                                                        <div class="row">
                                                            <div class="col">
                                                                <a href="#" class="btn w-100"
                                                                    data-bs-dismiss="modal">Close</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <h3 class="card-title mt-4">Delete Account</h3>
                                    <p class="card-subtitle">This action is irreversible! Your datasets and workflows
                                        will remain available to the members of your organization after your account
                                        deletion. Your personal information will not available anymore except your
                                        username.</p>
                                    <form method="POST">
                                        <div class="row g-3">
                                            <div class="col-md">
                                                <div class="form-label">Type your email below to verify</div>
                                                <input type="text" class="form-control" disabled="disabled"
                                                    placeholder="{% if 'USER_EMAIL' in session %}{{ session['USER_EMAIL'] }}{% endif %}">
                                            </div>
                                            <div class="col-md">
                                                <div class="form-label">Click here to delete your account</div>
                                                <button class="btn btn-danger disabled">Delete Your Account</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% include 'footer.html' %}
        </div>
    </div>
    <script>
        $(document).ready(function () {
            const loader = '<div class="spinner-border me-auto p-2 spinner-border-sm text-secondary" role="status"></div>'

            $('#enable-2fa').on('click', function () {
                $('#footer-2fa').prepend(loader)
                $.ajax({
                    url: `{{ url_for('settings_blueprint.generate_2fa_key') }}`,
                    type: 'GET',
                    success: function (data) {
                        if (data.success) {
                            $('#enable-2fa').remove();
                            $('#footer-2fa .spinner-border').remove()
                            $("#qr-code").attr("src", "data:image/png;base64," + data.qr).show();
                            $("#qr-instructions").show();
                            $("#step-2fa").append(`<button class="btn btn-primary mt-2" id="enable-2fa-next">Next</button>`);
                            // When clicking Next the OTP input should appear
                            $('#enable-2fa-next').on('click', function () {
                                $('#enable-2fa-next').remove();
                                $("#qr-code").remove();
                                $("#qr-instructions").remove();
                                $("#step-2fa").append(`
                                    <div class="card-body m-auto col-8">
                                        <p class="my-4 text-center">Please confirm the 2FA activation by entering an authorization code from your authenticator app.</p>
                                        <div class="my-5">
                                            <div class="row g-4">
                                                <div class="col">
                                                    <div class="row g-2">
                                                        <div class="col">
                                                            <input type="text" class="form-control form-control-lg text-center py-3" maxlength="1" inputmode="numeric" pattern="[0-9]*" data-code-input />
                                                        </div>
                                                        <div class="col">
                                                            <input type="text" class="form-control form-control-lg text-center py-3" maxlength="1" inputmode="numeric" pattern="[0-9]*" data-code-input />
                                                        </div>
                                                        <div class="col">
                                                            <input type="text" class="form-control form-control-lg text-center py-3" maxlength="1" inputmode="numeric" pattern="[0-9]*" data-code-input />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <div class="row g-2">
                                                        <div class="col">
                                                            <input type="text" class="form-control form-control-lg text-center py-3" maxlength="1" inputmode="numeric" pattern="[0-9]*" data-code-input />
                                                        </div>
                                                        <div class="col">
                                                            <input type="text" class="form-control form-control-lg text-center py-3" maxlength="1" inputmode="numeric" pattern="[0-9]*" data-code-input />
                                                        </div>
                                                        <div class="col">
                                                            <input type="text" class="form-control form-control-lg text-center py-3" maxlength="1" inputmode="numeric" pattern="[0-9]*" data-code-input />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary mt-3" id="verify-2fa-activation">Verify OTP & Enable 2FA</button>
                                    </div>
                                `);

                                $('#verify-2fa-activation').on('click', function () {
                                    $('#footer-2fa').prepend(loader);
                                    document.querySelectorAll('[data-code-input]').forEach(input => input.setAttribute('disabled', 'disabled'));
                                    const otp = Array.from(document.querySelectorAll('[data-code-input]')).map(input => input.value).join('');
                                    const payload = { token: otp };
                                    $.ajax({
                                        url: `{{ url_for('settings_blueprint.validate_2fa_activation') }}`,
                                        type: 'POST',
                                        contentType: 'application/json',
                                        data: JSON.stringify(payload),
                                        success: function (data) {
                                            if (data.success) {
                                                $('#modal-2fa').modal('hide');
                                                location.reload();
                                            }
                                        },
                                        error: function () {
                                            document.querySelectorAll('[data-code-input]').forEach(input => input.setAttribute('disabled', 'enabled'));
                                            $('#footer-2fa .spinner-border').remove()
                                            $('#footer-2fa').prepend('<div class="alert alert-danger p-2 me-auto">Dataset Failed to Publish</div>');
                                            setTimeout(function () {
                                                $('#footer-2fa .alert').fadeOut(500, function () {
                                                    $(this).remove();
                                                });
                                            }, 3000);
                                        }
                                    });
                                });
                                var inputs = document.querySelectorAll('[data-code-input]');
                                // Attach an event listener to each input element
                                for (let i = 0; i < inputs.length; i++) {
                                    inputs[i].addEventListener('input', function (e) {
                                        // If the input field has a character, and there is a next input field, focus it
                                        if (e.target.value.length === e.target.maxLength && i + 1 < inputs.length) {
                                            inputs[i + 1].focus();
                                        }
                                    });
                                    inputs[i].addEventListener('keydown', function (e) {
                                        // If the input field is empty and the keyCode for Backspace (8) is detected, and there is a previous input field, focus it
                                        if (e.target.value.length === 0 && e.keyCode === 8 && i > 0) {
                                            inputs[i - 1].focus();
                                        }
                                    });
                                    // Ensure only numbers can be entered
                                    inputs[i].addEventListener('keypress', function (e) {
                                        if (!/[0-9]/.test(e.key)) {
                                            e.preventDefault();
                                        }
                                    });
                                }

                                document.addEventListener('paste', function (e) {
                                    let pasteData = (e.clipboardData || window.clipboardData).getData('text');
                                    if (/^\d+$/.test(pasteData)) {
                                        for (let i = 0; i < inputs.length && i < pasteData.length; i++) {
                                            inputs[i].value = pasteData[i];
                                        }
                                    }
                                    e.preventDefault();
                                });
                            });

                        } else {
                            alert('Failed to generate 2FA QR code. Please try again.');
                        }
                    },
                    error: function () {
                        alert('An error occurred while generating the 2FA QR code. Please try again.');
                    }
                });
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            const $newPasswordField = $('input[name="newPassword"]');
            const $repeatPasswordField = $('input[name="repeatNewPassword"]');
            const $oldPasswordField = $('input[name="oldPassword"]');
            const $submitButton = $('button[type="submit"]');
            const $form = $('#changePasswordForm');
            const $modal = $('#modal-report');

            let repeatPasswordValidationStarted = false;

            // Disable submit button initially
            $submitButton.prop('disabled', true);

            // Function to validate password strength
            function validatePasswordStrength(password) {
                const hasUppercase = /[A-Z]/.test(password);
                const hasNumber = /\d/.test(password);
                const hasSymbol = /[!@#$%^&*(),.?":{}|<>]/.test(password);
                const isValidLength = password.length >= 8;

                return hasUppercase && hasNumber && hasSymbol && isValidLength;
            }

            // Function to enable or disable the submit button
            function toggleSubmitButton() {
                const isOldPasswordValid = $oldPasswordField.val().length > 0;
                const isNewPasswordValid = validatePasswordStrength($newPasswordField.val());
                const isRepeatPasswordValid = $newPasswordField.val() === $repeatPasswordField.val();

                if (isOldPasswordValid && isNewPasswordValid && isRepeatPasswordValid && repeatPasswordValidationStarted) {
                    $submitButton.prop('disabled', false); // Enable submit button
                } else {
                    $submitButton.prop('disabled', true); // Disable submit button
                }
            }

            // Function to validate passwords
            function validatePasswords() {
                const newPassword = $newPasswordField.val();
                const repeatPassword = $repeatPasswordField.val();

                // Validate new password strength
                if (validatePasswordStrength(newPassword)) {
                    $newPasswordField.addClass('is-valid').removeClass('is-invalid');
                } else {
                    $newPasswordField.addClass('is-invalid').removeClass('is-valid');
                }

                // Validate repeat password only if the user has typed in it
                if (repeatPasswordValidationStarted) {
                    if (newPassword === repeatPassword) {
                        $repeatPasswordField.addClass('is-valid').removeClass('is-invalid');
                    } else {
                        $repeatPasswordField.addClass('is-invalid').removeClass('is-valid');
                    }
                }

                // Toggle submit button based on validation results
                toggleSubmitButton();
            }

            // Trigger validation only when the repeat password field has input
            $repeatPasswordField.on('input', function () {
                repeatPasswordValidationStarted = true;
                validatePasswords();
            });

            // Validate new password while typing
            $newPasswordField.on('input', validatePasswords);
            $oldPasswordField.on('input', toggleSubmitButton); // Check old password validity on input

            // AJAX form submission
            $form.on('submit', function (event) {
                event.preventDefault();

                const formData = $form.serialize();

                // Remove previous alerts
                $modal.find('.alert').remove();

                $.ajax({
                    url: 'settings/change-password',
                    type: 'POST',
                    data: formData,
                    success: function (data) {
                        if (data.success) {
                            // Display the success message from the server
                            const successAlert = $('<div class="alert alert-success" id="alert-password"></div>').text(data.message);
                            $modal.find('.modal-body').append(successAlert);

                            // Reset form and fields
                            $form[0].reset();
                            $newPasswordField.removeClass('is-valid is-invalid');
                            $repeatPasswordField.removeClass('is-valid is-invalid');
                            $oldPasswordField.removeClass('is-invalid');
                            repeatPasswordValidationStarted = false;

                            // Disable submit button
                            $submitButton.prop('disabled', true);

                            // Close modal after 3.5 seconds and remove alerts
                            setTimeout(function () {
                                const modalInstance = bootstrap.Modal.getInstance($modal[0]);
                                modalInstance.hide();
                            }, 3500);
                        }
                    },
                    error: function (jqXHR) {
                        let response;
                        try {
                            response = JSON.parse(jqXHR.responseText); // Parse error response
                        } catch (e) {
                            response = { message: "An unexpected error occurred. Please try again." };
                        }

                        // Handle errors from the response
                        const errorAlert = $('<div class="alert alert-danger" id="alert-password"></div>').text(response.message);
                        $modal.find('.modal-body').append(errorAlert);

                        // Apply invalid classes based on error code in response
                        if (response.error_code === 1) {
                            $oldPasswordField.addClass('is-invalid');
                        } else if (response.error_code === 2 || response.error_code === 3) {
                            $newPasswordField.addClass('is-invalid');
                            $repeatPasswordField.addClass('is-invalid');
                        }
                    }
                });
            });

            // Clear inputs and remove alerts when modal is closed (manually or after success)
            $modal.on('hidden.bs.modal', function () {
                // Reset the form
                $form[0].reset();

                // Remove validation classes
                $newPasswordField.removeClass('is-valid is-invalid');
                $repeatPasswordField.removeClass('is-valid is-invalid');
                $oldPasswordField.removeClass('is-invalid');
                repeatPasswordValidationStarted = false;

                // Disable submit button
                $submitButton.prop('disabled', true);

                // Remove alerts
                $modal.find('.alert').remove();
            });
        });
    </script>
    <script>
        function validateEmail(email) {
            const re = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return re.test(String(email).toLowerCase());
        }

        const emailInput = document.getElementById('emailInput');
        const submitButton = document.getElementById('emailSubmitButton');

        emailInput.addEventListener('input', function () {
            const emailValue = emailInput.value.trim(); // Use .value for vanilla JavaScript
            const currentEmail = '{{ session['USER_EMAIL'] }}'; // current email from session

            // Validate the email format
            if (validateEmail(emailValue) && emailValue !== currentEmail) {
                emailInput.classList.add('is-valid');
                emailInput.classList.remove('is-invalid');
                submitButton.classList.remove('disabled');
            } else {
                emailInput.classList.add('is-invalid');
                emailInput.classList.remove('is-valid');
                submitButton.classList.add('disabled');
            }
        });
    </script>
    <script>
        $(document).ready(function () {
            const $emailInput = $('#emailInput');
            const $emailInputDiv = $('#emailInputDiv');
            const $emailSubmitButton = $('#emailSubmitButton');
            const $otpModal = $('#otpModal');
            const $otpInputModal = $('#otpInputModal');
            const $otpSubmitButtonModal = $('#otpSubmitButtonModal');
            const $otpError = $('#otpError');
            const $errorModal = $('#modal-danger');
            const $errorModalBody = $('#errorModalBody');
            const $spinner = $('<span class="input-icon-addon"><div class="spinner-border spinner-border-sm text-secondary" role="status"></div></span>');
            let newEmail = '';

            // Show error modal for 3.5 seconds and close it
            function showErrorModal(message) {
                $errorModalBody.text(message);  // Set the error message
                $errorModal.modal('show');      // Show the modal

                // Automatically hide the modal after 3.5 seconds
                setTimeout(function () {
                    $errorModal.modal('hide');
                }, 3500);
            }

            // Handle email change request (request OTP)
            $emailSubmitButton.on('click', function (event) {
                event.preventDefault();

                newEmail = $emailInput.val().trim();

                // Remove 'is-valid' class and add spinner next to the email input
                $emailInput.removeClass('is-valid');
                $emailInput.after($spinner);

                // Disable the submit button
                $emailSubmitButton.addClass('disabled');

                // Send request for OTP
                $.ajax({
                    url: 'settings/request-email-change',
                    type: 'POST',
                    data: { newEmail: newEmail },
                    success: function (data) {
                        // Remove spinner and re-enable the submit button
                        $spinner.remove();

                        if (data.success) {
                            // Show the OTP modal for OTP input
                            $otpModal.modal('show');
                        } else {
                            showErrorModal(data.message);
                        }
                    },
                    error: function (jqXHR) {
                        // Remove spinner and re-enable the submit button in case of error
                        $spinner.remove();

                        let response;
                        try {
                            response = JSON.parse(jqXHR.responseText);
                        } catch (e) {
                            response = { message: 'An unexpected error occurred. Please try again.' };
                            $emailSubmitButton.removeClass('disabled');
                        }

                        if (jqXHR.status === 409) {
                            showErrorModal('This email is already associated with another account.');
                        } else if (jqXHR.status === 400) {
                            showErrorModal(response.message);
                        } else {
                            showErrorModal(response.message);
                        }
                    }
                });
            });


            // Function to validate OTP input
            function validateOtpInput() {
                const otp = $otpInputModal.val().trim();
                const isValidOtp = /^\d{6}$/.test(otp);  // Regular expression to check for six-digit numeric code

                // Add validation classes and toggle submit button
                if (isValidOtp) {
                    $otpInputModal.removeClass('is-invalid').addClass('is-valid');
                    $otpSubmitButtonModal.removeClass('disabled');  // Enable submit button
                } else {
                    $otpInputModal.removeClass('is-valid').addClass('is-invalid');
                    $otpSubmitButtonModal.addClass('disabled');  // Disable submit button
                }
            }

            // Event listener for OTP input field to validate as the user types
            $otpInputModal.on('input', function () {
                validateOtpInput();  // Validate OTP input on every change
            });

            // Handle OTP verification in the modal
            $otpSubmitButtonModal.on('click', function (event) {
                event.preventDefault();
                $otpSubmitButtonModal.addClass("disabled");

                const otp = $otpInputModal.val().trim();

                if (!otp) {
                    $otpError.text('Please enter the OTP.').show();
                    return;
                }

                // Submit OTP for verification
                $.ajax({
                    url: 'settings/verify-email-otp',
                    type: 'POST',
                    data: { otp: otp },
                    success: function (data) {
                        if (data.success) {
                            // Display success message in the modal
                            const successAlert = $('<div class="alert alert-success mt-2">Email updated successfully!</div>');
                            $otpModal.find('.modal-body').append(successAlert);
                            $otpError.hide(); // Hide any previous error messages

                            // Update the email field in the form with the new email
                            $emailInput.val(newEmail);

                            // Close the modal after 3.5 seconds
                            setTimeout(function () {
                                const modalInstance = bootstrap.Modal.getInstance($otpModal[0]);
                                modalInstance.hide();
                            }, 3500);
                        } else {
                            $otpError.text(data.message).show();  // Show the error message in the modal
                        }
                    },
                    error: function (jqXHR) {
                        $otpError.text('Failed to verify OTP. Please try again.').show();
                    }
                });
            });

            // Clear modal and error messages when the modal is closed
            $otpModal.on('hidden.bs.modal', function () {
                $otpInputModal.val(''); // Clear the OTP input
                $otpError.hide(); // Hide any error message
                $otpModal.find('.alert').remove(); // Remove any success alert
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            $('#modal-creds').on('show.bs.modal', function () {
                $.ajax({
                    url: '/stelar/api/v1/users/s3/credentials',
                    type: 'GET',
                    success: function (data) {
                        if (data.success) {
                            $('#minio-endpoint').val(data.result.creds.S3Url);
                            $('#access-key').val(data.result.creds.AccessKeyId);
                            $('#secret-key').val(data.result.creds.SecretAccessKey);
                            $('#session-token').val(data.result.creds.SessionToken);
                        } else {
                            alert('Failed to fetch credentials. Please try again.');
                        }
                    },
                    error: function () {
                        alert('An error occurred while fetching the credentials. Please try again.');
                    }
                });
            });

            function copyToClipboard(elementId) {
                var copyText = document.getElementById(elementId);
                copyText.select();
                copyText.setSelectionRange(0, 99999); // For mobile devices
                document.execCommand("copy");
            }

            $('#copy-endpoint').on('click', function () {
                copyToClipboard('minio-endpoint');
            });

            $('#copy-access-key').on('click', function () {
                copyToClipboard('access-key');
            });

            $('#copy-secret-key').on('click', function () {
                copyToClipboard('secret-key');
            });

            $('#copy-session-token').on('click', function () {
                copyToClipboard('session-token');
            });
        });
    </script>


</body>

</html>