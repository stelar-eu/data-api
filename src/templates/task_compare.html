<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>STELAR | Compare Tasks</title>
  <!-- CSS files -->
  {% include 'tabler.html' %}
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="{{ url_for('static', filename='images.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='stelar.css') }}" />
  <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
  <link rel="icon" href="{{ url_for('static', filename='favico.png') }}" type="image/png">

  <style>
    .comparison-controls {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .comparison-mode-selector {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .comparison-info {
      font-size: 0.875rem;
      color: #6c757d;
      margin-top: 0.5rem;
    }
    .comparable-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    .comparable-yes { background-color: #198754; }
    .comparable-no { background-color: #dc3545; }
    .comparable-partial { background-color: #ffc107; }
    
    /* Parameter change highlighting */
    .param-changed {
      background-color: #fff3cd !important;
      border-left: 4px solid #ffc107 !important;
      position: relative;
    }
  
    .param-unchanged {
      background-color: #f8f9fa;
    }
    
    /* Ensure proper spacing and no overlap */
    .param-changed td {
      padding-right: 4px !important;
    }
    
    /* Keep consistent table layout without fixed widths */
    .parameters-cell table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .parameters-cell th,
    .parameters-cell td {
      word-wrap: break-word;
      vertical-align: top;
      padding: 8px;
    }
    
    .parameters-cell th {
      text-align: left;
      white-space: nowrap;
    }
    
    /* Parameter comparison legend */
    .param-legend {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }
    .param-legend-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .param-legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid #dee2e6;
    }
    
    /* Metrics Dashboard Styles - Tabler Integration */
    .metrics-dashboard {
      background: #fff;
      border: 1px solid var(--tblr-border-color);
      border-radius: var(--tblr-border-radius);
      margin-bottom: 1.5rem;
      box-shadow: var(--tblr-box-shadow-border);
    }
    
    .dashboard-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--tblr-border-color);
      background: var(--tblr-bg-surface);
    }
    
    .dashboard-body {
      padding: 1.5rem;
    }
    
    .dashboard-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--tblr-body-color);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chart-toggles {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .chart-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1;
      color: var(--tblr-btn-color);
      text-align: center;
      text-decoration: none;
      vertical-align: middle;
      cursor: pointer;
      user-select: none;
      background-color: var(--tblr-btn-bg);
      border: var(--tblr-btn-border-width) solid var(--tblr-btn-border-color);
      border-radius: var(--tblr-btn-border-radius);
      transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    }
    
    .chart-toggle:hover {
      color: var(--tblr-btn-hover-color);
      background-color: var(--tblr-btn-hover-bg);
      border-color: var(--tblr-btn-hover-border-color);
    }
    
    .chart-toggle.active {
      color: var(--tblr-primary-fg);
      background-color: var(--tblr-primary);
      border-color: var(--tblr-primary);
    }
    
    .chart-toggle input[type="checkbox"] {
      margin: 0;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .chart-card {
      background: #fff;
      border: 1px solid var(--tblr-border-color);
      border-radius: var(--tblr-border-radius);
      overflow: hidden;
      transition: box-shadow .15s ease-in-out;
    }
    
    .chart-card:hover {
      box-shadow: var(--tblr-box-shadow-lg);
    }
    
    .chart-card.hidden {
      display: none;
    }
    
    .chart-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--tblr-border-color);
      background: var(--tblr-bg-surface);
    }
    
    .chart-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--tblr-body-color);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chart-body {
      padding: 1.5rem;
      position: relative;
      height: 300px;
    }
    
    .chart-canvas {
      width: 100% !important;
      height: 100% !important;
    }
    
    /* Chart Controls */
    .chart-controls {
      display: flex;
      gap: 0.25rem;
    }
    
    .chart-control-btn {
      padding: 0.25rem;
      border: 1px solid var(--tblr-border-color);
      background: transparent;
      border-radius: var(--tblr-border-radius-sm);
      color: var(--tblr-body-color);
      cursor: pointer;
      transition: all 0.15s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chart-control-btn:hover {
      background: var(--tblr-bg-surface-secondary);
      border-color: var(--tblr-border-color-dark);
    }
    
    /* Fullscreen chart modal body */
    .chart-fullscreen-body {
      height: 70vh;
      position: relative;
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- Navbar -->
    {% include 'header.html' %}
    <div class="page-wrapper">
      <!-- Page header -->
      <div class="page-header d-print-none">
        <div class="container-xl">
          <div class="row g-2 align-items-center">
            <div class="col">
              <!-- Page pre-title -->
              <div class="page-pretitle">PROCESSES</div>
              <h3 class="page-title">
                <ol class="breadcrumb breadcrumb-arrows">
                  <li class="breadcrumb-item"><a class="text-secondary"
                      href="{{ url_for('dashboard_blueprint.processes')}}">
                      Workflow Processes
                    </a>
                  </li>
                  <li class="breadcrumb-item active"><a href="#"><span class="text-strong">Compare Tasks</span></a></li>
                </ol>
              </h3>
              <p class="mt-3 text-sm text-secondary">
                Use this page to compare the performance of two or more tasks. Select the tasks you want to compare from
                the
                list below. The comparison will contrast the performance metrics of the selected tasks, utilized input
                artifacts and produced output ones,
                allowing you to analyze their efficiency and effectiveness in the context of your project.
                This can help you identify which tasks are performing well and which may need optimization or further
                investigation.
              </p>
            </div>
          </div>
        </div>
      </div>
      <!-- Page body -->
      <div class="page-body">
        <div class="container-xl">
          
          {% if tasks and tasks|length > 1 %}
          <!-- Metrics Dashboard -->
          <div class="card mb-3">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center w-100 flex-wrap gap-3">
                <h3 class="card-title">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M3 12m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v6a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                    <path d="M9 8m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v10a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                    <path d="M15 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v14a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                    <path d="M4 20l14 0"></path>
                  </svg>
                  Collective Overview
                </h3>
              </div>
            </div>
            
            <div class="card-body">
              <!-- Summary Statistics -->
              <div class="row mb-4">
                <div class="col-sm-6 col-lg-3">
                  <div class="card card-sm">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-auto">
                          <span class="bg-primary text-white avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2"></path>
                              <path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z"></path>
                              <path d="M9 12l2 2l4 -4"></path>
                            </svg>
                          </span>
                        </div>
                        <div class="col">
                          <div class="font-weight-medium" id="totalTasks">{{ tasks|length }}</div>
                          <div class="text-muted">Total Tasks</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                  <div class="card card-sm">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-auto">
                          <span class="bg-success text-white avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path d="M5 12l5 5l10 -10"></path>
                            </svg>
                          </span>
                        </div>
                        <div class="col">
                          <div class="font-weight-medium" id="completedTasks">-</div>
                          <div class="text-muted">Completed</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                  <div class="card card-sm">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-auto">
                          <span class="bg-warning text-white avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                              <path d="M12 7v5l3 3"></path>
                            </svg>
                          </span>
                        </div>
                        <div class="col">
                          <div class="font-weight-medium" id="avgDuration">-</div>
                          <div class="text-muted">Avg Duration</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                  <div class="card card-sm">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-auto">
                          <span class="bg-info text-white avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path d="M3 12m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v6a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                              <path d="M9 8m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v10a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                              <path d="M15 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v14a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                            </svg>
                          </span>
                        </div>
                        <div class="col">
                          <div class="font-weight-medium" id="totalMetrics">-</div>
                          <div class="text-muted">Metrics Available</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Charts Container -->
              <div class="charts-grid">
                <div class="card" data-chart-type="duration">
                  <div class="card-header">
                    <h3 class="card-title me-auto">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                        <path d="M12 7v5l3 3"></path>
                      </svg>
                      Task Duration
                    </h3>
                    <div class="chart-controls">
                      <button class="btn btn-icon ms-auto" onclick="fullscreenChart('duration', 'Task Duration Comparison')" title="Fullscreen" data-bs-toggle="modal" data-bs-target="#chartFullscreenModal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                          <path d="M4 8v-2a2 2 0 0 1 2 -2h2"></path>
                          <path d="M4 16v2a2 2 0 0 0 2 2h2"></path>
                          <path d="M16 4h2a2 2 0 0 1 2 2v2"></path>
                          <path d="M16 20h2a2 2 0 0 0 2 -2v-2"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="chart-body card-body">
                    <canvas id="durationChart" class="chart-canvas"></canvas>
                  </div>
                </div>
                
                <div class="card" data-chart-type="performance">
                  <div class="card-header">
                    <h3 class="card-title me-auto">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                        <path d="M12 3l0 9l4.5 4.5"></path>
                        <path d="M9 12l0 -9"></path>
                      </svg>
                      Key Performance Metrics
                    </h3>
                    <div class="chart-controls">
                      <button class="btn btn-icon ms-auto" onclick="fullscreenChart('performance', 'Key Performance Metrics')" title="Fullscreen" data-bs-toggle="modal" data-bs-target="#chartFullscreenModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                          <path d="M4 8v-2a2 2 0 0 1 2 -2h2"></path>
                          <path d="M4 16v2a2 2 0 0 0 2 2h2"></path>
                          <path d="M16 4h2a2 2 0 0 1 2 2v2"></path>
                          <path d="M16 20h2a2 2 0 0 0 2 -2v-2"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="chart-body card-body">
                    <canvas id="performanceChart" class="chart-canvas"></canvas>
                  </div>
                </div>
                
                <div class="card" data-chart-type="comparison">
                  <div class="card-header">
                    <h3 class="card-title me-auto">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M3 12m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v6a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                        <path d="M9 8m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v10a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                        <path d="M15 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v14a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                        <path d="M4 20l14 0"></path>
                      </svg>
                      Metrics Trend
                    </h3>
                    <div class="chart-controls">
                      <button class="btn btn-icon ms-auto" onclick="fullscreenChart('comparison', 'Metrics Trend Analysis')" title="Fullscreen" data-bs-toggle="modal" data-bs-target="#chartFullscreenModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                          <path d="M4 8v-2a2 2 0 0 1 2 -2h2"></path>
                          <path d="M4 16v2a2 2 0 0 0 2 2h2"></path>
                          <path d="M16 4h2a2 2 0 0 1 2 2v2"></path>
                          <path d="M16 20h2a2 2 0 0 0 2 -2v-2"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="chart-body card-body">
                    <canvas id="comparisonChart" class="chart-canvas"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          
          <!-- Tabler Fullscreen Chart Modal -->
          <div class="modal modal-blur fade" id="chartFullscreenModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="fullscreenChartTitle">Chart</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body chart-fullscreen-body">
                  <canvas id="fullscreenChart" class="chart-canvas"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          {% if tasks and tasks|length > 1 %}
          <div class="comparison-controls">
            <div class="comparison-mode-selector">
              <label class="form-label fw-bold">Comparison Mode:</label>
              <div class="form-check mt-1">
                <input class="form-check-input" type="radio" name="comparisonMode" id="compareFirst" value="first" checked>
                <label class="form-check-label" for="compareFirst">
                  Compare against first task
                </label>
              </div>
              <div class="form-check mt-1">
                <input class="form-check-input" type="radio" name="comparisonMode" id="compareAverage" value="average">
                <label class="form-check-label" for="compareAverage">
                  Compare against average
                </label>
              </div>
            </div>
            <div class="comparison-info">
              <div id="comparabilityStatus"></div>
              <div class="param-legend">
                <div class="param-legend-item">
                  <div class="param-legend-color" style="background-color: #fff3cd; border-color: #ffc107;"></div>
                  <span>Different Value</span>
                </div>
                <div class="param-legend-item">
                  <div class="param-legend-color" style="background-color: #f8f9fa; border-color: #dee2e6;"></div>
                  <span>Same Value</span>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          
          <div class="card">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-vcenter table-bordered table-nowrap card-table">
                  <tr>
                    <td class="w-1"></td>
                    {% if tasks %}
                    {% for task in tasks %}
                    <td class="text-center">
                      <div class="h2 text-wrap fw-bold mt-1 mb-0">
                        <a href="{{url_for('dashboard_blueprint.task', process_id=task.get('process_id'), task_id=task.get('id'))}}"
                           target="_blank">{{task.get('name','Task ' + task.id)}}</a>
                      </div>

                      <div class="d-flex text-muted align-items-center justify-content-center my-2">
      
                          <span id="task-state-text" class="ms-2 me-0">{{ task.exec_state |
                          capitalize }}</span>
                    
                        <span id="task-state-badge"
                          class="status-indicator {% if task.exec_state == 'succeeded' %}status-green{% elif task.exec_state == 'failed' %}status-red{% elif task.exec_state == 'created' %}status-secondary{% else %}status-yellow status-indicator-animated{% endif %}">
                          <span class="status-indicator-circle"></span>
                          <span class="status-indicator-circle"></span>
                          <span class="status-indicator-circle"></span>
                        </span>
                      </div>
                      <a href="{{url_for('dashboard_blueprint.task', process_id=task.get('process_id'), task_id=task.get('id'))}}"
                         target="_blank"
                         class="btn w-100 mt-2">
                        Open Task</a>
                    </td>
                    {% endfor %} 
                    {% endif %}
                  </tr>
                  <tbody>
                    <tr class="bg-light">
                      <th colspan="{% if tasks %}{{ tasks|length + 1 }}{% endif %}" class="subheader">
                        General Information
                      </th>
                    </tr>

                    <tr>
                      <td>ID</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td class="text-center">
                        <div class="p text-wrap">
                          <span id="task-{{ task.id }}"><code>{{ task.id }}</code></span>
                          <button type="button" class="btn btn-pill ms-1 px-2 py-0 btn-sm btn-outline-secondary" onclick="
                            navigator.clipboard.writeText(document.getElementById('task-{{ task.id }}').innerText);
                            var el = document.getElementById('task-{{ task.id }}');
                            el.classList.remove('glowing-text');
                            void el.offsetWidth; // trigger reflow to restart animation
                            el.classList.add('glowing-text');">
                            COPY
                          </button>                         
                        </div>
                      </td>
                      {% endfor %} 
                      {% endif %}                      
                    </tr>
                    <tr>
                      <td>Workflow Process</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td class="text-center">
                        <div class="p text-wrap">
                          <a href="{{url_for('dashboard_blueprint.process', process_id=task.get('process_id'))}}"
                             target="_blank">Open Workflow Process</a>
                        </div>                   
                      </td>
                      {% endfor %} 
                      {% endif %}
                   
                    </tr>

                    <tr>
                      <td>Creator</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td class="text-center fw-bold">
                        <div class="p text-wrap">
                          {{task.get('creator', 'Not specified')}}
                        </div>
                      </td>
                      {% endfor %} 
                      {% endif %}
                    </tr>
                    <tr>
                      <td>Start Date</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td class="text-center">
                        <div class="p text-wrap">
                          {{task.get('start_date', 'Not specified').strftime('%d-%m-%Y %H:%M:%S')}}
                        </div>
                      </td>
                      {% endfor %} 
                      {% endif %}
                    </tr>
                    <tr>
                      <td>End Date</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td class="text-center">
                        <div class="p text-wrap">
                          {% if task.get('end_date') %}
                          {{ task.get('end_date').strftime('%d-%m-%Y %H:%M:%S') }}
                          {% else %}
                          Not Finished
                          {% endif %}
                        </div>
                      </td>
                      {% endfor %} 
                      {% endif %}
                    </tr>
                    <tr>
                      <td>Duration</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td class="text-center">
                        <div class="p text-wrap">
                            {% if task.get('start_date') %}
                            {% set end_date = task.get('end_date') or now %}
                            {% set duration_seconds = (end_date - task.start_date).total_seconds() %}
                            {% if duration_seconds < 60 %}
                            {{ "%.2f"|format(duration_seconds) }} seconds
                            {% elif duration_seconds < 3600 %}
                            {{ "%.2f"|format(duration_seconds / 60) }} minutes
                            {% elif duration_seconds < 86400 %}
                            {{ "%.2f"|format(duration_seconds / 3600) }} hours
                            {% elif duration_seconds < 604800 %}
                            {{ "%.2f"|format(duration_seconds / 86400) }} days
                            {% else %}
                            {{ "%.2f"|format(duration_seconds / 604800) }} weeks
                            {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                      </td>
                      {% endfor %} 
                      {% endif %}
                    </tr>
                    <tr class="bg-light">
                      <th colspan="{% if tasks %}{{ tasks|length + 1 }}{% endif %}" class="subheader">
                        TOOL INFORMATION
                      </th>
                    </tr>
                    <tr>
                      <td>Tool</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td class="text-center">
                        <div class="p text-wrap">
                          {% if task.get("tool") %}
                          <a href="{{ url_for('dashboard_blueprint.tool', tool_id=task.get('tool')) }}"
                             target="_blank">{{ task.get("tool") }}</a>
                          {% else %}
                          <span class="text-muted">-</span>
                          {% endif %}
                        </div>
                      </td>
                      {% endfor %} 
                      {% endif %}
                    </tr>
                    <tr>
                      <td>Tool Image</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td class="text-center">
                        <div class="p text-wrap">
                          {% if task.get("image") %}
                            <kbd>{{task.get("image") }}</kbd>
                          {% else %}
                            <span class="text-muted">Remote Task</span>
                          {% endif %}
                        </div>
                      </td>
                      {% endfor %} 
                      {% endif %}
                    </tr>
                    <tr class="bg-light">
                      <th colspan="{% if tasks %}{{ tasks|length + 1 }}{% endif %}" class="subheader">
                        Inputs
                      </th>
                    </tr>
                    <tr>
                      <td>Input Artifacts</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td>
                        <div class="text-small"></div>
                        {% if task.get('inputs') %}
                        {% for input_artifact in task.get('inputs', []) %}
                        <div id="tree-{{ task.id }}-{{ loop.index }}" class="jstree"></div>
                        <script>
                          document.addEventListener("DOMContentLoaded", function () {
                            const treeData = {
                              text: "<kbd>{{ input_artifact }}</kbd>",
                              id: "{{input_artifact }}",
                              children: [
                              {% for artifact in task.get('inputs')[input_artifact] %}
                              {
                                  {% set is_resource = artifact in resources %}
                                  {% set looks_like_id = artifact|length == 36 and artifact.isalnum() %}
                                  {% if is_resource or looks_like_id %}
                                    text   : "ðŸ“„ {{ resources[artifact].get('name', artifact) + ' - (' + artifact + ')' if is_resource else artifact }}",
                                    a_attr: {
                                      "href": "{{ url_for('dashboard_blueprint.viewResource', resource_id=artifact) }}",
                                      "target": "_blank",
                                      "onclick": "window.open(this.href, '_blank'); return false;"
                                    }
                                  {% else %}
                                    text : "{{ artifact }}",
                                  {% endif %}
                              }{{ "," if not loop.last }}
                              {% endfor %}
                              ]
                            };
                            $('#tree-{{ task.id }}-{{ loop.index }}').jstree({
                              'core': {
                                'themes': {
                                  'icons': false,
                                  'responsive': true
                                },
                                'data': [treeData]
                              }
                            });
                          });
                        </script>
                        <br>
                        {% endfor %}
                        {% else %}
                        <span class="text-muted">No inputs</span>
                        {% endif %}
                        </div>
                      </td>
                      {% endfor %}
                      {% endif %}
                    </tr>
                    <tr class="bg-light">
                      <th colspan="{% if tasks %}{{ tasks|length + 1 }}{% endif %}" class="subheader">
                        Outputs
                      </th>
                    </tr>
                    <tr>
                      <td>Output Artifacts</td>
                      {% if tasks %}
                      {% for task in tasks %}
                      <td>
                        <div class="text-small">
                          {% if task.get('outputs') %}
                          {% for output_key, output_data in task.get('outputs', {}).items() %}
                          <div>
                            <kbd>{{ output_key  }}</kbd> -> 
                            {% if output_data.get('resource_id', '') in resources %}
                            <a href="{{ url_for('dashboard_blueprint.viewResource', resource_id=output_data.get('resource_id')) }}"
                               target="_blank">{{ resources[output_data.get('resource_id')].get('name', output_data.get('resource_id')) }}</a>
                            {% else %}
                              {{ output_data.get("url")}}
                            {% endif %}
                          </div>
                          {% endfor %}
                          {% endif %}
                        </div>
                      </td>
                      {% endfor %}
                      {% endif %}
                    </tr>

                    <tr class="bg-light">
                      <th colspan="{% if tasks %}{{ tasks|length + 1 }}{% endif %}" class="subheader">
                        Parameters
                      </th>
                    </tr>
                    
                    {% macro render_tree(node, comparison_value=None, comparison_mode="first", is_first_task=False) -%}
                    {% if node is mapping %}
                    <table class="table table-sm table-bordered mb-0">
                      <thead class="table-light"></thead>
                      <tbody>
                      {% for key, val in node|dictsort %}
                        <tr>
                          <th scope="row">{{ key }}</th>
                          <td class="d-flex align-items-center parameter-cell" data-param-key="{{ key }}">
                            {% if val is mapping %}
                              {{ render_tree(val, comparison_value[key] if comparison_value and comparison_value[key] is defined else None, comparison_mode, is_first_task) }}
                            {% elif val is sequence and not val is string %}
                              {{ render_tree(val, comparison_value[key] if comparison_value and comparison_value[key] is defined else None, comparison_mode, is_first_task) }}
                            {% else %}
                              <code>{{ val }}</code>
                              {% if comparison_value and comparison_value[key] is defined %}
                                {% set o = comparison_value[key]|extract_number %}
                                {% set c = val|extract_number %}
                                {% if o is not none and c is not none and o != 0 %}
                                  {% set pct = ((c - o) / o * 100) %}
                                  {% set p = pct|round(0, 'common') %}
                                  {% if p > 0 %}
                                    <span class="text-green d-inline-flex align-items-center lh-1 ms-2">
                                      +{{ p }}%
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon ms-1 icon-2">
                                        <path d="M3 17l6 -6l4 4l8 -8"></path>
                                        <path d="M14 7l7 0l0 7"></path>
                                      </svg>
                                    </span>
                                  {% elif p < 0 %}
                                    <span class="text-red d-inline-flex align-items-center lh-1 ms-2">
                                      {{ p }}%
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon ms-1 icon-2">
                                        <path d="M3 7l6 6l4 -4l8 8"></path>
                                        <path d="M21 10l0 7l-7 0"></path>
                                      </svg>
                                    </span>
                                  {% else %}
                                    <span class="text-yellow d-inline-flex align-items-center lh-1 ms-2">
                                      0%
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon ms-1 icon-2">
                                        <path d="M5 12l14 0"></path>
                                      </svg>
                                    </span>
                                  {% endif %}
                                {% endif %}
                              {% endif %}
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                      </tbody>
                    </table>
                    {% elif node is sequence and not node is string %}
                    <table class="table table-sm table-bordered mb-0">
                      <thead class="table-light"></thead>
                      <tbody>
                      {% for item in node %}
                        <tr>
                          <td>{{ loop.index }}</td>
                          <td class="parameter-cell">{{ render_tree(item, comparison_value, comparison_mode, is_first_task) }}</td>
                        </tr>
                      {% endfor %}
                      </tbody>
                    </table>
                    {% else %}
                    <code>{{ node }}</code>
                    {% endif %}
                    {%- endmacro %}

                    <tr>
                      <td>Parameters</td>
                      {% for task in tasks %}
                        <td class="p-0 parameters-cell" data-task-index="{{ loop.index0 }}">
                          {% if task.parameters %}
                            {{ render_tree(task.parameters, None, "first", loop.index0 == 0) }}
                          {% else %}
                            <span class="text-muted">No parameters</span>
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>

                    <tr class="bg-light">
                      <th colspan="{{ tasks|length + 1 }}" class="subheader">Metrics</th>
                    </tr>
                    <tr>
                      <td>Metrics</td>
                      {% for task in tasks %}
                        <td class="p-0 metrics-cell" data-task-index="{{ loop.index0 }}">
                          {% if task.metrics %}
                            <div class="metrics-content">
                              {{ render_tree(task.metrics) }}
                            </div>
                          {% else %}
                            <span class="text-muted">No metrics</span>
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>

                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% include 'footer.html'%}
  </div>

  <script>
    // Global chart instances storage
    let chartInstances = {};
    let fullscreenChartInstance = null;
    let currentZoomLevel = 1;

    // Global variables for metrics data
    let tasksMetrics = [];
    let tasksParameters = [];
    let taskDurations = [];
    let taskNames = [];
    function extractNumber(value) {
      if (typeof value === 'number') return value;
      if (typeof value === 'string') {
        const match = value.match(/[\d.]+/);
        return match ? parseFloat(match[0]) : null;
      }
      return null;
    }

    function areValuesComparable(values) {
      return values.filter(v => extractNumber(v) !== null).length >= 2;
    }

    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds.toFixed(1)}s`;
      if (seconds < 3600) return `${(seconds / 60).toFixed(1)}m`;
      if (seconds < 86400) return `${(seconds / 3600).toFixed(1)}h`;
      return `${(seconds / 86400).toFixed(1)}d`;
    }

    document.addEventListener("DOMContentLoaded", function() {
      // Initialize global data arrays
      tasksMetrics = [
        {% for task in tasks %}
        {% if task.metrics %}
        {{ task.metrics | tojson | safe }}
        {% else %}
        null
        {% endif %}
        {{ "," if not loop.last }}
        {% endfor %}
      ];

      tasksParameters = [
        {% for task in tasks %}
        {% if task.parameters %}
        {{ task.parameters | tojson | safe }}
        {% else %}
        null
        {% endif %}
        {{ "," if not loop.last }}
        {% endfor %}
      ];

      taskDurations = [
        {% for task in tasks %}
        {% if task.get('start_date') %}
        {% set end_date = task.get('end_date') or now %}
        {% set duration_seconds = (end_date - task.start_date).total_seconds() %}
        {{ duration_seconds }}
        {% else %}
        0
        {% endif %}
        {{ "," if not loop.last }}
        {% endfor %}
      ];

      taskNames = [
        {% for task in tasks %}
        "{{ task.get('name', 'Task ' + task.id) }}"{{ "," if not loop.last }}
        {% endfor %}
      ];

      // Function to highlight parameter differences (with debugging)
      function highlightParameterDifferences() {
        console.log('Starting parameter highlighting...');
        
        if (tasksParameters.length < 2) {
          console.log('Not enough tasks to compare parameters');
          return;
        }
        
        // Try multiple selectors to find parameter cells
        let parameterCells = document.querySelectorAll('.parameters-cell');
        if (parameterCells.length === 0) {
          parameterCells = document.querySelectorAll('td.p-0[data-task-index]');
        }
        if (parameterCells.length === 0) {
          parameterCells = document.querySelectorAll('td.p-0');
        }
        
        console.log(`Found ${parameterCells.length} parameter cells`);
        
        if (parameterCells.length === 0) return;
        
        // Collect all parameter data
        const allParameterData = {};
        
        parameterCells.forEach((cell, taskIndex) => {
          console.log(`Processing task ${taskIndex}`);
          
          // Try different selectors for finding rows
          let rows = cell.querySelectorAll('tbody tr');
          if (rows.length === 0) {
            rows = cell.querySelectorAll('table tr');
          }
          if (rows.length === 0) {
            rows = cell.querySelectorAll('tr');
          }
          
          console.log(`Found ${rows.length} rows in task ${taskIndex}`);
          
          rows.forEach((row, rowIndex) => {
            // Try different selectors for finding key and value cells
            let keyCell = row.querySelector('th[scope="row"]');
            if (!keyCell) keyCell = row.querySelector('th');
            
            let valueCell = row.querySelector('td code');
            if (!valueCell) valueCell = row.querySelector('code');
            if (!valueCell) valueCell = row.querySelector('td');
            
            if (keyCell && valueCell) {
              const paramKey = keyCell.textContent.trim();
              const paramValue = valueCell.textContent.trim();
              
              if (paramKey && paramValue) {
                console.log(`Found parameter: ${paramKey} = ${paramValue} (task ${taskIndex})`);
                
                if (!allParameterData[paramKey]) {
                  allParameterData[paramKey] = {};
                }
                allParameterData[paramKey][taskIndex] = {
                  value: paramValue,
                  row: row
                };
              }
            }
          });
        });
        
        console.log('All parameter data:', allParameterData);
        
        // Check for differences and apply highlighting
        Object.keys(allParameterData).forEach(paramKey => {
          const paramData = allParameterData[paramKey];
          const taskIndices = Object.keys(paramData);
          
          if (taskIndices.length < 2) return;
          
          // Get all unique values
          const uniqueValues = new Set();
          taskIndices.forEach(taskIndex => {
            uniqueValues.add(paramData[taskIndex].value);
          });
          
          const hasDifferentValues = uniqueValues.size > 1;
          
          console.log(`Parameter ${paramKey}: ${uniqueValues.size} unique values`, Array.from(uniqueValues));
          
          // Apply highlighting
          taskIndices.forEach(taskIndex => {
            const row = paramData[taskIndex].row;
            row.classList.remove('param-unchanged', 'param-changed');
            
            if (hasDifferentValues) {
              row.classList.add('param-changed');
              console.log(`Highlighting ${paramKey} as changed in task ${taskIndex}`);
            } else {
              row.classList.add('param-unchanged');
              console.log(`Marking ${paramKey} as unchanged in task ${taskIndex}`);
            }
          });
        });
        
        console.log('Parameter highlighting completed');
      }

      // Function to calculate average of comparable values
      function calculateAverages(metricsArray) {
        if (!metricsArray || metricsArray.length === 0) return null;
        
        const averages = {};
        
        function processObject(obj, result) {
          for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
              const values = metricsArray.map(m => m && m[key]).filter(v => v !== undefined);
              
              if (values.length === 0) continue;
              
              if (typeof values[0] === 'object' && values[0] !== null && !Array.isArray(values[0])) {
                result[key] = {};
                processObject(values[0], result[key]);
                // Process nested objects
                values.forEach(v => {
                  if (v && typeof v === 'object') {
                    processObject(v, result[key]);
                  }
                });
              } else if (areValuesComparable(values)) {
                const numericValues = values.map(extractNumber).filter(v => v !== null);
                if (numericValues.length > 0) {
                  result[key] = numericValues.reduce((a, b) => a + b, 0) / numericValues.length;
                }
              }
            }
          }
        }
        
        const firstMetrics = metricsArray.find(m => m !== null);
        if (firstMetrics) {
          processObject(firstMetrics, averages);
        }
        
        return averages;
      }

      // Function to render metrics with comparison
      function renderMetricsWithComparison(metrics, comparisonMetrics, isFirst = false) {
        if (!metrics) return '<span class="text-muted">No metrics</span>';
        
        function renderValue(value, comparisonValue, key) {
          let html = `<code>${value}</code>`;
          
          if (!isFirst && comparisonValue !== undefined) {
            const numValue = extractNumber(value);
            const numComparison = extractNumber(comparisonValue);
            
            if (numValue !== null && numComparison !== null && numComparison !== 0) {
              const pct = ((numValue - numComparison) / numComparison * 100);
              const p = Math.round(pct);
              
              if (p > 0) {
                html += `<span class="text-green d-inline-flex align-items-center lh-1 ms-2">
                  +${p}%
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon ms-1 icon-2">
                    <path d="M3 17l6 -6l4 4l8 -8"></path>
                    <path d="M14 7l7 0l0 7"></path>
                  </svg>
                </span>`;
              } else if (p < 0) {
                html += `<span class="text-red d-inline-flex align-items-center lh-1 ms-2">
                  ${p}%
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon ms-1 icon-2">
                    <path d="M3 7l6 6l4 -4l8 8"></path>
                    <path d="M21 10l0 7l-7 0"></path>
                  </svg>
                </span>`;
              } else {
                html += `<span class="text-yellow d-inline-flex align-items-center lh-1 ms-2">
                  0%
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon ms-1 icon-2">
                    <path d="M5 12l14 0"></path>
                  </svg>
                </span>`;
              }
            }
          }
          
          return html;
        }
        
        function renderObject(obj, comparisonObj) {
          let html = '<table class="table table-sm table-bordered mb-0"><thead class="table-light"></thead><tbody>';
          
          for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
              html += `<tr><th scope="row">${key}</th><td class="d-flex align-items-center">`;
              
              if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
                html += renderObject(obj[key], comparisonObj ? comparisonObj[key] : undefined);
              } else {
                html += renderValue(obj[key], comparisonObj ? comparisonObj[key] : undefined, key);
              }
              
              html += '</td></tr>';
            }
          }
          
          html += '</tbody></table>';
          return html;
        }
        
        return renderObject(metrics, comparisonMetrics);
      }

      // Function to update metrics display
      function updateMetricsDisplay() {
        const mode = document.querySelector('input[name="comparisonMode"]:checked').value;
        const metricsCells = document.querySelectorAll('.metrics-cell');
        
        let comparisonMetrics;
        if (mode === 'first') {
          comparisonMetrics = tasksMetrics[0];
        } else {
          comparisonMetrics = calculateAverages(tasksMetrics.filter(m => m !== null));
        }
        
        metricsCells.forEach((cell, index) => {
          const taskMetrics = tasksMetrics[index];
          const isFirst = mode === 'first' && index === 0;
          
          if (taskMetrics) {
            cell.innerHTML = `<div class="metrics-content">${renderMetricsWithComparison(taskMetrics, comparisonMetrics, isFirst)}</div>`;
          } else {
            cell.innerHTML = '<span class="text-muted">No metrics</span>';
          }
        });
      }

      // Function to analyze comparability
      function analyzeComparability() {
        const validMetrics = tasksMetrics.filter(m => m !== null);
        if (validMetrics.length < 2) {
          return {
            status: 'insufficient',
            message: 'Not enough tasks with metrics for comparison',
            comparableCount: 0,
            totalCount: 0
          };
        }
        
        const allKeys = new Set();
        validMetrics.forEach(metrics => {
          function extractKeys(obj, prefix = '') {
            for (const key in obj) {
              if (obj.hasOwnProperty(key)) {
                const fullKey = prefix ? `${prefix}.${key}` : key;
                if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
                  extractKeys(obj[key], fullKey);
                } else {
                  allKeys.add(fullKey);
                }
              }
            }
          }
          extractKeys(metrics);
        });
        
        let comparableCount = 0;
        allKeys.forEach(key => {
          const values = validMetrics.map(metrics => {
            const keyParts = key.split('.');
            let value = metrics;
            for (const part of keyParts) {
              value = value ? value[part] : undefined;
            }
            return value;
          });
          
          if (areValuesComparable(values)) {
            comparableCount++;
          }
        });
        
        const totalCount = allKeys.size;
        const comparabilityRatio = totalCount > 0 ? comparableCount / totalCount : 0;
        
        let status, message;
        if (comparabilityRatio >= 0.8) {
          status = 'high';
          message = `High comparability: ${comparableCount}/${totalCount} metrics are comparable`;
        } else if (comparabilityRatio >= 0.5) {
          status = 'medium';
          message = `Medium comparability: ${comparableCount}/${totalCount} metrics are comparable`;
        } else if (comparableCount > 0) {
          status = 'low';
          message = `Low comparability: ${comparableCount}/${totalCount} metrics are comparable`;
        } else {
          status = 'none';
          message = 'No comparable metrics found';
        }
        
        return {
          status,
          message,
          comparableCount,
          totalCount,
          ratio: comparabilityRatio
        };
      }

      // Update comparability status
      function updateComparabilityStatus() {
        const statusElement = document.getElementById('comparabilityStatus');
        const analysis = analyzeComparability();
        
        let indicatorClass;
        switch (analysis.status) {
          case 'high':
            indicatorClass = 'comparable-yes';
            break;
          case 'medium':
            indicatorClass = 'comparable-partial';
            break;
          case 'low':
            indicatorClass = 'comparable-partial';
            break;
          default:
            indicatorClass = 'comparable-no';
        }
        
        statusElement.innerHTML = `
          <span class="comparable-indicator ${indicatorClass}"></span>
          ${analysis.message}
          ${analysis.status === 'none' || analysis.status === 'insufficient' ? 
            '<br><small class="text-muted">Percentage comparisons will not be available.</small>' : 
            '<br><small class="text-muted">Percentage comparisons available for numeric metrics.</small>'
          }
        `;
        
        // Enable/disable average mode based on comparability
        const averageRadio = document.getElementById('compareAverage');
        if (analysis.status === 'none' || analysis.status === 'insufficient') {
          averageRadio.disabled = true;
          averageRadio.parentElement.classList.add('text-muted');
          document.getElementById('compareFirst').checked = true;
        } else {
          averageRadio.disabled = false;
          averageRadio.parentElement.classList.remove('text-muted');
        }
      }

      // Event listeners for comparison mode change
      document.querySelectorAll('input[name="comparisonMode"]').forEach(radio => {
        radio.addEventListener('change', updateMetricsDisplay);
      });

      // Initial setup
      if (tasksMetrics.length > 1) {
        updateComparabilityStatus();
        updateMetricsDisplay();
      }
      
      // Highlight parameter differences
      if (tasksParameters.length > 1) {
        highlightParameterDifferences();
      }
      
      // Initialize metrics dashboard
      if (tasksMetrics.length > 1) {
        initializeMetricsDashboard();
      }
    });

    // Metrics Dashboard Functions
    function initializeMetricsDashboard() {
      console.log('Initializing metrics dashboard...');
      
      // Calculate summary statistics
      calculateSummaryStats();
      
      // Initialize charts
      initializeDurationChart();
      initializePerformanceChart();
      initializeComparisonChart();
      initializeDistributionChart();
      
      // Setup chart toggles
      setupChartToggles();
    }
    
    function calculateSummaryStats() {
      const totalTasks = tasksMetrics.length;
      const completedTasks = tasksMetrics.filter(m => m !== null).length;
      
      const validDurations = taskDurations.filter(d => d !== null && d > 0);
      const avgDuration = validDurations.length > 0 ? 
        (validDurations.reduce((a, b) => a + b, 0) / validDurations.length) : 0;
      
      const totalMetrics = tasksMetrics.reduce((count, metrics) => {
        if (!metrics) return count;
        return count + Object.keys(metrics).length;
      }, 0);
      
      // Update summary cards
      document.getElementById('totalTasks').textContent = totalTasks;
      document.getElementById('completedTasks').textContent = completedTasks;
      document.getElementById('avgDuration').textContent = formatDuration(avgDuration);
      document.getElementById('totalMetrics').textContent = totalMetrics;
    }
    
    function initializeDurationChart() {
      const ctx = document.getElementById('durationChart');
      if (!ctx) return;
      
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: taskNames,
          datasets: [{
            label: 'Duration (seconds)',
            data: taskDurations,
            backgroundColor: [
              '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
              '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
            ],
            borderColor: '#495057',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Duration: ${formatDuration(context.parsed.y)}`;
                }
              }
            },
            zoom: {
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: 'xy',
              },
              pan: {
                enabled: true,
                mode: 'xy'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatDuration(value);
                }
              }
            }
          }
        }
      });
      
      chartInstances['durationChart'] = chart;
    }
    
    function initializePerformanceChart() {
      const ctx = document.getElementById('performanceChart');
      if (!ctx) return;
      
      // Extract numeric metrics for performance comparison
      const performanceData = extractNumericMetrics();
      if (performanceData.length === 0) {
        ctx.getContext('2d').fillText('No numeric metrics available', 50, 50);
        return;
      }
      
      const chart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: performanceData.map(d => d.name),
          datasets: tasksMetrics.map((metrics, index) => ({
            label: `Task ${index + 1}`,
            data: performanceData.map(d => d.values[index] || 0),
            backgroundColor: `hsla(${index * 60}, 70%, 50%, 0.2)`,
            borderColor: `hsl(${index * 60}, 70%, 50%)`,
            borderWidth: 2
          })).filter(dataset => dataset.data.some(v => v > 0))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            zoom: {
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: 'xy',
              },
              pan: {
                enabled: true,
                mode: 'xy'
              }
            }
          },
          scales: {
            r: {
              beginAtZero: true
            }
          }
        }
      });
      
      chartInstances['performanceChart'] = chart;
    }
    
    function initializeComparisonChart() {
      const ctx = document.getElementById('comparisonChart');
      if (!ctx) return;
      
      const performanceData = extractNumericMetrics();
      if (performanceData.length === 0) return;
      
      // Show ALL metrics in trend analysis, not just first 3
      const datasets = performanceData.map((metric, metricIndex) => ({
        label: metric.name,
        data: metric.values,
        backgroundColor: `hsla(${metricIndex * 60}, 70%, 50%, 0.2)`,
        borderColor: `hsl(${metricIndex * 60}, 70%, 50%)`,
        borderWidth: 2,
        fill: false
      }));
      
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({length: tasksMetrics.length}, (_, i) => `Task ${i + 1}`),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            zoom: {
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: 'xy',
              },
              pan: {
                enabled: true,
                mode: 'xy'
              }
            }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
      chartInstances['comparisonChart'] = chart;
    }
    
    function initializeDistributionChart() {
      const ctx = document.getElementById('distributionChart');
      if (!ctx) return;
      
      const performanceData = extractNumericMetrics();
      if (performanceData.length === 0) return;
      
      // Create a pie chart showing metric distribution for the first task
      const firstTaskMetrics = performanceData.map(d => d.values[0] || 0);
      
      const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: performanceData.map(d => d.name),
          datasets: [{
            data: firstTaskMetrics,
            backgroundColor: [
              '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
              '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
      
      chartInstances['distributionChart'] = chart;
    }
    
    function extractNumericMetrics() {
      const numericMetrics = {};
      
      tasksMetrics.forEach((metrics, taskIndex) => {
        if (!metrics) return;
        
        function extractNumbers(obj, prefix = '') {
          Object.keys(obj).forEach(key => {
            const fullKey = prefix ? `${prefix}.${key}` : key;
            const value = obj[key];
            
            if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
              extractNumbers(value, fullKey);
            } else {
              const numValue = extractNumber(value);
              if (numValue !== null) {
                if (!numericMetrics[fullKey]) {
                  numericMetrics[fullKey] = Array(tasksMetrics.length).fill(0);
                }
                numericMetrics[fullKey][taskIndex] = numValue;
              }
            }
          });
        }
        
        extractNumbers(metrics);
      });
      
      return Object.keys(numericMetrics).map(key => ({
        name: key,
        values: numericMetrics[key]
      }));
    }
    
    function setupChartToggles() {
      document.querySelectorAll('.chart-toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
          const checkbox = this.querySelector('input[type="checkbox"]');
          const chartType = this.dataset.chart;
          
          checkbox.checked = !checkbox.checked;
          this.classList.toggle('active', checkbox.checked);
          
          const chartCard = document.querySelector(`[data-chart-type="${chartType}"]`);
          if (chartCard) {
            chartCard.classList.toggle('hidden', !checkbox.checked);
          }
        });
      });
    }

    // Chart Control Functions
    function zoomChart(chartId) {
      const chart = chartInstances[chartId];
      if (chart) {
        // Toggle zoom - if already zoomed, reset; otherwise zoom in
        if (chart.isZoomed) {
          chart.resetZoom();
          chart.isZoomed = false;
        } else {
          chart.zoom(1.5);
          chart.isZoomed = true;
        }
      }
    }

    function fullscreenChart(chartType, chartTitle) {
      const originalChart = chartInstances[chartType + 'Chart'];
      if (!originalChart) return;

      // Set modal title
      const titleElement = document.getElementById('fullscreenChartTitle');
      titleElement.textContent = chartTitle;
      
      // Reset zoom level
      currentZoomLevel = 1;
      
      // Destroy existing fullscreen chart if exists
      if (fullscreenChartInstance) {
        fullscreenChartInstance.destroy();
      }
      
      // Create chart configuration based on chart type
      let config;
      
      switch(chartType) {
        case 'duration':
          config = {
            type: 'bar',
            data: {
              labels: taskNames,
              datasets: [{
                label: 'Duration (seconds)',
                data: taskDurations,
                backgroundColor: [
                  '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
                  '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
                ],
                borderColor: '#495057',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return `Duration: ${formatDuration(context.parsed.y)}`;
                    }
                  }
                },
                zoom: {
                  zoom: {
                    wheel: { enabled: true },
                    pinch: { enabled: true },
                    mode: 'xy',
                  },
                  pan: {
                    enabled: true,
                    mode: 'xy'
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return formatDuration(value);
                    }
                  }
                }
              }
            }
          };
          break;
          
        case 'performance':
          const performanceData = extractNumericMetrics();
          config = {
            type: 'radar',
            data: {
              labels: performanceData.map(d => d.name),
              datasets: tasksMetrics.map((metrics, index) => ({
                label: `Task ${index + 1}`,
                data: performanceData.map(d => d.values[index] || 0),
                backgroundColor: `hsla(${index * 60}, 70%, 50%, 0.2)`,
                borderColor: `hsl(${index * 60}, 70%, 50%)`,
                borderWidth: 2
              })).filter(dataset => dataset.data.some(v => v > 0))
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' },
                zoom: {
                  zoom: {
                    wheel: { enabled: true },
                    pinch: { enabled: true },
                    mode: 'xy',
                  },
                  pan: {
                    enabled: true,
                    mode: 'xy'
                  }
                }
              },
              scales: {
                r: {
                  beginAtZero: true
                }
              }
            }
          };
          break;
          
        case 'comparison':
          const comparisonData = extractNumericMetrics();
          // Show ALL metrics in fullscreen, not just first 3
          const datasets = comparisonData.map((metric, metricIndex) => ({
            label: metric.name,
            data: metric.values,
            backgroundColor: `hsla(${metricIndex * 60}, 70%, 50%, 0.2)`,
            borderColor: `hsl(${metricIndex * 60}, 70%, 50%)`,
            borderWidth: 2,
            fill: false
          }));
          
          config = {
            type: 'line',
            data: {
              labels: Array.from({length: tasksMetrics.length}, (_, i) => `Task ${i + 1}`),
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' },
                zoom: {
                  zoom: {
                    wheel: { enabled: true },
                    pinch: { enabled: true },
                    mode: 'xy',
                  },
                  pan: {
                    enabled: true,
                    mode: 'xy'
                  }
                }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          };
          break;
          
        case 'distribution':
          const distributionData = extractNumericMetrics();
          const firstTaskMetrics = distributionData.map(d => d.values[0] || 0);
          
          config = {
            type: 'doughnut',
            data: {
              labels: distributionData.map(d => d.name),
              datasets: [{
                data: firstTaskMetrics,
                backgroundColor: [
                  '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
                  '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' },
                zoom: {
                  zoom: {
                    wheel: { enabled: true },
                    pinch: { enabled: true },
                    mode: 'xy',
                  },
                  pan: {
                    enabled: true,
                    mode: 'xy'
                  }
                }
              }
            }
          };
          break;
          
        default:
          console.error('Unknown chart type:', chartType);
          return;
      }
      
      // Create new fullscreen chart when modal is shown
      const fullscreenCanvas = document.getElementById('fullscreenChart');
      fullscreenChartInstance = new Chart(fullscreenCanvas, config);
      
      // Store reference to original chart type for zoom controls
      fullscreenChartInstance.originalType = chartType;
    }

    function closeFullscreenChart() {
      if (fullscreenChartInstance) {
        fullscreenChartInstance.destroy();
        fullscreenChartInstance = null;
      }
      currentZoomLevel = 1;
    }

    function zoomFullscreenChart(direction) {
      if (!fullscreenChartInstance) return;
      
      if (direction === 'in') {
        currentZoomLevel *= 1.2;
        fullscreenChartInstance.zoom(1.2);
      } else if (direction === 'out') {
        currentZoomLevel /= 1.2;
        fullscreenChartInstance.zoom(0.833); // 1/1.2
      }
    }

    function resetFullscreenChart() {
      if (!fullscreenChartInstance) return;
      
      fullscreenChartInstance.resetZoom();
      currentZoomLevel = 1;
    }

    // Bootstrap modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const chartModal = document.getElementById('chartFullscreenModal');
      
      // Clean up when modal is hidden
      chartModal.addEventListener('hidden.bs.modal', function () {
        closeFullscreenChart();
      });
    });
  </script>
</body>

</html>